<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Apollon â€” Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î¼Îµ Tabs (Local Storage) â€” Modal Forms</title>
<style>
  :root{--teal:#0c7a7a;--bg:#f3f7f7}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#122}
  header{background:var(--teal);color:#fff;padding:14px 18px;font-weight:700}
  .wrap{display:grid;grid-template-columns:1.1fr 1.4fr;gap:18px;padding:18px;max-width:1280px;margin:auto}
  .card{background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px}
  h2{margin:6px 0 10px 0;font-size:18px;color:#0c5757}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  input,select,textarea,button{font:inherit}
  input,select,textarea{width:100%;padding:10px;border:1px solid #cfd9d9;border-radius:8px;background:#fbffff}
  textarea{min-height:84px;resize:vertical}
  label{font-size:12px;color:#456}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .btn.primary{background:var(--teal);color:#fff}
  .btn.light{background:#e6f2f2}
  .btn.warn{background:#ffe8e8;color:#8a1111}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  thead th{font-size:12px;text-align:left;color:#567;border-bottom:1px solid #e2eeee;padding:8px}
  tbody td{padding:8px;border-bottom:1px dashed #eef4f4;font-size:14px}
  tr:hover{background:#f6fbfb}
  .muted{color:#6b8181;font-size:12px}
  .split{display:flex;gap:10px;align-items:center}
  .grow{flex:1}
  input[type="file"]{display:none}
  .file-label{padding:10px 14px;background:#e6f2f2;border-radius:8px;cursor:pointer;display:inline-block}
  /* Tabs */
  .tabs{display:flex;border-bottom:2px solid #e2eeee;margin-bottom:10px}
  .tab-btn{padding:10px 14px;background:#f5fafa;border:none;cursor:pointer;font-weight:600;color:#345;border-radius:10px 10px 0 0;margin-right:6px}
  .tab-btn.active{background:#0c7a7a;color:#fff}
  .tab-btn:disabled{opacity:.4}
  .tab-pane{display:none}
  .tab-pane.active{display:block}
  .kpi{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px}
  .kpi > div{background:#eef7f7;border-radius:10px;padding:8px 12px;font-size:13px;color:#234}
  #yearFilter{width:180px;flex:0 0 auto}
  /* Î•Î½ÏŒÏ„Î·Ï„ÎµÏ‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î± tabs */
  .section{margin:14px 0 18px;padding:12px;background:#fafdfd;border:1px solid #e6efef;border-radius:12px}
  .section-header{display:flex;align-items:center;gap:10px;justify-content:space-between;position:sticky;top:0;background:#fafdfd;padding-bottom:6px;border-bottom:1px solid #e8f2f2;z-index:1}
  .section-title{margin:0;font-size:16px;color:#0c5757}
  .section-meta{font-size:12px;color:#6b8181}
  .section-body{padding-top:8px}
  .scroll-area{max-height:260px;overflow:auto;border:1px dashed #eef4f4;border-radius:10px;background:#fff;padding:6px}
  .section .actions{margin-top:10px}
th.sel, td.sel { width: 36px; text-align: center; }
.enrSelect { cursor: pointer; }
/* "Ï‡ÎµÏÎ¬ÎºÎ¹" ÏƒÎµ ÏŒÎ»Î· Ï„Î· Î³ÏÎ±Î¼Î¼Î® */
#enrTbl tbody tr,
#payTbl tbody tr {
  cursor: pointer;
}

.inline-check {
  display: flex;
  align-items: center;   /* ÎºÎ¬Î¸ÎµÏ„Î· ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ· ÏƒÏ„Î· Î¼Î­ÏƒÎ· */
  gap: 8px;              /* ÎºÎµÎ½ÏŒ Î±Î½Î¬Î¼ÎµÏƒÎ± ÏƒÎµ checkbox ÎºÎ±Î¹ label */
}
.inline-check input[type="checkbox"] {
  width: 16px;
  height: 16px;
}

/* Ï‡ÎµÏÎ¬ÎºÎ¹ ÏƒÎµ ÏŒÎ»Î¿ Ï„Î¿ ÎºÎµÎ»Î¯ ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ ÎºÎ±Î¹ ÏƒÏ„Î± Ï€Î±Î¹Î´Î¹Î¬ Ï„Î¿Ï… (radio Îº.Î»Ï€.) */
#payTbl td.sel, #payTbl td.sel *,
#enrTbl td.sel, #enrTbl td.sel * {
  cursor: pointer;
}

/* Hand cursor ÏƒÎµ ÏŒÎ»Î· Ï„Î· Î³ÏÎ±Î¼Î¼Î® (Î±Î½ Î´ÎµÎ½ Ï„Î¿ Î­Ï‡ÎµÎ¹Ï‚ Î®Î´Î·) */
#tbl tbody tr,
#enrTbl tbody tr,
#payTbl tbody tr {
  cursor: pointer;
}

/* Hover (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ, Î±Ï€Î±Î»ÏŒ) */
#tbl tbody tr:hover,
#enrTbl tbody tr:hover,
#payTbl tbody tr:hover {
  background: #f3fbfb;
}

/* Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î³ÏÎ±Î¼Î¼Î® (active) â€” Ï€Î¹Î¿ Î­Î½Ï„Î¿Î½Î¿ Î±Ï€ÏŒ Ï„Î¿ hover */
#tbl tbody tr.active {
  background-color: #e8f6f6;   /* Î±Î½Î¿Î¹Ï‡Ï„ÏŒ Î³Î±Î»Î¬Î¶Î¹Î¿ Î³Î¹Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ */
}
#enrTbl tbody tr.active,
#payTbl tbody tr.active {
  background: #e8f6f6;
}

/* Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬: ÎµÎ»Î±Ï†ÏÏÏ‚ Ï„ÏŒÎ½Î¿Ï‚ ÎºÎ±Î¹ ÏƒÏ„Î¿ separator Ï„Î·Ï‚ active */

#tbl tbody tr.active td {
  border-bottom-color: #cfe9e9; /* Î»Î¯Î³Î¿ Ï€Î¹Î¿ ÏƒÎºÎ¿ÏÏÎ¿ separator */
}
#enrTbl tbody tr.active td,
#payTbl tbody tr.active td {
  border-bottom-color: #cfe9e9;
}

/* Active row (Î±Î½ Î´ÎµÎ½ Ï„Î¿ Î­Ï‡ÎµÎ¹Ï‚) */
#chgTbl tbody tr { cursor: pointer; }
#chgTbl tbody tr.active { background: #e8f6f6; }

/* ÎœÎ¹ÎºÏÎ¬ badges ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ */
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eef7f7;color:#234}
.badge.paid{background:#e8fbe8;color:#295b29}
.badge.partial{background:#fff4d6;color:#7a5a00}
.badge.open{background:#ffe8e8;color:#8a1111}
.badge.locked{box-shadow: inset 0 0 0 1px #b6c; }
.badge.adjust { background:#e9e8ff; color:#37307a }
.badge.credit { background:#e8fbe8; color:#295b29 } /* Ï€Î¯ÏƒÏ„Ï‰ÏƒÎ· (-) */


  /* === Modal === */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;padding:18px}
  .modal.open{display:block}
  .modal-card{background:#fff;border-radius:14px;max-width:720px;margin:auto;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  .modal-header{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px}
  .modal-title{margin:0;color:#0c5757;font-size:18px}
  .modal-close{border:0;background:#f2f6f6;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}

  @media (max-width: 920px){ .wrap{grid-template-columns:1fr} }

.alloc-panel { margin-top:12px; border:1px solid #e2e8f0; border-radius:10px; }
.alloc-header, .alloc-footer { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:#f7fafc; border-bottom:1px solid #e2e8f0; }
.alloc-footer { border-top:1px solid #e2e8f0; border-bottom:0; }
.alloc-body { max-height:230px; overflow:auto; }
.alloc-table { width:100%; border-collapse:collapse; }
.alloc-table th, .alloc-table td { padding:8px; border-bottom:1px solid #edf2f7; font-size:14px; }
.alloc-table td .money { white-space:nowrap; }
.alloc-table input[type="number"] { width:110px; }

/* Sidebar + Hamburger */
.app-header{display:flex;align-items:center;gap:10px}
.hamburger{appearance:none;border:none;background:transparent;font-size:22px;line-height:1;color:#fff;cursor:pointer;padding:4px 8px;border-radius:8px}
.hamburger:focus{outline:2px solid rgba(255,255,255,.5);outline-offset:2px}
.brand{font-weight:800}
.header-sub{opacity:.8;font-weight:600;margin-left:6px}

.sidebar{position:fixed;inset:0 auto 0 0;width:270px;background:#0b5d5d;color:#f2ffff;transform:translateX(-100%);transition:transform .25s ease;z-index:1000;box-shadow:2px 0 20px rgba(0,0,0,.2)}
.sidebar.open{transform:translateX(0)}
.sidebar .side-top{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.15)}
.sidebar .title{font-size:16px;font-weight:800}
.sidebar .close{appearance:none;border:none;background:transparent;color:#eaffff;font-size:22px;cursor:pointer}

.menu{list-style:none;margin:0;padding:8px}
.menu li a{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:10px;color:#eaffff;text-decoration:none}
.menu li a:hover{background:rgba(255,255,255,.08)}
.menu small{opacity:.8}

.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);backdrop-filter:saturate(80%) blur(1px);z-index:900;opacity:0;pointer-events:none;transition:opacity .2s ease}
.backdrop.show{opacity:1;pointer-events:auto}

@media (max-width:720px){
  header{padding:12px 14px}
}


/* Header layout: left (hamburger+brand) â€” right (user box) */
.app-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
.header-left{display:flex;align-items:center;gap:10px}
.header-right{display:flex;align-items:center;gap:10px}

/* Login overlay */
#loginScreen{position:fixed;inset:0;background:linear-gradient(135deg,#0b5d5d 0%, #0b4b5d 100%);display:none;align-items:center;justify-content:center;z-index:2000}
#loginScreen.show{display:flex}
.login-card{width:min(92vw,420px);background:#ffffff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.2);padding:20px}
.login-card h2{margin:0 0 8px 0}
.login-card p.sub{margin:0 0 16px 0;color:#444;opacity:.8}
.login-form{display:grid;grid-template-columns:1fr;gap:10px}
.login-form label{font-size:12px;font-weight:700;color:#0b4b5d}
.login-form input{border:1px solid #cfd8dc;border-radius:10px;padding:10px 12px;font-size:14px}
.login-actions{display:flex;align-items:center;justify-content:space-between;margin-top:6px}
.login-actions .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700}
.btn-primary{background:#0b5d5d;color:#eaffff}
.btn-ghost{background:transparent;color:#0b5d5d}
.login-hint{margin-top:8px;font-size:12px;color:#555}
.login-error{margin-top:8px;color:#b00020;font-size:13px;display:none}
.login-error.show{display:block}

/* User box + power button */
.userbox{display:flex;align-items:center;gap:8px;color:#eaffff}
.userbox .username{font-weight:700;opacity:.95}

#massAllocAutoBtn,
#massAllocClearBtn {
  display: none !important;
}


/* POWER BUTTON â€” CSS icon, Ï‡Ï‰ÏÎ¯Ï‚ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ <button> */
.power-btn{
  appearance:none;
  border:none;
  background:transparent;
  cursor:pointer;
  border-radius:50%;
  width:28px;
  height:28px;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
}
.power-btn:hover{background:rgba(255,255,255,.1)}
.power-btn:focus{outline:2px solid rgba(255,255,255,.5);outline-offset:2px}

/* ÎšÏÎºÎ»Î¿Ï‚ */
.power-btn::before{
  content:"";
  position:absolute;
  width:16px;
  height:16px;
  border:2px solid #eaffff;
  border-radius:50%;
  box-sizing:border-box;
}

/* ÎšÎ¬Î¸ÎµÏ„Î· Î³ÏÎ±Î¼Î¼Î® */
.power-btn::after{
  content:"";
  position:absolute;
  width:2px;
  height:8px;
  background:#eaffff;
  top:5px;                 /* Ï€Î¬Î½Ï‰ ÏƒÏ„Î¿ ÎºÎ­Î½Ï„ÏÎ¿ */
  left:50%;
  transform:translateX(-50%);
}

#resetBtn,
#enrClearBtn {
  display: none !important;
}

/* ===== Receipt (ÎœÎ— Ï†Î¿ÏÎ¿Î»Î¿Î³Î¹ÎºÏŒ) ===== */
.receipt { font: 12pt/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#111; width: 100%; max-width: 720px; margin: 0 auto; }
.receipt .r-head { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; border-bottom:1px solid #eee; padding-bottom:8px; }
.receipt .r-title { font-size:16pt; margin:0; }
.receipt .r-sub { color:#666; font-size:10pt; margin-top:2px; }
.receipt .r-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; margin:10px 0; }
.receipt .r-grid div { font-size:11pt; }
.receipt table { width:100%; border-collapse:collapse; margin:10px 0; }
.receipt th, .receipt td { border-bottom:1px solid #eee; padding:6px 4px; font-size:11pt; text-align:left; }
.receipt tfoot td { border-top:2px solid #111; font-weight:700; }
.receipt .muted { color:#666; font-size:10pt; }
.receipt .r-foot { margin-top:10px; display:flex; justify-content:space-between; gap:10px; font-size:10pt; color:#444; }

/* Thermal 80mm (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ) â€” Î±Î½ Î¸ÎµÏ‚ Î¸ÎµÏÎ¼Î¹ÎºÏŒ ÎµÎºÏ„Ï…Ï€Ï‰Ï„Î® */
.receipt.thermal { width: 76mm; max-width: 76mm; }
.receipt.thermal .r-head { border-bottom:1px dashed #ccc; }
.receipt.thermal th, .receipt.thermal td { border-bottom:1px dashed #eee; }

/* Print rules */
@media print {
  .no-print, header, .wrap, .modal { display:none !important; }
  #reportArea { display:block; }
  @page { size: A5 portrait; margin: 10mm; } /* Î¬Î»Î»Î±Î¾Îµ ÏƒÎµ size: 80mm auto; Î³Î¹Î± thermal */
}

/* Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬: ÎºÏŒÎºÎºÎ¹Î½Î¿ ÏƒÏ„Î¿ hover Î³Î¹Î± â€œÎ­Î¾Î¿Î´Î¿â€ */
.power-btn:hover::before{ border-color:#ff5252; }
.power-btn:hover::after{ background:#ff5252; }

.alloc-table .row-discount { background: rgba(255,0,0,0.03); }
.alloc-table .row-discount .neg { font-weight: 600; }
.alloc-table .muted { color:#666; font-style: italic; }

#chargesSection { display:none; }
</style>
</head>
<body>
<header class="app-header">
  <div class="header-left">
    <button id="menuBtn" class="hamburger" aria-label="Î†Î½Î¿Î¹Î³Î¼Î± Î¼ÎµÎ½Î¿Ï" title="ÎœÎµÎ½Î¿Ï">â˜°</button>
    <span class="brand">Apollon</span>
    <span class="header-sub">â€” Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î­Ï‚ â€¢ Î•Î³Î³ÏÎ±Ï†Î­Ï‚ â€¢ Î Î»Î·ÏÏ‰Î¼Î­Ï‚</span>
  </div>
  <div class="header-right">
    <div class="userbox">
      <span class="username" id="userName">â€”</span>
        <button id="logoutBtn" class="power-btn" title="Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·" aria-label="Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·"></button>

    </div>
  </div>
</header>

<div id="loginScreen" aria-hidden="true">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <h2 id="loginTitle" style="text-align:center;">Apollon</h2>
    <p class="sub">Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î³Î¹Î± Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„Î¿ Apollon.</p>
    <form id="loginForm" class="login-form">
      <div>
        <label for="lgUser">ÎŒÎ½Î¿Î¼Î± Ï‡ÏÎ®ÏƒÏ„Î·</label>
        <input id="lgUser" name="username" type="text" autocomplete="username" required placeholder="Ï€.Ï‡. admin">
      </div>
      <div>
        <label for="lgPass">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚</label>
        <input id="lgPass" name="password" type="password" autocomplete="current-password" required placeholder="Ï€.Ï‡. 1234">
      </div>
      <div class="login-actions">
        <button type="submit" class="btn btn-primary">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
        <button type="button" id="resetDefaultBtn" class="btn btn-ghost" title="Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯/ÎµÏ€Î±Î½Î±Ï†Î­ÏÎµÎ¹ Ï„Î¿Î½ admin Ï‡ÏÎ®ÏƒÏ„Î·">Reset admin</button>
      </div>
      <div class="login-error" id="loginErr">Î›Î¬Î¸Î¿Ï‚ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.</div>
      <div class="login-hint">Î ÏÎ¿ÎºÎ±Î¸Î¿ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬: <strong>admin / 1234</strong></div>
    </form>
  </div>
</div>

<aside id="sidebar" class="sidebar" aria-hidden="true">
  <div class="side-top">
    <div class="title">Apollon â€” ÎœÎµÎ½Î¿Ï</div>
    <button class="close" id="sideClose" aria-label="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿">Ã—</button>
  </div>
  <ul class="menu">
    <li><a href="#" class="menu-link" data-tab="tab-student">ğŸ‘¤ <span>Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</span></a></li>
    <li><a href="#" class="menu-link" data-tab="tab-enrollments">ğŸ“ <span>Î•Î³Î³ÏÎ±Ï†Î­Ï‚</span></a></li>
    <li><a href="#" class="menu-link" data-tab="tab-payments">ğŸ’³ <span>Î Î»Î·ÏÏ‰Î¼Î­Ï‚</span></a></li>
    <li><a href="#" class="menu-link" data-action="backup">ğŸ—„ï¸ <span>Backup / Export <small>(JSON)</small></span></a></li>
    <li><a href="#" class="menu-link" data-action="restore">ğŸ“¥ <span>Restore / Import <small>(JSON)</small></span></a></li>
    <li><a href="#" class="menu-link" data-action="clear">ğŸ§¹ <span>ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½</span></a></li>
    <li><a href="catalogs.html" class="menu-link">ğŸ“š <span>Î›Î¯ÏƒÏ„ÎµÏ‚ (Î£Ï‡Î¿Î»Î­Ï‚/Î¤Î¬Î¾ÎµÎ¹Ï‚/ÎˆÏ„Î·)</span></a></li>
    <li><a href="#" class="menu-link" data-action="about">â„¹ï¸ <span>Î£Ï‡ÎµÏ„Î¹ÎºÎ¬</span></a></li>
  </ul>
</aside>
<div id="backdrop" class="backdrop"></div>

<div class="wrap">
  <!-- Î‘Î¡Î™Î£Î¤Î•Î¡Î‘: Î›Î™Î£Î¤Î‘ Î£Î ÎŸÎ¥Î”Î‘Î£Î¤Î©Î -->
  <section class="card">
    <div class="split">
      <h2 class="grow">Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î­Ï‚</h2>
      <span class="muted" id="count">0</span>
    </div>

    <div class="row">
      <input id="q" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÎµ ÏŒÎ½Î¿Î¼Î±, ÎµÏ€ÏÎ½Ï…Î¼Î¿, Ï„Î·Î»Î­Ï†Ï‰Î½Î¿ Î® emailâ€¦" />
    </div>

    <table id="tbl">
      <thead><tr>
        <th>Î•Ï€ÏÎ½Ï…Î¼Î¿</th><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î—Î¼/Î½Î¯Î± Î“Î­Î½Î½Î·ÏƒÎ·Ï‚</th><th>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</th><th>Email</th>
      </tr></thead>
      <tbody></tbody>
    </table>

    <div class="actions">
      <button class="btn light" id="newBtn">ÎÎ­Î± ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·</button>
      <button class="btn warn" id="delBtn" disabled>Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
      <span class="grow"></span>
      <button class="btn light" id="registryBtn" title="ÎœÎ±Î¸Î·Ï„Î¿Î»ÏŒÎ³Î¹Î¿">ÎœÎ±Î¸Î·Ï„Î¿Î»ÏŒÎ³Î¹Î¿</button>
      <button class="btn light" id="exportBtn">Backup (JSON)</button>
      <label for="importInp" class="file-label">Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬</label>
      <input type="file" id="importInp" accept="application/json" />
    </div>
  </section>

  <!-- Î”Î•ÎÎ™Î‘: ÎšÎ‘Î¡Î¤Î•Î›Î‘ Î£Î ÎŸÎ¥Î”Î‘Î£Î¤Î— Î¼Îµ TABS -->
  <section class="card">
    <div class="split">
      <h2 class="grow" id="studentHeading">ÎšÎ±Î½Î­Î½Î±Ï‚ ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚</h2>
      <select id="yearFilter" title="Î”Î¹Î´Î±ÎºÏ„Î¹ÎºÏŒ Î­Ï„Î¿Ï‚"></select>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-student">Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</button>
      <button class="tab-btn" data-tab="tab-enrollments" id="enrollmentsTabBtn" disabled>Î•Î³Î³ÏÎ±Ï†Î­Ï‚</button>
      <button class="tab-btn" data-tab="tab-payments" id="paymentsTabBtn" disabled>Î Î»Î·ÏÏ‰Î¼Î­Ï‚</button>
    </div>

    <div class="tab-content">
      <!-- TAB: Î£Î¤ÎŸÎ™Î§Î•Î™Î‘ -->
      <div id="tab-student" class="tab-pane active">
        <h2 id="formTitle">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®</h2>
        <form id="form" autocomplete="off">
          <input type="hidden" id="id" />
          <div class="grid-2">
            <div><label>Î•Ï€ÏÎ½Ï…Î¼Î¿*</label><input id="surname" required /></div>
            <div><label>ÎŒÎ½Î¿Î¼Î±*</label><input id="name" required /></div>
          </div>
          
          <div class="grid-3">
             <div><label>ÎŒÎ½Î¿Î¼Î± Î Î±Ï„Î­ÏÎ±</label><input id="fatherName" /></div>
             <div><label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î“Î­Î½Î½Î·ÏƒÎ·Ï‚</label><input id="dob" type="date" /></div>
             <div><label>Î¤ÏŒÏ€Î¿Ï‚ Î“Î­Î½Î½Î·ÏƒÎ·Ï‚</label><input id="birthPlace" /></div>
          </div>

          <div class="grid-2">
            <div><label>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</label><input id="phone" /></div>
            <div><label>Email</label><input id="email" type="email" /></div>
          </div>
          <div class="grid-3">
            <div><label>Î‘ÎœÎšÎ‘</label><input id="amka" /></div>
            <div><label>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</label><input id="address" /></div>
            <div><label>Î ÏŒÎ»Î·</label><input id="city" /></div>            
          </div>
          <div><label>Î£Ï‡ÏŒÎ»Î¹Î±</label><textarea id="notes"></textarea></div>
          <div class="actions">
            <button class="btn primary" type="submit">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
            <button class="btn light" type="button" id="resetBtn">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
            <span class="grow"></span>
<button class="btn light" id="pdfBtn" title="Î•Î¾Î±Î³Ï‰Î³Î® PDF" type="button">PDF Report</button>

          </div>
          <p class="muted">Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„ÏÎ½ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Ï„Î¿Ï€Î¹ÎºÎ¬.</p>
        </form>
      </div>

      <!-- TAB: Î•Î“Î“Î¡Î‘Î¦Î•Î£ -->
      <div id="tab-enrollments" class="tab-pane">
        <div class="section">
          <div class="section-header">
            <h3 class="section-title">Î•Î³Î³ÏÎ±Ï†Î­Ï‚</h3>
            <div class="section-meta">ÎˆÏ„Î¿Ï‚: <span id="enrYearEcho">â€”</span> â€¢ Î Î»Î®Î¸Î¿Ï‚: <span id="enrCount">0</span></div>
          </div>
          <div class="section-body">
            <div class="scroll-area">
              <table id="enrTbl" style="margin:0;">
<thead>
  <tr>
    <th class="sel"></th>
    <th>ÎˆÏ„Î¿Ï‚</th><th>Î£Ï‡Î¿Î»Î®</th><th>Î¤Î¬Î¾Î·</th><th>Î”Î¹Î´Î¬ÏƒÎºÏ‰Î½</th><th>Î—Î¼/Î½Î¯Î± Î•Î³Î³ÏÎ±Ï†Î®Ï‚</th><th></th>
  </tr>
</thead>

                <tbody></tbody>
              </table>
            </div>
            <div class="actions">
              <button class="btn light" id="enrNewBtn" disabled>ÎÎ­Î± Î•Î³Î³ÏÎ±Ï†Î®</button>
              <button class="btn warn" id="enrDelBtn" disabled>Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
              <button class="btn light" id="enrPlanBtn" disabled>Î Î»Î¬Î½Î¿</button> <!-- ÎÎ•ÎŸ -->
              <button class="btn light" id="enrExamBtn" disabled>Î•Î¾ÎµÏ„Î¬ÏƒÎµÎ¹Ï‚</button>
            </div>
          </div>
        </div>
<!-- Î§ÏÎµÏÏƒÎµÎ¹Ï‚ Î Î»Î¬Î½Î¿Ï… (Î±Î½Î¬ Î•Î³Î³ÏÎ±Ï†Î®) -->
<div class="section" id="chargesSection" style="display:none;">
  <div class="section-header">
    <h3 class="section-title">Î§ÏÎµÏÏƒÎµÎ¹Ï‚ Î Î»Î¬Î½Î¿Ï…</h3>
    <div class="section-meta">
      Î Î»Î®Î¸Î¿Ï‚: <span id="chgCount">0</span> â€¢ ÎŸÏ†ÎµÎ¹Î»ÏŒÎ¼ÎµÎ½Î¿: <span id="chgDue">0â‚¬</span>
    </div>
  </div>
  <div class="section-body">
    <div class="scroll-area">
      <table id="chgTbl" style="margin:0;">
        <thead>
          <tr>
            <th>ÎœÎ®Î½Î±Ï‚</th><th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th><th>Î¤ÏÏ€Î¿Ï‚</th><th>Î›Î®Î¾Î·</th><th>Î Î¿ÏƒÏŒ</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="actions">
      <button class="btn light" id="chgRefreshBtn">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
      <button class="btn light" id="chgLockBtn" disabled>ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î±</button>
      <button class="btn light" id="chgUnlockBtn" disabled>ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î±</button>
      <button class="btn light" id="chgAdjBtn" disabled>Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Adjustment</button>
    </div>
  </div>
</div>
      </div>

      <!-- TAB: Î Î›Î—Î¡Î©ÎœÎ•Î£ -->
      <div id="tab-payments" class="tab-pane">
        <div class="section">
          <div class="section-header">
            <h3 class="section-title">Î Î»Î·ÏÏ‰Î¼Î­Ï‚ (Î”Î¯Î´Î±ÎºÏ„ÏÎ±)</h3>
            <div class="section-meta">ÎˆÏ„Î¿Ï‚: <span id="payYearEcho">â€”</span></div>
          </div>
          <div class="section-body">
            <div class="kpi" style="margin-top:0;">
              <div>Î£ÏÎ½Î¿Î»Î¿: <b id="sumTotal">0â‚¬</b></div>
              <div>Î Î»Î·ÏÏ‰Î¼Î­Ï‚: <b id="sumCount">0</b></div>
              <div>Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±: <b id="sumLast">â€”</b></div>
            </div>
            <div class="scroll-area" style="margin-top:8px;">
              <table id="payTbl" style="margin:0;">
<thead><tr>
  <th class="sel"></th>
  <th>Î—Î¼/Î½Î¯Î±</th><th>ÎœÎ®Î½Î±Ï‚</th><th>Î Î¿ÏƒÏŒ</th><th>Î¤ÏÏŒÏ€Î¿Ï‚</th><th></th>
</tr></thead>
                <tbody></tbody>
              </table>
            </div>
<div class="actions">
<button class="btn light" id="payNewBtn" disabled style="display:none;">ÎÎ­Î± Î Î»Î·ÏÏ‰Î¼Î®</button>
<button class="btn light" id="payReceiptBtn" disabled title="Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· Î±Ï€ÏŒÎ´ÎµÎ¹Î¾Î·Ï‚">Î‘Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
  <button class="btn warn" id="payDelBtn" disabled>Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
  <span class="grow"></span>
  <button class="btn light" id="massPayBtn" disabled>ÎÎ­Î± Î Î»Î·ÏÏ‰Î¼Î®</button>
</div>

          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ========== MODALS ========== -->
<!-- Enrollment Modal -->
<div id="enrModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title" id="enrFormTitle">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î•Î³Î³ÏÎ±Ï†Î®Ï‚</h3>
      <button class="modal-close" id="enrClose">âœ•</button>
    </div>
    <form id="enrForm" autocomplete="off">
      <input type="hidden" id="enrId" />
      <div class="grid-3">
        <div><label>Î”Î¹Î´Î±ÎºÏ„Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚</label><select id="enrYear"></select></div>
  <div><label>Î£Ï‡Î¿Î»Î®</label><select id="enrSchool" required></select></div>
  <div><label>Î¤Î¬Î¾Î·</label><select id="enrClass" required></select></div>
      </div>
      <div class="grid-3">
        <div><label>ÎˆÏ„Î¿Ï‚ Î¦Î¿Î¯Ï„Î·ÏƒÎ·Ï‚</label><select id="enrGovYear" required></select></div>
        <div><label>Î•Î¾Î¬Î¼Î·Î½Î¿</label>
          <select id="enrSemester"><option value="">â€”</option><option>Î‘</option><option>Î’</option></select>
        </div>
        <div><label>Î—Î¼/Î½Î¯Î± Î•Î³Î³ÏÎ±Ï†Î®Ï‚</label><input id="enrDate" type="date" /></div>
      </div>
<div class="grid-2"> <div><label>Î”Î¹Î´Î¬ÏƒÎºÏ‰Î½</label><input id="enrTeacher" /></div> <div class="inline-check" style="align-items:end;"> <input id="enrGovReg" type="checkbox" /> <label for="enrGovReg">Î•Î³Î³ÏÎ±Ï†Î® ÏƒÏ„Î¿ Ï…Ï€Î¿Ï…ÏÎ³ÎµÎ¯Î¿</label> </div> </div>


      <div><label>Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚</label><textarea id="enrNotes"></textarea></div>
      <div class="actions">
        <button class="btn primary" type="submit" id="enrSaveBtn" disabled>Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button class="btn light" type="button" id="enrClearBtn">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>
    </form>
  </div>
</div>

<!-- Class Registry (ÎœÎ±Î¸Î·Ï„Î¿Î»ÏŒÎ³Î¹Î¿) Modal -->
<div id="registryModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title">ÎœÎ±Î¸Î·Ï„Î¿Î»ÏŒÎ³Î¹Î¿</h3>
      <button class="modal-close" id="registryClose">âœ•</button>
    </div>

    <form id="registryForm" autocomplete="off">
      <div class="grid-3">
        <!-- Î”Î¹Î´Î±ÎºÏ„Î¹ÎºÏŒ Î­Ï„Î¿Ï‚ -->
        <div>
          <label>Î”Î¹Î´Î±ÎºÏ„Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚</label>
          <select id="regYear" required></select>
        </div>

        <!-- Î•Î¾Î¬Î¼Î·Î½Î¿ (Î²Î¬ÏƒÎµÎ¹ Î—Î¼/Î½Î¯Î±Ï‚ Î•Î³Î³ÏÎ±Ï†Î®Ï‚) -->
        <div>
          <label>Î•Î¾Î¬Î¼Î·Î½Î¿ <small class="muted">(Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î·Î½ Î—Î¼/Î½Î¯Î± Î•Î³Î³ÏÎ±Ï†Î®Ï‚)</small></label>
          <select id="regSemester" required>
            <option value="A">Î‘</option>
            <option value="B">Î’</option>
          </select>
        </div>

        <!-- Î¥Ï€Î¿Ï…ÏÎ³ÎµÎ¯Î¿ -->
        <div>
          <label>Î•Î³Î³ÏÎ±Ï†Î® ÏƒÏ„Î¿ Î¥Ï€Î¿Ï…ÏÎ³ÎµÎ¯Î¿</label>
          <select id="regGov" required>
            <option value="both">ÎšÎ±Î¹ Ï„Î± Î´ÏÎ¿</option>
            <option value="yes">ÎÎ±Î¹</option>
            <option value="no">ÎŒÏ‡Î¹</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" type="submit" id="registryRunBtn">Î•Î¾Î±Î³Ï‰Î³Î® ÏƒÎµ Pdf</button>
        <button class="btn light" type="button" id="registryWordBtn">Î•Î¾Î±Î³Ï‰Î³Î® ÏƒÎµ Word</button>
        <button class="btn light" type="button" id="registryPreviewBtn">Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</button>
      </div>


    </form>
  </div>
</div>


<!-- Payment Modal -->
<div id="payModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title" id="payFormTitle">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î Î»Î·ÏÏ‰Î¼Î®Ï‚</h3>
      <button class="modal-close" id="payClose">âœ•</button>
    </div>
    <form id="payForm" autocomplete="off">
      <input type="hidden" id="payId" />
<!-- 1Î· ÏƒÎµÎ¹ÏÎ¬: Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± â€¢ Î Î¿ÏƒÏŒ â€¢ Î¤ÏÏŒÏ€Î¿Ï‚ -->
<div class="grid-3">
  <div>
    <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
    <input id="payDate" type="date" />
  </div>
  <div>
    <label>Î Î¿ÏƒÏŒ (â‚¬)</label>
    <input id="payAmount" type="number" step="0.01" min="0" required />
  </div>
  <div>
    <label>Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</label>
    <select id="payMethod">
      <option>ÎœÎµÏ„ÏÎ·Ï„Î¬</option><option>ÎšÎ¬ÏÏ„Î±</option><option>Î¤ÏÎ¬Ï€ÎµÎ¶Î±</option><option>POS</option><option>Î†Î»Î»Î¿</option>
    </select>
  </div>
</div>

<!-- 2Î· ÏƒÎµÎ¹ÏÎ¬: Î‘Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± â€¢ Batch ID -->
<div class="grid-2">
  <div>
    <label>Î‘Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î±</label>
    <input id="payReason" placeholder="Î”Î¯Î´Î±ÎºÏ„ÏÎ± / Î•Î³Î³ÏÎ±Ï†Î® / Î•Î¾Î­Ï„Î±ÏƒÎ·â€¦" />
  </div>
  <div>
    <label>Batch ID</label>
    <input id="payBatchId" type="text" disabled placeholder="â€”">
  </div>
</div>

<!-- ===== Allocations (ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Ï€Î¿ÏƒÎ¿Ï ÏƒÎµ Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚) ===== -->
<div id="allocPanel" class="alloc-panel">
  <div class="alloc-header">
    <div><b>ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</b></div>
    <div class="alloc-tools">
      <button class="btn light" type="button" id="allocAutoBtn">Auto-FIFO</button>
      <button class="btn light" type="button" id="allocClearBtn">ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚</button>
    </div>
  </div>
  <div class="alloc-body">
    <table class="alloc-table">
      <thead>
        <tr>
          <th>ÎœÎ®Î½Î±Ï‚</th>
          <th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
          <th>Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿</th>
          <th>ÎšÎ¬Î»Ï…ÏˆÎ·</th>
        </tr>
      </thead>
      <tbody id="allocTbody"><tr><td colspan="5" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚.</td></tr></tbody>
    </table>
  </div>
  <div class="alloc-footer">
    <div>Î£ÏÎ½Î¿Î»Î¿ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚: <b id="allocPayAmount">0.00â‚¬</b></div>
    <div>ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·: <b id="allocSum">0.00â‚¬</b></div>
    <div>Î Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚: <b id="allocRest">0.00â‚¬</b></div>
  </div>
</div>

<!-- ===== Read-only Allocations for Batch Payment ===== -->
<div id="allocRoPanel" class="alloc-panel" style="display:none;">
  <div class="alloc-header">
    <div><b>Î§ÏÎµÏÏƒÎµÎ¹Ï‚ Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</b></div>
    <div id="allocRoMeta" class="muted">Batch: â€”</div>
  </div>
  <div class="alloc-body">
    <table class="alloc-table">
      <thead>
        <tr>
          <th>ÎœÎ®Î½Î±Ï‚</th>
          <th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
          <th>Î›Î®Î¾Î·</th>
          <th>Î Î¿ÏƒÏŒ Î§ÏÎ­Ï‰ÏƒÎ·Ï‚</th>
          <th>ÎšÎ±Î»ÏÏ†Î¸Î·ÎºÎµ</th>
          <th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
        </tr>
      </thead>
      <tbody id="allocRoTbody">
        <tr><td colspan="6" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î®.</td></tr>
      </tbody>
    </table>
  </div>
<div class="alloc-footer">
  <div>Î£ÏÎ½Î¿Î»Î¿ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚: <b id="allocRoSum">0.00â‚¬</b></div>
  <div>ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·: <b id="allocRoDisc">0.00â‚¬</b></div>
  <div>Î¤ÎµÎ»Î¹ÎºÏŒ Ï€Î¿ÏƒÏŒ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚: <b id="allocRoFinal">0.00â‚¬</b></div>
</div>

</div>

      <div class="actions">
        <button class="btn primary" type="submit" id="paySaveBtn" disabled>Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button class="btn light" type="button" id="payClearBtn">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>
    </form>
  </div>
</div>

<!-- Mass Payment Modal (Î£Ï„ÏÏÏƒÎ· Î’) -->
<div id="massPayModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title">ÎœÎ±Î¶Î¹ÎºÎ® Î Î»Î·ÏÏ‰Î¼Î® (Î±Î½Î¬ Î¼Î±Î¸Î·Ï„Î®)</h3>
      <button class="modal-close" id="massPayClose">âœ•</button>
    </div>
    <form id="massPayForm" autocomplete="off">
      <div class="grid-3">
        <div>
          <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
          <input id="massPayDate" type="date" />
        </div>
        <div>
          <label>Î Î¿ÏƒÏŒ (â‚¬)</label>
          <input id="massPayAmount" type="number" step="0.01" min="0" required />
        </div>
        <div>
          <label>Î¤ÏÏŒÏ€Î¿Ï‚</label>
          <select id="massPayMethod">
            <option>ÎœÎµÏ„ÏÎ·Ï„Î¬</option><option>ÎšÎ¬ÏÏ„Î±</option><option>Î¤ÏÎ¬Ï€ÎµÎ¶Î±</option><option>POS</option><option>Î†Î»Î»Î¿</option>
          </select>
        </div>
      </div>

<div class="grid-3">
  <div>
    <label>Î‘Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î±</label>
    <input id="massPayReason" placeholder="ÎœÎ±Î¶Î¹ÎºÎ® ÎµÎ¾ÏŒÏ†Î»Î·ÏƒÎ· Î´Î¹Î´Î¬ÎºÏ„ÏÏ‰Î½" />
  </div>
  <div>
    <label>ÎœÎ®Î½Î±Ï‚</label>
    <select id="massMonth"></select>
  </div>
  <div>
    <label>ÎˆÎºÏ€Ï„Ï‰ÏƒÎ· (â‚¬)</label>
    <input id="massDiscountInput" type="number" step="0.01" min="0" />
  </div> <!-- ÎºÎµÎ½ÏŒ Î³Î¹Î± Î½Î± ÎºÏÎ±Ï„Î®ÏƒÎµÎ¹ Ï„Î¿ grid ÎµÏ…Î¸Ï…Î³ÏÎ±Î¼Î¼Î¹ÏƒÎ¼Î­Î½Î¿ -->
</div>

      <div class="alloc-panel">
        <div class="alloc-header">
          <div><b>ÎšÎ±Ï„Î±Î½Î¿Î¼Î® (ÏŒÎ»ÎµÏ‚ Î¿Î¹ Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î¼Î±Î¸Î·Ï„Î®)</b></div>
          <div class="alloc-tools">
            <button class="btn light" type="button" id="massAllocAutoBtn">Auto-FIFO</button>
            <button class="btn light" type="button" id="massAllocClearBtn">ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚</button>
          </div>
        </div>
        <div class="alloc-body">
          <table class="alloc-table">
            <thead>
              <tr><th> </th><th>ÎœÎ®Î½Î±Ï‚</th><th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th><th>Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿</th><th>ÎšÎ¬Î»Ï…ÏˆÎ·</th></tr>
            </thead>
            <tbody id="massAllocTbody">
              <tr><td colspan="5" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚.</td></tr>
            </tbody>
          </table>
<!-- Template Ï…Ï€Î¿-Î³ÏÎ±Î¼Î¼Î®Ï‚ "ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·" Î³Î¹Î± ÎºÎ¬Î¸Îµ Ï‡ÏÎ­Ï‰ÏƒÎ· -->
<template id="massDiscountRow">
  <tr class="row-discount">
    <td></td>
    <td class="muted">â†³ ÎˆÎºÏ€Ï„Ï‰ÏƒÎ· <span class="disc-note"></span></td>
    <td></td>
    <td class="money neg"><span class="disc-amount">-0.00â‚¬</span></td>
    <td></td>
  </tr>
</template>

        </div>
        <div class="alloc-footer">
          <div>Î£ÏÎ½Î¿Î»Î¿ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚: <b id="massAllocSum">0.00â‚¬</b></div>
          <div>ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·: <b id="massAllocRest">0.00â‚¬</b></div>
          <div>Î Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚: <b id="massAllocPayAmount">0.00â‚¬</b></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" type="submit" id="massPaySaveBtn" disabled>ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· ÎœÎ±Î¶Î¹ÎºÎ®Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</button>
      </div>
    </form>
  </div>
</div>

<!-- Plan Modal -->
<div id="planModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title">Î Î»Î¬Î½Î¿ Î”Î¹Î´Î¬ÎºÏ„ÏÏ‰Î½</h3>
      <button class="modal-close" id="planClose">âœ•</button>
    </div>
    <form id="planForm" autocomplete="off">
      <input type="hidden" id="planId" />
      <div class="grid-3">
        <div><label>ÎœÎ·Î½Î¹Î±Î¯Î¿ Î Î¿ÏƒÏŒ (â‚¬)</label><input id="planMonthly" type="number" step="0.01" min="0" required></div>
        <div><label>ÎˆÎ½Î±ÏÎ¾Î·</label><input id="planStartYm" type="month" required></div>
        <div><label>Î”Î¹Î¬ÏÎºÎµÎ¹Î± (Î¼Î®Î½ÎµÏ‚)</label><input id="planMonths" type="number" min="1" max="24" required></div>
      </div>
      <div class="grid-3">
        <div><label>Î¤Î­Î»Î¿Ï‚ Î•Î³Î³ÏÎ±Ï†Î®Ï‚ (â‚¬)</label><input id="planRegFee" type="number" step="0.01" min="0"></div>
        <div><label>ÎœÏŒÎ½Î¿ Î¼ÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÎ¬</label><input id="planFutureOnly" type="checkbox" checked></div>
        <div><label>Î—Î¼Î­ÏÎ± Î»Î®Î¾Î·Ï‚ (due)</label><input id="planDueDay" type="number" min="1" max="28" value="10"></div>
      </div>
      <div><label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label><textarea id="planNotes" placeholder="Ï€.Ï‡. Î¥Ï€Î¿Ï„ÏÎ¿Ï†Î¯Î± 10%"></textarea></div>
      <div class="actions">
        <button class="btn primary" type="submit" id="planSaveBtn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· & Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
      </div>
<!-- === Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î Î»Î¬Î½Î¿Ï… (Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ Î¯Î´Î¹Î¿ modal) === -->
<div id="planPreviewWrap" class="section" style="margin-top:14px;">
  <div class="section-header">
    <h3 class="section-title">Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î Î»Î¬Î½Î¿Ï…</h3>
    <div class="section-meta">ÎœÎ®Î½ÎµÏ‚: <span id="planPrevCount">0</span> â€¢ Î£ÏÎ½Î¿Î»Î¿: <span id="planPrevSum">0.00â‚¬</span></div>
  </div>
  <div class="section-body">
    <div class="scroll-area">
      <table class="alloc-table" style="margin:0;">
        <thead>
          <tr>
            <th>#</th>
            <th>ÎœÎ®Î½Î±Ï‚</th>
            <th>Î›Î®Î¾Î·</th>
            <th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
            <th>Î Î¿ÏƒÏŒ</th>
            <th>Î¤ÏÏ€Î¿Ï‚</th>
          </tr>
        </thead>
        <tbody id="planPreviewTbody">
          <tr><td colspan="6" class="muted">Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÎµÏ€Î¬Î½Ï‰ Î³Î¹Î± Î½Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ Î· Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- === Î ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ­Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎµÎ³Î³ÏÎ±Ï†Î®/Î­Ï„Î¿Ï‚ === -->
<div id="planRealWrap" class="section" style="margin-top:14px;">
  <div class="section-header">
    <h3 class="section-title">Î§ÏÎµÏÏƒÎµÎ¹Ï‚ Î Î»Î¬Î½Î¿Ï… (Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ­Ï‚)</h3>
    <div class="section-meta">
      Î Î»Î®Î¸Î¿Ï‚: <span id="planRealCount">0</span> â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <span id="planRealDue">0.00â‚¬</span>
    </div>
  </div>
  <div class="section-body">
    <div class="scroll-area">
      <table class="alloc-table" style="margin:0;">
        <thead>
          <tr>
            <th>ÎœÎ®Î½Î±Ï‚</th>
            <th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
            <th>Î›Î®Î¾Î·</th>
            <th>Î Î¿ÏƒÏŒ</th>
            <th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
            <th></th> <!-- ÎºÎ¿Ï…Î²Î±Î´Î¬ÎºÎ¹ -->
          </tr>
        </thead>
        <tbody id="planRealTbody">
          <tr><td colspan="6" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎµÎ³Î³ÏÎ±Ï†Î®.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

    </form>
  </div>
</div>

<!-- Exam Modal -->
<div id="examModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title">Î•Î¾Î­Ï„Î±ÏƒÎ·</h3>
      <button class="modal-close" id="examClose">âœ•</button>
    </div>
    <form id="examForm" autocomplete="off">
      <input type="hidden" id="examId" />
      <div class="grid-3">
        <div>
          <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
          <input id="examDate" type="date" />
        </div>
        <div>
          <label>ÎœÎ¬Î¸Î·Î¼Î±/Î•Î½ÏŒÏ„Î·Ï„Î±</label>
          <input id="examSubject" placeholder="Ï€.Ï‡. Î¤ÎµÎ»Î¹ÎºÎ® ÎµÎ¾Î­Ï„Î±ÏƒÎ· Î’Î„" />
        </div>
        <div>
          <label>Î¤ÏÏ€Î¿Ï‚</label>
          <select id="examType">
            <option value="final">Î¤ÎµÎ»Î¹ÎºÎ®</option>
            <option value="resit">Î•Ï€Î±Î½ÎµÎ¾Î­Ï„Î±ÏƒÎ·</option>
            <option value="cert">Î Î¹ÏƒÏ„Î¿Ï€Î¿Î¯Î·ÏƒÎ·</option>
          </select>
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Î¤Î­Î»Î¿Ï‚ ÎµÎ¾Î­Ï„Î±ÏƒÎ·Ï‚ (â‚¬)</label>
          <input id="examFee" type="number" step="0.01" min="0" />
        </div>
        <div>
          <label>Î‘Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±</label>
          <select id="examResult">
            <option value="">â€”</option>
            <option value="pass">Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±</option>
            <option value="fail">Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î±</option>
            <option value="grade">Î’Î±Î¸Î¼ÏŒÏ‚</option>
          </select>
        </div>
        <div>
          <label>Î’Î±Î¸Î¼ÏŒÏ‚</label>
          <input id="examGrade" type="text" placeholder="Ï€.Ï‡. 85/100 Î® 18/20" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Î Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Ï„Î¹ÎºÏŒ #</label>
          <input id="examCert" placeholder="Ï€.Ï‡. CERT-2026-00012" />
        </div>
<div class="inline-check">
  <input id="examCreateCharge" type="checkbox" checked />
  <label for="examCreateCharge">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚ ÎµÎ¾Î­Ï„Î±ÏƒÎ·Ï‚</label>
</div>

      </div>

      <div>
        <label>Î£Ï‡ÏŒÎ»Î¹Î±</label>
        <textarea id="examNotes" placeholder="Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚â€¦"></textarea>
      </div>

      <div class="actions">
        <button class="btn primary" type="submit" id="examSaveBtn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      </div>
    </form>
  </div>
</div>

<!-- Adjustment Modal -->
<div id="adjModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title">Adjustment (ÎœÎ·Î½Î¹Î±Î¯Î± Ï€Î¯ÏƒÏ„Ï‰ÏƒÎ·/Ï‡ÏÎ­Ï‰ÏƒÎ·)</h3>
      <button class="modal-close" id="adjClose">âœ•</button>
    </div>
    <form id="adjForm" autocomplete="off">
      <div class="grid-3">
        <div>
          <label>Î•Î¯Î´Î¿Ï‚</label>
          <select id="adjKind">
            <option value="credit">Î Î¯ÏƒÏ„Ï‰ÏƒÎ· (-)</option>
            <option value="debit">Î§ÏÎ­Ï‰ÏƒÎ· (+)</option>
          </select>
        </div>
        <div>
          <label>Î Î¿ÏƒÏŒ</label>
          <input id="adjAmount" type="number" step="0.01" min="0" required>
        </div>
        <div>
          <label>ÎœÎ®Î½Î±Ï‚</label>
          <input id="adjYm" type="month" required>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Î›Î®Î¾Î·</label>
          <input id="adjDue" type="date">
        </div>
        <div>
          <label>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</label>
          <input id="adjDesc" placeholder="Î¥Ï€Î¿Ï„ÏÎ¿Ï†Î¯Î±, Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ·, Îº.Î»Ï€.">
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" type="submit">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Adjustment</button>
      </div>
    </form>
  </div>
</div>

<div id="reportArea" style="display:none"></div>
<style>
@media print {
  body { background:#fff }
  #reportArea { display:block; }
  .no-print, header, .wrap { display:none !important; }
  .report { font: 12pt/1.35 system-ui; color:#111; margin:0; }
  .report h1 { font-size:18pt; margin:0 0 8pt }
  .report h2 { font-size:13pt; margin:12pt 0 6pt; color:#0c5757 }
  .report table { width:100%; border-collapse:collapse; margin:6pt 0 }
  .report th, .report td { border-bottom:1px solid #eee; padding:6pt 4pt; font-size:10pt; text-align:left }
  .report .muted { color:#666 }
  .report .grid { display:grid; grid-template-columns:1fr 1fr; gap:8pt }
  .report .meta { font-size:9pt; color:#666; margin-top:6pt }
    .modal,
  .modal-backdrop,
  .overlay { display:none !important; }

  .report table { page-break-inside:auto }
  .report tr    { page-break-inside:avoid; page-break-after:auto }
  .report h2    { page-break-after:avoid }
}
</style>


<script>
/* ======= Keys ======= */
const KEY_STUDENTS='apollon_students';
const KEY_ENROLLS='apollon_enrollments';
const KEY_PAYMENTS='apollon_payments';

/* ======= Helpers ======= */
const el=s=>document.querySelector(s);
const fmtDate = d => {
  if (!d) return '';
  const dt = new Date(d);
  const dd = String(dt.getDate()).padStart(2,'0');
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const yyyy = dt.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
};

const toISO=d=>d?new Date(d).toISOString().slice(0,10):'';
const uid=()=> 'ID'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);


/* ======= DB ======= */
const db={all(){return JSON.parse(localStorage.getItem(KEY_STUDENTS)||'[]')},
  save(v){localStorage.setItem(KEY_STUDENTS,JSON.stringify(v))},
  upsert(r){const a=db.all();const i=a.findIndex(x=>x.id===r.id); i>=0?a.splice(i,1,r):a.push(r); db.save(a)},
  remove(id){db.save(db.all().filter(x=>x.id!==id))}
};
const enrDB={all(){return JSON.parse(localStorage.getItem(KEY_ENROLLS)||'[]')},
  save(v){localStorage.setItem(KEY_ENROLLS,JSON.stringify(v))},
  upsert(r){const a=enrDB.all();const i=a.findIndex(x=>x.id===r.id); i>=0?a.splice(i,1,r):a.push(r); enrDB.save(a)},
  remove(id){enrDB.save(enrDB.all().filter(x=>x.id!==id))}
};
const payDB={all(){return JSON.parse(localStorage.getItem(KEY_PAYMENTS)||'[]')},
  save(v){localStorage.setItem(KEY_PAYMENTS,JSON.stringify(v))},
  upsert(r){const a=payDB.all();const i=a.findIndex(x=>x.id===r.id); i>=0?a.splice(i,1,r):a.push(r); payDB.save(a)},
  remove(id){payDB.save(payDB.all().filter(x=>x.id!==id))}
};

/* ======= Tuition Model: Plans / Charges / Allocations / Documents (Phase 1 scaffolding) ======= */
// Storage keys
const KEY_PLANS='apollon_plans';
const KEY_CHARGES='apollon_charges';
const KEY_ALLOC='apollon_allocations';
const KEY_DOCS='apollon_documents';
const KEY_CATALOGS = 'apollon_catalogs';

function catRead(){ try { return JSON.parse(localStorage.getItem(KEY_CATALOGS) || '{}'); } catch { return {}; } }
function catWrite(v){ localStorage.setItem(KEY_CATALOGS, JSON.stringify(v || {})); }

// ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Ï€Î±Î»Î¹ÏÎ½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ -> Î½Î­Î¿ ÏƒÏ‡Î®Î¼Î±
function migrateCatalogs(){
  const c = catRead();
  let changed = false;

  // Î¦ÏÏŒÎ½Ï„Î¹ÏƒÎµ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ c.schools
  if (!Array.isArray(c.schools)) { c.schools = []; changed = true; }

  // ÎŸÎ¼Î¿Î³ÎµÎ½Î¿Ï€Î¿Î¯Î·ÏƒÎ· schools
  c.schools = c.schools.map(s => {
    let name, classes;
    if (typeof s === 'string') { name = s; classes = []; changed = true; }
    else { name = s.name; classes = Array.isArray(s.classes) ? s.classes : []; }

    // ÎŸÎ¼Î¿Î³ÎµÎ½Î¿Ï€Î¿Î¯Î·ÏƒÎ· classes -> Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± Î¼Îµ years
    classes = classes.map(cl => {
      if (typeof cl === 'string') { changed = true; return { name: cl, years: Array.isArray(c.years) ? c.years : [] }; }
      if (!Array.isArray(cl.years)) { cl.years = Array.isArray(c.years) ? c.years : []; changed = true; }
      return cl;
    });

    return { name, classes };
  });

  // ÎšÎ±Ï„Î¬ÏÎ³Î·ÏƒÎ· global years (Î±Î½ Ï…Ï€Î®ÏÏ‡Î±Î½)
  if ('years' in c) { delete c.years; changed = true; }

  if (changed) catWrite(c);
}

function cleanupOrphans(){
  const enrIds  = new Set(enrDB.all().map(e => e.id));
  const payIds  = new Set(payDB.all().map(p => p.id));

  // 1) ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Î¿ÏÏ†Î±Î½Î¬ charges (ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ ÏŒÏƒÎ± ÎµÎ¯Î½Î±Î¹ Î³ÎµÎ½Î¹ÎºÎ¬: enrollmentId == null)
  const charges = chargeDB.all();
  const goodCharges = charges.filter(c => !c.enrollmentId || enrIds.has(c.enrollmentId));
  if (goodCharges.length !== charges.length) chargeDB.save(goodCharges);

  const chargeIds = new Set(goodCharges.map(c => c.id));

  // 2) ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Î¿ÏÏ†Î±Î½Î¬ allocations
  const allocs = allocDB.all();
  const goodAllocs = allocs.filter(a => payIds.has(a.paymentId) && chargeIds.has(a.chargeId));
  if (goodAllocs.length !== allocs.length) allocDB.save(goodAllocs);
}

// DB helpers (Î¯Î´Î¹Î¿ ÏƒÏ„Ï…Î» Î¼Îµ db/enrDB/payDB)
const planDB={all(){return JSON.parse(localStorage.getItem(KEY_PLANS)||'[]')},
  save(v){localStorage.setItem(KEY_PLANS,JSON.stringify(v))},
  upsert(r){const a=planDB.all();const i=a.findIndex(x=>x.id===r.id);i>=0?a.splice(i,1,r):a.push(r);planDB.save(a)},
  remove(id){planDB.save(planDB.all().filter(x=>x.id!==id))}
};
const chargeDB={all(){return JSON.parse(localStorage.getItem(KEY_CHARGES)||'[]')},
  save(v){localStorage.setItem(KEY_CHARGES,JSON.stringify(v))},
  upsert(r){const a=chargeDB.all();const i=a.findIndex(x=>x.id===r.id);i>=0?a.splice(i,1,r):a.push(r);chargeDB.save(a)},
  upsertMany(arr){const all=chargeDB.all();arr.forEach(r=>{const i=all.findIndex(x=>x.id===r.id);i>=0?all.splice(i,1,r):all.push(r)});chargeDB.save(all)},
  remove(id){chargeDB.save(chargeDB.all().filter(x=>x.id!==id))}
};
const allocDB={all(){return JSON.parse(localStorage.getItem(KEY_ALLOC)||'[]')},
  save(v){localStorage.setItem(KEY_ALLOC,JSON.stringify(v))},
  upsert(r){const a=allocDB.all();const i=a.findIndex(x=>x.id===r.id);i>=0?a.splice(i,1,r):a.push(r);allocDB.save(a)},
  remove(id){allocDB.save(allocDB.all().filter(x=>x.id!==id))}
};
const docDB={all(){return JSON.parse(localStorage.getItem(KEY_DOCS)||'[]')},
  save(v){localStorage.setItem(KEY_DOCS,JSON.stringify(v))},
  upsert(r){const a=docDB.all();const i=a.findIndex(x=>x.id===r.id);i>=0?a.splice(i,1,r):a.push(r);docDB.save(a)},
  remove(id){docDB.save(docDB.all().filter(x=>x.id!==id))}
};

const KEY_EXAMS = 'apollon_exams';
const examDB = {
  all(){ return JSON.parse(localStorage.getItem(KEY_EXAMS) || '[]'); },
  save(v){ localStorage.setItem(KEY_EXAMS, JSON.stringify(v)); },
  upsert(r){
    const a = examDB.all(); const i = a.findIndex(x => x.id === r.id);
    i>=0 ? a.splice(i,1,r) : a.push(r);
    examDB.save(a);
  },
  remove(id){ examDB.save(examDB.all().filter(x => x.id !== id)); }
};

function todayISO() {
  return new Date().toISOString().slice(0,10);
}

/* ===== ÎœÎ±Î¸Î·Ï„Î¿Î»ÏŒÎ³Î¹Î¿ (Registry) ===== */
const registryBtn = document.getElementById('registryBtn');
const registryModal = document.getElementById('registryModal');
const registryClose = document.getElementById('registryClose');
const registryForm  = document.getElementById('registryForm');
const regYearSel    = document.getElementById('regYear');
const regSemesterSel= document.getElementById('regSemester');
const regGovSel     = document.getElementById('regGov');

// Î“Î­Î¼Î¹ÏƒÎ¼Î± Î­Ï„Î¿Ï…Ï‚ (ÏŒÏ€Ï‰Ï‚ ÎºÎ¬Î½ÎµÎ¹Ï‚ ÎºÎ±Î¹ Î³Î¹Î± Ï„Î¿ yearFilter)
function fillAcademicYearsForRegistry(){
  if (!regYearSel) return;
  regYearSel.innerHTML = academicYears().map(y => `<option>${y}</option>`).join('');
  // default ÏƒÏ„Î¿ Ï„ÏÎ­Ï‡Î¿Î½
  regYearSel.value = academicYears()[0];
}

// Î†Î½Î¿Î¹Î³Î¼Î±/ÎºÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ modal
function openRegistry(){ registryModal.classList.add('open'); registryModal.setAttribute('aria-hidden', 'false'); }
function closeRegistry(){ registryModal.classList.remove('open'); registryModal.setAttribute('aria-hidden', 'true'); }

if (registryBtn) registryBtn.addEventListener('click', () => { fillAcademicYearsForRegistry(); openRegistry(); });
if (registryClose) registryClose.addEventListener('click', closeRegistry);
registryModal?.addEventListener('click', (e)=>{ if(e.target===registryModal) closeRegistry(); });

// Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎµÎ¾Î±Î¼Î®Î½Î¿Ï… Î±Ï€ÏŒ Î—Î¼/Î½Î¯Î± Î•Î³Î³ÏÎ±Ï†Î®Ï‚
// ÎšÎ±Î½ÏŒÎ½Î±Ï‚: Î‘' ÎµÎ¾Î¬Î¼Î·Î½Î¿ = Sepâ€“Feb (Î¼Î®Î½ÎµÏ‚ 8..11 Î® 0..1), Î’' ÎµÎ¾Î¬Î¼Î·Î½Î¿ = Marâ€“Aug (Î¼Î®Î½ÎµÏ‚ 2..7)
function semesterFromDate(dstr){
  if(!dstr) return null;
  let dt;
  if (/^\d{4}-\d{2}-\d{2}$/.test(dstr)) {         // 2025-09-04
    dt = new Date(dstr);
  } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dstr)) { // 04/09/2025
    const [dd,mm,yyyy] = dstr.split('/').map(n=>parseInt(n,10));
    dt = new Date(yyyy, mm-1, dd);
  } else {
    dt = new Date(dstr); // fallback
  }
  if (isNaN(+dt)) return null;
  const m = dt.getMonth(); // 0..11
  return (m>=8 || m<=1) ? 'A' : 'B'; // A: Sepâ€“Feb, B: Marâ€“Aug
}


// Î£Ï…Î³ÎºÎ­Î½Ï„ÏÏ‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÎµÎ³Î³ÏÎ±Ï†ÏÎ½ Î³Î¹Î± Ï†Î¯Î»Ï„ÏÎ± modal
function collectRegistryData({year, semester, govFilter}){
  const students = db.all();
  const enrolls  = enrDB.all();

  let list = enrolls.filter(e => String(e.year) === String(year));

  // Î²Î¬ÏƒÎ· Î—Î¼/Î½Î¯Î±Ï‚ Î•Î³Î³ÏÎ±Ï†Î®Ï‚ (regDate)
  list = list.filter(e => semesterFromDate(e.regDate) === semester);

  // Î¥Ï€Î¿Ï…ÏÎ³ÎµÎ¯Î¿: govReg (boolean)
  if (govFilter === 'yes') list = list.filter(e => !!e.govReg);
  else if (govFilter === 'no') list = list.filter(e => !e.govReg);

  const mapStud = new Map(students.map(s => [s.id, s]));
  const rows = list.map(e => {
    const s = mapStud.get(e.studentId) || {};
    return {
      studentId: e.studentId,
      surname: s.surname || '',
      name: s.name || '',
      school: e.school || '',
      class: e.class || '',
      teacher: e.teacher || '',
      enrDate: e.regDate || '',
      gov: !!e.govReg
    };
  });

  return rows.sort((a,b)=> (a.surname||'').localeCompare(b.surname||'','el') || (a.name||'').localeCompare(b.name||'','el'));
}

// ===== ÎœÎ‘Î˜Î—Î¤ÎŸÎ›ÎŸÎ“Î™ÎŸ: HTML Builder + Print =====

// Î Î±Î¯ÏÎ½Ï‰ Ï„Î¹Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚ (Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· Î· getSettings ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿)
function getSettings(){
  try { return JSON.parse(localStorage.getItem('apollon_settings') || '{}'); }
  catch { return {}; }
}

// Î‘ÏƒÏ†Î±Î»Î­Ï‚ print ÏƒÎµ Î½Î­Î¿ ÎºÎ±Î¸Î±ÏÏŒ window (Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€Î±ÏÏŒÎ¼Î¿Î¹Î¿ helper - Ï„Î¿ ÎºÏÎ±Ï„Î¬Î¼Îµ ÎµÎ´Ï scoped)
function safePrintHTMLLandscape(html){
  const w = window.open('', '_blank');
  if(!w){ alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Ï„ÏÎ­ÏˆÏ„Îµ pop-ups Î³Î¹Î± Î½Î± ÎµÎ¾Î±Ï‡Î¸ÎµÎ¯ Ï„Î¿ PDF.'); return; }
  w.document.open();
  w.document.write(`<!doctype html>
  <html><head><meta charset="utf-8">
    <title>ÎœÎ±Î¸Î·Ï„Î¿Î»ÏŒÎ³Î¹Î¿</title>
    <style>
      @page { size: A4 landscape; margin: 12mm; }
      *{box-sizing:border-box}
      body { margin:0; font: 11pt/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#111; }
      h1,h2{margin:0}
      .header { display:flex; align-items:flex-start; gap:10px; }
      .school-block { page-break-inside: avoid; margin-top: 12pt; }
      .title { text-align:center; margin: 10pt 0 14pt; }
      .muted { color:#666; }
      table { width:100%; border-collapse:collapse; }
      th, td { border-bottom:1px solid #eee; padding:6pt 4pt; font-size:10pt; text-align:left; vertical-align:top; }
      thead th { white-space:nowrap; font-size:10pt; }
      .nr { text-align:right; }
      .footer-date { position:fixed; right:12mm; bottom:8mm; font-size:9pt; color:#666; }
      .pagebreak { page-break-before: always; }
      .school-title { font-size:13pt; color:#0c5757; margin: 8pt 0 6pt; }
      /* Î•Î»Î±Ï†ÏÏÏ‚ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î»Î¬Ï„Î¿Ï…Ï‚ ÏƒÏ„Î¹Ï‚ Î¼ÎµÎ³Î¬Î»ÎµÏ‚ ÏƒÏ„Î®Î»ÎµÏ‚ */
      .col-addr { max-width: 280px; }
      .col-remarks { max-width: 240px; }
      .col-class { white-space:nowrap; }
    </style>
  </head>
  <body>${html}<div class="footer-date">Î—Î¼/Î½Î¯Î± Ï€Î±ÏÎ±Î³Ï‰Î³Î®Ï‚: ${new Date().toISOString().slice(0,10)}</div></body></html>`);
  w.document.close(); w.focus();
  w.onload = () => { try { w.print(); } finally { w.close(); } };
}

// ÎœÎ¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î·Î¼/Î½Î¯Î±Ï‚ ÏƒÎµ dd/mm/yyyy, Î´Î­Ï‡ÎµÏ„Î±Î¹ ÎºÎ±Î¹ ISO Î® Î®Î´Î· dd/mm/yyyy
function toDDMMYYYY(dstr){
  if(!dstr) return '';
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(dstr)) return dstr;
  const dt = new Date(dstr);
  if (isNaN(+dt)) return String(dstr);
  const dd = String(dt.getDate()).padStart(2,'0');
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const yyyy = dt.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

// Î‘Ï€ÏŒ Ï„Î¿ string dob (yyyy-mm-dd Î® dd/mm/yyyy) ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†Ï‰ Î­Ï„Î¿Ï‚ Î³Î­Î½Î½Î·ÏƒÎ·Ï‚
function birthYearFrom(dob){
  if(!dob) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(dob)) return dob.slice(0,4);
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(dob)) return dob.slice(-4);
  const dt = new Date(dob);
  return isNaN(+dt) ? '' : String(dt.getFullYear());
}

// ÎšÎµÏ†Î±Î»Î¯Î´Î± Ï€ÏÏÏ„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚: ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î·ÏÎ¯Î¿Ï… Î±Ï€ÏŒ settings + ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒÏ‚ Ï„Î¯Ï„Î»Î¿Ï‚
function registryCoverHeader(params){
  const S = getSettings(); // companyName, afm, doy, address, city, phone, email
  const semLabel = (params.semester === 'A' ? 'Î‘' : 'Î’');
  return `
    <div class="header">
      <div>
        <div><b>${S.companyName||''}</b></div>
        <div class="muted">Î‘Î¦Îœ: ${S.afm||'â€”'}, Î”ÎŸÎ¥: ${S.doy||'â€”'}</div>
        <div class="muted">${S.address||''} ${S.city||''}</div>
        <div class="muted">Î¤: ${S.phone||''} â€¢ E: ${S.email||''}</div>
      </div>
      <div class="title" style="flex:1">
        <h1>ÎœÎ‘Î˜Î—Î¤ÎŸÎ›ÎŸÎ“Î™ÎŸ ${semLabel} Î•ÎÎ‘ÎœÎ—ÎÎŸÎ¥ - Î”Î™Î”Î‘ÎšÎ¤Î™ÎšÎŸÎ¥ Î•Î¤ÎŸÎ¥Î£ ${params.year}</h1>
      </div>
    </div>
  `;
}

// ÎŸÎ¼Î±Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î½Î¬ Î£Ï‡Î¿Î»Î® ÎºÎ±Î¹ rendering Ï€Î¯Î½Î±ÎºÎ± Î¼Îµ 10 ÏƒÏ„Î®Î»ÎµÏ‚
function buildRegistryHTML(data, params){
  // data: Î±Ï€ÏŒ collectRegistryData(params) â€” Î®Î´Î· Ï†Î¹Î»Ï„ÏÎ±ÏÎ¹ÏƒÎ¼Î­Î½Î±
  // enrichment Î±Ï€ÏŒ students Î³Î¹Î± Ï€Î±Ï„ÏÏÎ½Ï…Î¼Î¿, Î‘ÎœÎšÎ‘, Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, Ï€ÏŒÎ»Î·, dob Îº.Î»Ï€.
  const students = db.all();
  const stMap = new Map(students.map(s => [s.id, s]));

  // enhance + sort Î±Î½Î¬ ÏƒÏ‡Î¿Î»Î® -> (ÎµÏ€ÏÎ½Ï…Î¼Î¿, ÏŒÎ½Î¿Î¼Î±)
  const rows = data.map(r => {
    const s = stMap.get(r.studentId) || {};
    return {
      school: r.school || 'â€”',
      surname: r.surname || s.surname || '',
      name: r.name || s.name || '',
      fatherName: s.fatherName || '',
      birthYear: birthYearFrom(s.dob || ''),
      amka: s.amka || '',
      address: [s.address, s.city].filter(Boolean).join(', '),
      regDate: toDDMMYYYY(r.enrDate || r.regDate || ''),
      classYear: [r.class || '', (r.yearOfStudy || r.studyYear || r.semester || '')].filter(Boolean).join(' '),
      teacher: r.teacher || '',
      remarks: r.notes || '' // Î±Ï€ÏŒ modal ÎµÎ³Î³ÏÎ±Ï†ÏÎ½
    };
  });

  // group by school
  const groups = new Map();
  for (const row of rows) {
    if (!groups.has(row.school)) groups.set(row.school, []);
    groups.get(row.school).push(row);
  }

  // sort each group by surname, name
  for (const [k, arr] of groups) {
    arr.sort((a,b)=> (a.surname||'').localeCompare(b.surname||'','el') || (a.name||'').localeCompare(b.name||'','el'));
  }

  // render
  let html = registryCoverHeader(params);

  for (const [school, arr] of groups) {
    html += `
    <div class="school-block">
      <h2 class="school-title">${school}</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Î•Ï€ÏÎ½Ï…Î¼Î¿ & ÎŒÎ½Î¿Î¼Î±</th>
            <th>ÎŒÎ½Î¿Î¼Î± Î Î±Ï„ÏÏŒÏ‚</th>
            <th>ÎˆÏ„Î¿Ï‚ Î“Î­Î½Î½Î·ÏƒÎ·Ï‚</th>
            <th>Î‘ÎœÎšÎ‘</th>
            <th class="col-addr">Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· & Î ÎµÏÎ¹Î¿Ï‡Î®</th>
            <th>Î—Î¼/Î½Î¯Î± Î•Î³Î³ÏÎ±Ï†Î®Ï‚</th>
            <th class="col-class">Î¤Î¬Î¾Î· & ÎˆÏ„Î¿Ï‚ Î¦Î¿Î¯Ï„Î·ÏƒÎ·Ï‚</th>
            <th>ÎšÎ±Î¸Î·Î³Î·Ï„Î®Ï‚</th>
            <th class="col-remarks">Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚</th>
          </tr>
        </thead>
        <tbody>
          ${arr.map((r, i)=>`
            <tr>
              <td class="nr">${i+1}</td>
              <td>${[r.surname, r.name].filter(Boolean).join(' ')}</td>
              <td>${r.fatherName||''}</td>
              <td>${r.birthYear||''}</td>
              <td>${r.amka||''}</td>
              <td class="col-addr">${r.address||''}</td>
              <td>${r.regDate||''}</td>
              <td class="col-class">${r.classYear||''}</td>
              <td>${r.teacher||''}</td>
              <td class="col-remarks">${r.remarks||''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>`;
  }

  return html;
}

// ÎšÏÏÎ¹Î± ÏÎ¿Ï…Ï„Î¯Î½Î± Î³Î¹Î± Submit: Ï†Ï„Î¹Î¬Ï‡Î½ÎµÎ¹ HTML ÎºÎ±Î¹ ÏƒÏ„Î­Î»Î½ÎµÎ¹ ÏƒÎµ print (landscape)
function buildRegistryReport(data, params){
  const html = buildRegistryHTML(data, params);
  safePrintHTMLLandscape(html);
}


registryForm?.addEventListener('submit', (e) => {
  e.preventDefault();
  const params = {
    year: regYearSel.value,
    semester: regSemesterSel.value,
    govFilter: regGovSel.value
  };
  const data = collectRegistryData(params);
  // === ÎÎ•ÎŸ: Ï€Î±ÏÎ±Î³Ï‰Î³Î® PDF
  buildRegistryReport(data, params);
  closeRegistry();
});

// Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· (Ï‡Ï‰ÏÎ¯Ï‚ ÎºÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ modal)
document.getElementById('registryPreviewBtn')?.addEventListener('click', () => {
  const params = {
    year: regYearSel.value,
    semester: regSemesterSel.value,
    govFilter: regGovSel.value
  };
  const data = collectRegistryData(params);
  alert(`Î’ÏÎ­Î¸Î·ÎºÎ±Î½ ${data.length} ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Î³Î¹Î± ${params.year}, ÎµÎ¾Î¬Î¼Î·Î½Î¿ ${params.semester}, Ï…Ï€Î¿Ï…ÏÎ³ÎµÎ¯Î¿: ${params.govFilter}.`);
});

// --- Î•Î¾Î±Î³Ï‰Î³Î® ÏƒÎµ Word (.doc â€” HTML Ï€Î¿Ï… Î±Î½Î¿Î¯Î³ÎµÎ¹ ÏƒÎµ Word) ---
function wordWrapHTML(innerHTML){
  // Landscape Î³Î¹Î± Word: Section1 CSS Î¼Îµ mso- Î¹Î´Î¹ÏŒÏ„Î·Ï„ÎµÏ‚
  return `<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8"><title>ÎœÎ±Î¸Î·Ï„Î¿Î»ÏŒÎ³Î¹Î¿</title>
  <!-- Î•Î»Î¬Ï‡Î¹ÏƒÏ„Î± Word-specific styles -->
  <style>
    @page Section1 { size: 29.7cm 21cm; mso-page-orientation: landscape; margin: 12mm; }
    div.Section1 { page: Section1; }
    body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; color:#111; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:6pt 4pt; vertical-align:top; }
    thead th { background:#f6f6f6; }
    .nr { text-align:right; }
    .school-title { font-size:13pt; color:#0c5757; margin: 8pt 0 6pt; }
    .muted { color:#666; }
    .footer-date { position:fixed; right:12mm; bottom:8mm; font-size:9pt; color:#666; }
  </style>
</head>
<body><div class="Section1">
  ${innerHTML}
  <div class="footer-date">Î—Î¼/Î½Î¯Î± Ï€Î±ÏÎ±Î³Ï‰Î³Î®Ï‚: ${new Date().toISOString().slice(0,10)}</div>
</div></body></html>`;
}

function downloadWordFromHTML(fullHTML, filename='mathitologio.doc'){
  const blob = new Blob(['\ufeff', fullHTML], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}

// ÎšÎ¿Ï…Î¼Ï€Î¯: Î•Î¾Î±Î³Ï‰Î³Î® ÏƒÎµ Word
document.getElementById('registryWordBtn')?.addEventListener('click', () => {
  const params = {
    year: regYearSel.value,
    semester: regSemesterSel.value,
    govFilter: regGovSel.value
  };
  const data = collectRegistryData(params);
  const inner = buildRegistryHTML(data, params);     // ÎŠÎ´Î¹Î¿ HTML Î¼Îµ Ï„Î¿ PDF
  const full  = wordWrapHTML(inner);
  const semLabel = (params.semester === 'A' ? 'A' : 'B');
  const fname = `ÎœÎ±Î¸Î·Ï„Î¿Î»ÏŒÎ³Î¹Î¿_${params.year}_${semLabel}.doc`;
  downloadWordFromHTML(full, fname);
});


function renderPlanRealChargesInModal() {
  const tbody = document.getElementById('planRealTbody');
  const cSpan = document.getElementById('planRealCount');
  const dueSpan = document.getElementById('planRealDue');
  if (!tbody || !cSpan || !dueSpan) return;

  if (!selectedEnrollmentId) {
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ³Î³ÏÎ±Ï†Î®.</td></tr>`;
    cSpan.textContent = '0';
    dueSpan.textContent = '0.00â‚¬';
    return;
  }

  let list = chargeDB.all().filter(c => c.enrollmentId === selectedEnrollmentId);
  if (yearFilter.value) list = list.filter(c => c.year === yearFilter.value);

  list.sort((a,b) => (a.ym||'').localeCompare(b.ym||'') || (a.type||'').localeCompare(b.type||''));

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎµÎ³Î³ÏÎ±Ï†Î®.</td></tr>`;
    cSpan.textContent = '0';
    dueSpan.textContent = '0.00â‚¬';
    return;
  }

  // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï…Ï€Î¿Î»Î¿Î¯Ï€Î¿Ï… (Î¸ÎµÏ„Î¹ÎºÏŒ=Î¿Ï†ÎµÎ¹Î»Î®, Î±ÏÎ½Î·Ï„Î¹ÎºÏŒ=Ï€Î¯ÏƒÏ„Ï‰ÏƒÎ·)
  let totalRemain = 0;

  tbody.innerHTML = list.map(c => {
    const paid = allocationSumForCharge(c.id);
    const remain = ((+c.amount)||0) - ((+paid)||0);
    totalRemain += remain;

    const st = chargeStatusById(c.id); // 'open'|'partial'|'paid'
    const stLabel = st==='paid' ? 'Î•Î¾Î¿Ï†Î»Î·Î¼Î­Î½Î¿' : (st==='partial' ? 'ÎœÎµÏÎ¹ÎºÏÏ‚' : 'Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ');
    const badge = `<span class="badge ${st}${c.locked?' locked':''}">${c.locked?'ğŸ”’ ':''}${stLabel}</span>`;

    // ÎšÎ¿Ï…Î¼Ï€Î¯ Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ (ÎºÎ¿Ï…Î²Î±Î´Î¬ÎºÎ¹). Disabled Î±Î½ locked Î® Î±Î½ Î­Ï‡ÎµÎ¹ allocations
    const hasAllocs = (paid > 0.0001);
    const canDelete = !c.locked && !hasAllocs;
    const delBtn = `<button class="btn warn plan-charge-del" data-id="${c.id}" ${canDelete?'':'disabled'} title="${canDelete?'Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚':'Î”ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹ Î´Î¹Î±Î³ÏÎ±Ï†Î® (Î­Ï‡ÎµÎ¹ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ Î® ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î·)'}">ğŸ—‘ï¸</button>`;

    const monthTxt = `${c.monthLabel||''} ${(c.ym||'').slice(0,4)}`;

    return `<tr data-id="${c.id}">
      <td>${monthTxt}</td>
      <td>${c.description||''}</td>
      <td>${fmtDate(c.dateDue)}</td>
      <td>${(+c.amount||0).toFixed(2)}â‚¬</td>
      <td>${badge}</td>
      <td style="text-align:right;">${delBtn}</td>
    </tr>`;
  }).join('');

  cSpan.textContent = String(list.length);
  dueSpan.textContent = totalRemain.toFixed(2) + 'â‚¬';
}

/* ======= Tuition helpers (dates, months, status) ======= */
function greekMonthName(m){return ['Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚','Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚','ÎœÎ¬ÏÏ„Î¹Î¿Ï‚','Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚','ÎœÎ¬Î¹Î¿Ï‚','Î™Î¿ÏÎ½Î¹Î¿Ï‚','Î™Î¿ÏÎ»Î¹Î¿Ï‚','Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚','Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚','ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚','ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚','Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚'][m]}
function ymString(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
function academicYearFromDate(d){const y=d.getMonth()>=8?d.getFullYear():d.getFullYear()-1;return `${y}-${String(y+1).slice(-2)}`}
function allocationSumForCharge(chargeId){return allocDB.all().filter(a=>a.chargeId===chargeId).reduce((s,a)=>s+(+a.amount||0),0)}
function chargeStatusById(id){const c=chargeDB.all().find(x=>x.id===id);if(!c) return 'unknown';const paid=allocationSumForCharge(id);const due=(+c.amount)||0;return paid<=0?'open':(paid<due?'partial':'paid')}

/* ======= Plan + Charge generation (no UI yet) ======= */
// Î ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½Î± Ï€ÎµÎ´Î¯Î± Plan: { id, studentId, enrollmentId, monthlyAmount, monthsActive, startYm: 'YYYY-MM', registrationFee, discountType, discountValue, notes }
function generateChargesForPlan(plan,{recreateFutureOnly=true,defaultDueDay=10}={}){
  if(!plan||!plan.enrollmentId) return [];
  const created=[];
  const parts=(plan.startYm||'').split('-'); let y=+parts[0], m=(+parts[1]||1)-1; if(!y||m<0) {const now=new Date(); y=now.getFullYear(); m=now.getMonth();}
  const count=+plan.monthsActive||0;
  const now=new Date(); const currentMonthStart=new Date(now.getFullYear(),now.getMonth(),1);
  for(let i=0;i<count;i++){
    const dt=new Date(y,m+i,1);
    if(recreateFutureOnly){const monthEnd=new Date(dt.getFullYear(),dt.getMonth()+1,0); if(monthEnd<currentMonthStart) continue;}
    const ym=ymString(dt); const year=academicYearFromDate(dt);
    const exists=chargeDB.all().find(c=>c.enrollmentId===plan.enrollmentId && c.type==='tuition' && c.ym===ym);
    if(exists && exists.locked) continue;
    const charge={
      id: exists?exists.id:uid(),
      studentId: plan.studentId,
      enrollmentId: plan.enrollmentId,
      type:'tuition',
      description:`Î”Î¯Î´Î±ÎºÏ„ÏÎ± ${greekMonthName(dt.getMonth())} ${dt.getFullYear()}`,
      dateDue:new Date(dt.getFullYear(),dt.getMonth(),defaultDueDay).toISOString().slice(0,10),
      amount:Number(plan.monthlyAmount||0),
      vatRate:0,
      exemptionReason:'VAT-exempt education',
      e3Code:null,
      year, ym, monthLabel: greekMonthName(dt.getMonth()),
      locked:false,
      updated_at:new Date().toISOString()
    };
    chargeDB.upsert(charge); created.push(charge.id);
  }
  if(+plan.registrationFee>0){
    const dt=new Date(y,m,1); const year=academicYearFromDate(dt); const ym=ymString(dt);
    const reg={
      id: uid(), studentId: plan.studentId, enrollmentId: plan.enrollmentId,
      type:'registration', description:'Î¤Î­Î»Î¿Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚',
      dateDue:new Date(dt.getFullYear(),dt.getMonth(),1).toISOString().slice(0,10),
      amount:Number(plan.registrationFee||0), vatRate:0, exemptionReason:'VAT-exempt education', e3Code:null,
      year, ym, monthLabel: greekMonthName(dt.getMonth()), locked:false, updated_at:new Date().toISOString()
    };
    chargeDB.upsert(reg); created.push(reg.id);
  }
  return created;
}

// Ad-hoc service charge (Ï‡Ï‰ÏÎ¯Ï‚ enrollment)
function createServiceCharge({studentId,enrollmentId=null,description,amount,dateDue}){
  const d=dateDue?new Date(dateDue):new Date();
  const year=academicYearFromDate(d); const ym=ymString(d);
  const rec={id:uid(), studentId, enrollmentId, type:'service', description:description||'Î¥Ï€Î·ÏÎµÏƒÎ¯Î±',
    dateDue:d.toISOString().slice(0,10), amount:Number(amount||0), vatRate:0, exemptionReason:'VAT-exempt education', e3Code:null,
    year, ym, monthLabel:greekMonthName(d.getMonth()), locked:false, updated_at:new Date().toISOString()};
  chargeDB.upsert(rec); return rec.id;
}

function buildPlanPreview() {
  const tbody = document.getElementById('planPreviewTbody');
  const cSpan = document.getElementById('planPrevCount');
  const sSpan = document.getElementById('planPrevSum');
  if (!tbody || !cSpan || !sSpan) return;

  const monthly = parseFloat(p.monthly.value || '0') || 0;
  const months  = parseInt(p.months.value || '0', 10) || 0;
  const startYm = (p.startYm.value || '').trim();
  const regFee  = parseFloat(p.regFee.value || '0') || 0;
  const dueDay  = Math.max(1, Math.min(28, parseInt(p.dueDay.value || '10', 10)));
  const futureOnly = !!p.futureOnly.checked;

  // Î‘Î½ Î»ÎµÎ¯Ï€Î¿Ï…Î½ Î²Î±ÏƒÎ¹ÎºÎ¬, Î²Î¬Î»Îµ Î¼Î®Î½Ï…Î¼Î±
  if (!months || !startYm || monthly < 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÎœÎ·Î½Î¹Î±Î¯Î¿ Î Î¿ÏƒÏŒ, ÎˆÎ½Î±ÏÎ¾Î· ÎºÎ±Î¹ Î”Î¹Î¬ÏÎºÎµÎ¹Î±.</td></tr>`;
    cSpan.textContent = '0';
    sSpan.textContent = '0.00â‚¬';
    return;
  }

  // Parse start
  const [sy, sm] = startYm.split('-').map(n => parseInt(n, 10));
  let start = new Date(sy || new Date().getFullYear(), (sm ? sm-1 : 0), 1);

  const now = new Date();
  const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);

  const rows = [];
  let total = 0;
  let seq = 0;

  // Î“ÎµÎ½Î¹Î¬ Î¼Î·Î½Î¹Î±Î¯Ï‰Î½ Î´Î¹Î´Î¬ÎºÏ„ÏÏ‰Î½ (ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î¿ generateChargesForPlan)
  for (let i = 0; i < months; i++) {
    const dt = new Date(start.getFullYear(), start.getMonth() + i, 1);

    if (futureOnly) {
      const monthEnd = new Date(dt.getFullYear(), dt.getMonth()+1, 0);
      if (monthEnd < currentMonthStart) continue;
    }

    const ym = ymString(dt);
    const year = academicYearFromDate(dt);
    const desc = `Î”Î¯Î´Î±ÎºÏ„ÏÎ± ${greekMonthName(dt.getMonth())} ${dt.getFullYear()}`;
    const due = new Date(dt.getFullYear(), dt.getMonth(), dueDay);

    rows.push({
      idx: ++seq,
      monthLabel: `${greekMonthName(dt.getMonth())} ${(ym||'').slice(0,4)}`,
      dateDue: due.toISOString().slice(0,10),
      desc,
      amount: monthly,
      type: 'tuition',
      year
    });

    total += monthly;
  }

  // Î¤Î­Î»Î¿Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚ (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
  if (regFee > 0) {
    const dt0 = new Date(start.getFullYear(), start.getMonth(), 1);
    rows.unshift({
      idx: 0,
      monthLabel: `${greekMonthName(dt0.getMonth())} ${dt0.getFullYear()}`,
      dateDue: new Date(dt0.getFullYear(), dt0.getMonth(), 1).toISOString().slice(0,10),
      desc: 'Î¤Î­Î»Î¿Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚',
      amount: regFee,
      type: 'registration',
      year: academicYearFromDate(dt0)
    });
    total += regFee;
    // Î•Ï€Î±Î½Î±ÏÎ¯Î¸Î¼Î·ÏƒÎ·
    rows.forEach((r, i) => r.idx = i+1);
  }

  if (rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Î”ÎµÎ½ Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½ Î½Î­ÎµÏ‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î¼Îµ Ï„Î± Ï„Ï‰ÏÎ¹Î½Î¬ ÎºÏÎ¹Ï„Î®ÏÎ¹Î±.</td></tr>`;
    cSpan.textContent = '0';
    sSpan.textContent = '0.00â‚¬';
    return;
  }

  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${r.idx}</td>
      <td>${r.monthLabel}</td>
      <td>${fmtDate(r.dateDue)}</td>
      <td>${r.desc}</td>
      <td>${(+r.amount||0).toFixed(2)}â‚¬</td>
      <td><span class="badge ${r.type==='registration'?'adjust':'open'}">${r.type==='registration'?'Î•Î³Î³ÏÎ±Ï†Î®':'Î”Î¯Î´Î±ÎºÏ„ÏÎ±'}</span></td>
    </tr>
  `).join('');

  cSpan.textContent = String(rows.length);
  sSpan.textContent = total.toFixed(2) + 'â‚¬';
}

function fillSchoolSelect(sel){
  const c = catRead();
  sel.innerHTML = `<option value="">â€”</option>` + (c.schools||[])
    .map(s => `<option>${s.name}</option>`).join('');
}

function fillClassSelect(sel, schoolName){
  const c = catRead();
  const school = (c.schools||[]).find(s => s.name === schoolName);
  const classes = school ? school.classes.map(cl => (typeof cl==='string'? cl : cl.name)) : [];
  sel.innerHTML = `<option value="">â€”</option>` + classes.map(n => `<option>${n}</option>`).join('');
}

function fillYearOfStudySelect(sel, schoolName, className){
  const c = catRead();
  const school = (c.schools||[]).find(s => s.name === schoolName);
  const cl = school?.classes.find(x => (typeof x==='string' ? x===className : x.name===className));
  const years = !cl ? [] : (typeof cl==='string' ? [] : (cl.years || []));
  sel.innerHTML = `<option value="">â€”</option>` + years.map(y => `<option>${y}</option>`).join('');
}



/* ======= Academic years ======= */
function academicYears(n=7){
  const arr=[]; const now=new Date(); let y=now.getMonth()>=8?now.getFullYear():now.getFullYear()-1;
  for(let i=0;i<n;i++) arr.push(`${y-i}-${(y-i+1).toString().slice(-2)}`);
  return arr;
}
function fillYearSelect(sel){ sel.innerHTML=academicYears().map(y=>`<option>${y}</option>`).join(''); }

/* ======= Tabs behavior ======= */
const paymentsTabBtn = el('#paymentsTabBtn');
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

/* ======= Students UI ======= */
const tbody=el('#tbl tbody'), q=el('#q'), count=el('#count');
const delBtn=el('#delBtn'), newBtn=el('#newBtn'), exportBtn=el('#exportBtn'), importInp=el('#importInp');
const studentHeading=el('#studentHeading');
const yearFilter=el('#yearFilter'); fillYearSelect(yearFilter);

let selectedStudentId=null;
let selectedEnrollmentId=null;
let selectedPaymentId = null;

function renderStudents(filter=''){
  const data=db.all().sort((a,b)=>(a.surname||'').localeCompare(b.surname||'','el'));
  const term=filter.trim().toLowerCase();
  const rows=term?data.filter(s=>[s.surname,s.name,s.phone,s.email].some(v=>(v||'').toLowerCase().includes(term))):data;
  tbody.innerHTML=rows.map(s=>`
    <tr data-id="${s.id}" class="${s.id===selectedStudentId?'active':''}">
      <td>${s.surname||''}</td><td>${s.name||''}</td><td>${fmtDate(s.dob)}</td><td>${s.phone||''}</td><td>${s.email||''}</td>
    </tr>`).join('');
  count.textContent=rows.length;
  delBtn.disabled=!selectedStudentId;
}
renderStudents();

// === Exam UI refs ===
const enrExamBtn = document.getElementById('enrExamBtn');
enrExamBtn.disabled = true;

const examModal = document.getElementById('examModal');
const examClose = document.getElementById('examClose');
const examForm  = document.getElementById('examForm');
const ex = {
  id:    document.getElementById('examId'),
  date:  document.getElementById('examDate'),
  subj:  document.getElementById('examSubject'),
  type:  document.getElementById('examType'),
  fee:   document.getElementById('examFee'),
  res:   document.getElementById('examResult'),
  grade: document.getElementById('examGrade'),
  cert:  document.getElementById('examCert'),
  notes: document.getElementById('examNotes'),
  makeCharge: document.getElementById('examCreateCharge')
};

/* ======= Student Form ======= */
const form=el('#form'), formTitle=el('#formTitle');
const f={id:el('#id'),surname:el('#surname'),name:el('#name'),fatherName: el('#fatherName'),amka: el('#amka'),birthPlace: el('#birthPlace'),dob:el('#dob'),phone:el('#phone'),email:el('#email'),city:el('#city'),address:el('#address'),notes:el('#notes')};

function clearStudentForm(){
  form.reset(); f.id.value=''; selectedStudentId=null; formTitle.textContent='ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®';
  studentHeading.textContent='ÎšÎ±Î½Î­Î½Î±Ï‚ ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚';
  [...tbody.children].forEach(r=>r.classList.remove('active'));
  delBtn.disabled=true;
  
  // ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î± tabs ÎµÎ³Î³ÏÎ±Ï†ÏÎ½/Ï€Î»Î·ÏÏ‰Î¼ÏÎ½
  document.getElementById('enrollmentsTabBtn').disabled = true;
  document.getElementById('paymentsTabBtn').disabled = true;

  // reset enrollments & payments state
  selectedEnrollmentId=null;
  disableEnrollmentForm(true);
  disablePaymentForm(true);
  renderEnrollments(); 
  renderPayments();
}
el('#resetBtn').addEventListener('click',clearStudentForm);
newBtn.addEventListener('click',clearStudentForm);


  // ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½ ÏŒÏ„Î±Î½ ÎºÎ¬Î½ÎµÎ¹Ï‚ ÎºÎ»Î¹Îº ÏƒÏ„Î¿ username
  document.addEventListener('DOMContentLoaded', () => {
    const u = document.getElementById('userName');
    if (u) {
      u.style.cursor = 'pointer';
      u.title = 'Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚';
      u.addEventListener('click', () => {
        window.location.href = 'settings.html';
      });
    }
  });

function loadStudent(rec){
  formTitle.textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®';
  Object.keys(f).forEach(k=>f[k].value=rec[k]??'');
  f.dob.value=toISO(rec.dob);
  f.fatherName.value = rec.fatherName ?? '';
  f.amka.value       = rec.amka ?? '';
  f.birthPlace.value = rec.birthPlace ?? '';
  studentHeading.textContent=`${rec.surname||''} ${rec.name||''}`.trim() || 'Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®';
}

form.addEventListener('submit',e=>{
  e.preventDefault();
  const rec={
    id:f.id.value||uid(),
    surname:f.surname.value.trim(),
    name:f.name.value.trim(),
    dob:f.dob.value||null,
    phone:f.phone.value.trim(),
    email:f.email.value.trim(),
    city:f.city.value.trim(),
    address:f.address.value.trim(),
    notes:f.notes.value.trim(),
    fatherName: f.fatherName.value.trim(),
    amka: f.amka.value.trim(),
    birthPlace: f.birthPlace.value.trim(),
    updated_at:new Date().toISOString()
  };
  if(!rec.surname||!rec.name){alert('Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÎŒÎ½Î¿Î¼Î± ÎºÎ±Î¹ Î•Ï€ÏÎ½Ï…Î¼Î¿.');return;}
  db.upsert(rec);
  f.id.value=rec.id; selectedStudentId=rec.id;
  renderStudents(q.value);
  formTitle.textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®';
  // enable enrollments tab for this student
  disableEnrollmentForm(false);
  renderEnrollments(); renderPayments();
});

tbody.addEventListener('click', e => {
  const tr = e.target.closest('tr'); if (!tr) return;
  selectedStudentId = tr.dataset.id;
  const rec = db.all().find(x => x.id === selectedStudentId);
  loadStudent(rec);

   // Enable enrollments & payments tab
document.getElementById('enrollmentsTabBtn').disabled = false;
document.getElementById('paymentsTabBtn').disabled = false;

  // UI
  [...tbody.children].forEach(r => r.classList.remove('active'));
  tr.classList.add('active');
  delBtn.disabled = false;
  if (massPayBtn) massPayBtn.disabled = false;

  // Reset/lock related forms
  selectedEnrollmentId = null;
  clearEnrForm();
  //disablePaymentForm(true);
  clearPayForm();
  enrPlanBtn.disabled = true; // Î¬Î»Î»Î±Î¾Îµ Î¼Î±Î¸Î·Ï„Î®Ï‚ â†’ ÎºÎ±Î¼Î¯Î± ÎµÎ³Î³ÏÎ±Ï†Î® ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·
  enrExamBtn.disabled = true;

  // optional: always jump to "Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±"
  document.querySelector('[data-tab="tab-student"]').click();

  // refresh
  renderEnrollments();
  renderPayments();
  renderCharges(); // ÎÎ•ÎŸ
});

q.addEventListener('input',e=>renderStudents(e.target.value));

/* ======= Backup / Restore ======= */
exportBtn.addEventListener('click',()=>{
  const payload = {
    version: 'apollon-1',
    exported_at: new Date().toISOString(),
    students: db.all(),
    enrollments: enrDB.all(),
    payments: payDB.all(),
    plans: planDB.all(),
    charges: chargeDB.all(),
    allocations: allocDB.all(),
    documents: docDB.all()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `apollon_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(a.href);
});

importInp.addEventListener('change', async e => {
  const file = e.target.files?.[0]; if (!file) return;
  try {
    const text = await file.text();
    const data = JSON.parse(text);

    // Backward-compat: Ï€Î±Î»Î¹Î¬ backups Î®Ï„Î±Î½ ÏƒÎºÎ­Ï„Î¿ array Î¼Î±Î¸Î·Ï„ÏÎ½
    if (Array.isArray(data)) {
      localStorage.setItem(KEY_STUDENTS, JSON.stringify(data));
    } else if (data && typeof data === 'object') {
      if ('students'     in data) localStorage.setItem(KEY_STUDENTS, JSON.stringify(data.students     || []));
      if ('enrollments'  in data) localStorage.setItem(KEY_ENROLLS,  JSON.stringify(data.enrollments  || []));
      if ('payments'     in data) localStorage.setItem(KEY_PAYMENTS, JSON.stringify(data.payments     || []));
      if ('plans'        in data) localStorage.setItem(KEY_PLANS,    JSON.stringify(data.plans        || []));
      if ('charges'      in data) localStorage.setItem(KEY_CHARGES,  JSON.stringify(data.charges      || []));
      if ('allocations'  in data) localStorage.setItem(KEY_ALLOC,    JSON.stringify(data.allocations  || []));
      if ('documents'    in data) localStorage.setItem(KEY_DOCS,     JSON.stringify(data.documents    || []));
    } else {
      throw new Error('ÎœÎ· Î±Î½Î±Î³Î½Ï‰ÏÎ¯ÏƒÎ¹Î¼Î¿ format backup');
    }

    // refresh UI
    cleanupOrphans();  // â† Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—
    renderStudents(q.value);
    renderEnrollments();
    renderPayments();
    renderCharges(); // âœ ÏÏƒÏ„Îµ Î½Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„Î¿ÏÎ½ ÎºÎ±Î¹ Î¿Î¹ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î¿ backup

    alert('Î— ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ.');
  } catch (err) {
    alert('Î£Ï†Î¬Î»Î¼Î± ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚: ' + err.message);
  }
  e.target.value = '';
});

/* ======= ENROLLMENTS (Tab) ======= */
const enrTblBody=el('#enrTbl tbody'), enrCount=el('#enrCount'), enrYearEcho=el('#enrYearEcho');
// ===== Charges UI refs =====
const chargesSection = document.getElementById('chargesSection');
const chgTblBody     = document.querySelector('#chgTbl tbody');
const chgCount       = document.getElementById('chgCount');
const chgDue         = document.getElementById('chgDue');
const chgRefreshBtn  = document.getElementById('chgRefreshBtn');
const chgLockBtn     = document.getElementById('chgLockBtn');
const chgUnlockBtn   = document.getElementById('chgUnlockBtn');
const chgAdjBtn      = document.getElementById('chgAdjBtn');
// === Adjustment UI refs ===
const adjModal  = document.getElementById('adjModal');
const adjClose  = document.getElementById('adjClose');
const adjForm   = document.getElementById('adjForm');
const aj = {
  kind:   document.getElementById('adjKind'),
  amount: document.getElementById('adjAmount'),
  ym:     document.getElementById('adjYm'),
  due:    document.getElementById('adjDue'),
  desc:   document.getElementById('adjDesc')
};

// Renderer Ï„Ï‰Î½ Ï‡ÏÎµÏÏƒÎµÏ‰Î½ Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎµÎ³Î³ÏÎ±Ï†Î®/Î­Ï„Î¿Ï‚
function renderCharges(){
  if(!chgTblBody) return;

  // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· section Î¼ÏŒÎ½Î¿ ÏŒÏ„Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎµÎ³Î³ÏÎ±Ï†Î®
  chargesSection.style.display = selectedEnrollmentId ? '' : 'none';
  if(!selectedEnrollmentId){ chgTblBody.innerHTML=''; chgCount.textContent='0'; chgDue.textContent='0â‚¬'; return; }

  let list = chargeDB.all();
  if(selectedStudentId)   list = list.filter(c => c.studentId === selectedStudentId);
  if(selectedEnrollmentId)list = list.filter(c => c.enrollmentId === selectedEnrollmentId);
  if(yearFilter.value)    list = list.filter(c => c.year === yearFilter.value);

  // Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·: Î¼Îµ Î²Î¬ÏƒÎ· YYYY-MM, Î¼ÎµÏ„Î¬ Ï„ÏÏ€Î¿
  list.sort((a,b) => (a.ym||'').localeCompare(b.ym||'') || (a.type||'').localeCompare(b.type||''));

  chgTblBody.innerHTML = list.map(c => {
const st = chargeStatusById(c.id); // 'open'|'partial'|'paid'
const stLabel = st==='paid' ? 'Î•Î¾Î¿Ï†Î»Î·Î¼Î­Î½Î¿' : (st==='partial' ? 'ÎœÎµÏÎ¹ÎºÏÏ‚' : 'Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ');
let badge;
if (c.type === 'adjustment') {
  const lbl = (c.amount||0) < 0 ? 'Î Î¯ÏƒÏ„Ï‰ÏƒÎ·' : 'Î§ÏÎ­Ï‰ÏƒÎ·';
  badge = `<span class="badge ${ (c.amount||0) < 0 ? 'credit' : 'adjust' }">${lbl}</span>`;
} else {
  badge = `<span class="badge ${st}${c.locked?' locked':''}">${c.locked?'ğŸ”’ ':''}${stLabel}</span>`;
}

    const monthTxt = `${c.monthLabel||''} ${(c.ym||'').slice(0,4)}`;
    return `<tr data-id="${c.id}">
      <td>${monthTxt}</td>
      <td>${c.description||''}</td>
      <td>${c.type||''}</td>
      <td>${fmtDate(c.dateDue)}</td>
      <td>${(+c.amount||0).toFixed(2)}â‚¬</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');

  chgCount.textContent = String(list.length);

// Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ (ÏƒÏÎ½Î¿Î»Î¿): sum(Ï€Î¿ÏƒÎ¬) - sum(Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚) ÏƒÎµ ÎŸÎ›Î•Î£ Ï„Î¹Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚
let total = 0;
for (const c of list) {
  const paid = allocationSumForCharge(c.id);
  total += ((+c.amount)||0) - ((+paid)||0); // adjustments (+/-) Î¼ÎµÏ„ÏÎ¬Î½Îµ ÏƒÏ‰ÏƒÏ„Î¬
}
chgDue.textContent = Math.max(0, total).toFixed(2) + 'â‚¬';


  // reset actions
  chgLockBtn.disabled   = true;
  chgUnlockBtn.disabled = true;
  chgAdjBtn.disabled    = true;
}

// Î•Ï€Î¹Î»Î¿Î³Î® Î³ÏÎ±Î¼Î¼Î®Ï‚ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚ (enable actions)
document.querySelector('#chgTbl')?.addEventListener('click', e=>{
  const tr = e.target.closest('tr'); if(!tr) return;
  [...chgTblBody.children].forEach(r=>r.classList.remove('active'));
  tr.classList.add('active');
  const id = tr.dataset.id;
  const c = chargeDB.all().find(x=>x.id===id); if(!c) return;

  chgLockBtn.disabled   = !!c.locked;
  chgUnlockBtn.disabled = !c.locked;
  chgAdjBtn.disabled    = false;
});

chgRefreshBtn?.addEventListener('click', renderCharges);
chgLockBtn?.addEventListener('click', ()=>{
  const tr = chgTblBody.querySelector('tr.active'); if(!tr) return;
  const id = tr.dataset.id; const c = chargeDB.all().find(x=>x.id===id); if(!c) return;
  c.locked = true; c.updated_at = new Date().toISOString(); chargeDB.upsert(c); renderCharges();
});
chgUnlockBtn?.addEventListener('click', ()=>{
  const tr = chgTblBody.querySelector('tr.active'); if(!tr) return;
  const id = tr.dataset.id; const c = chargeDB.all().find(x=>x.id===id); if(!c) return;
  c.locked = false; c.updated_at = new Date().toISOString(); chargeDB.upsert(c); renderCharges();
});
chgAdjBtn?.addEventListener('click', () => {
  // Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï‡ÏÎ­Ï‰ÏƒÎ· (Î¼Î®Î½Î±Ï‚)
  const tr = chgTblBody.querySelector('tr.active');
  if (!tr) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼Î¯Î± Ï‡ÏÎ­Ï‰ÏƒÎ·/Î¼Î®Î½Î± Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±.'); return; }
  const c = chargeDB.all().find(x => x.id === tr.dataset.id);
  if (!c) { alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î· Ï‡ÏÎ­Ï‰ÏƒÎ·.'); return; }

  // Î ÏÎ¿-ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎ·
  aj.kind.value   = 'credit';
  aj.amount.value = '';
  aj.ym.value     = (c.ym || new Date().toISOString().slice(0,7));
  aj.due.value    = (c.dateDue || '');
  aj.desc.value   = c.type==='tuition' ? `Adjustment ${c.monthLabel} ${(c.ym||'').slice(0,4)}` : 'Adjustment';

  openModal(adjModal);
});

adjClose?.addEventListener('click', () => closeModal(adjModal));
adjModal?.addEventListener('click', e => { if (e.target === adjModal) closeModal(adjModal); });

adjForm?.addEventListener('submit', e => {
  e.preventDefault();
  if (!selectedEnrollmentId || !selectedStudentId) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ³Î³ÏÎ±Ï†Î®.'); return; }

  const amount = parseFloat(aj.amount.value || '0');
  if (!(amount > 0)) { alert('Î”ÏÏƒÎµ Ï€Î¿ÏƒÏŒ > 0'); return; }

  const sign = aj.kind.value === 'credit' ? -1 : 1;

  // Parse YYYY-MM
  const ym = aj.ym.value;
  const [yy, mm] = ym.split('-').map(n => parseInt(n,10));
  if (!yy || !mm) { alert('ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿Ï‚ Î¼Î®Î½Î±Ï‚.'); return; }
  const d = new Date(yy, mm - 1, 1);

  const rec = {
    id: uid(),
    studentId: selectedStudentId,
    enrollmentId: selectedEnrollmentId,
    type: 'adjustment',
    description: (aj.desc.value || '').trim() || (sign < 0 ? 'Î Î¯ÏƒÏ„Ï‰ÏƒÎ·' : 'Î§ÏÎ­Ï‰ÏƒÎ·') + ` ${greekMonthName(mm-1)} ${yy}`,
    dateDue: (aj.due.value || new Date(yy, mm-1, 10).toISOString().slice(0,10)),
    amount: sign * amount,
    vatRate: 0,
    exemptionReason: 'VAT-exempt education',
    e3Code: null,
    year: academicYearFromDate(d),
    ym: ym,
    monthLabel: greekMonthName(mm-1),
    locked: false,
    updated_at: new Date().toISOString()
  };

  chargeDB.upsert(rec);
  closeModal(adjModal);
  renderCharges();
});

const enrNewBtn=el('#enrNewBtn'), enrDelBtn=el('#enrDelBtn');
const enrModal=el('#enrModal'), enrClose=el('#enrClose');
const enrForm=el('#enrForm'), enrFormTitle=el('#enrFormTitle');
const ef={id:el('#enrId'),year:el('#enrYear'),school:el('#enrSchool'),class:el('#enrClass'),govYear:el('#enrGovYear'),semester:el('#enrSemester'),regDate:el('#enrDate'),teacher:el('#enrTeacher'),govReg:el('#enrGovReg'),notes:el('#enrNotes')};
// === Plan UI refs ===
const enrPlanBtn = document.getElementById('enrPlanBtn');
enrPlanBtn.disabled = true; // Î±ÏÏ‡Î¹ÎºÎ¬ off

const planModal  = document.getElementById('planModal');
const planClose  = document.getElementById('planClose');
const planForm   = document.getElementById('planForm');
const p = {
  id:        document.getElementById('planId'),
  monthly:   document.getElementById('planMonthly'),
  startYm:   document.getElementById('planStartYm'),
  months:    document.getElementById('planMonths'),
  regFee:    document.getElementById('planRegFee'),
  futureOnly:document.getElementById('planFutureOnly'),
  dueDay:    document.getElementById('planDueDay'),
  notes:     document.getElementById('planNotes')
};

// Î–Ï‰Î½Ï„Î±Î½Î® Î±Î½Î±Î½Î­Ï‰ÏƒÎ· Ï„Î·Ï‚ Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·Ï‚ Î¼ÏŒÎ»Î¹Ï‚ Î±Î»Î»Î¬Î¶ÎµÎ¹ ÎºÎ¬Ï„Î¹ ÏƒÏ„Î¿ Ï€Î»Î¬Î½Î¿
['monthly','startYm','months','regFee','dueDay','futureOnly','notes'].forEach(k=>{
  if (p[k]) {
    const evt = (k==='futureOnly' ? 'change' : 'input');
    p[k].addEventListener(evt, buildPlanPreview);
  }
});

fillYearSelect(yearFilter); fillYearSelect(ef.year);
yearFilter.value=academicYears()[0];
ef.year.value=yearFilter.value;

function disableEnrollmentForm(disabled){
  [ef.year,ef.school,ef.class,ef.teacher,ef.semester,ef.regDate,ef.govYear,ef.govReg,ef.notes, el('#enrSaveBtn')].forEach(x=>x.disabled=disabled);
  enrNewBtn.disabled=disabled || !selectedStudentId;
  if(disabled){ enrForm.reset(); ef.id.value=''; }
}

migrateCatalogs();
fillSchoolSelect(ef.school);
fillClassSelect(ef.class, ef.school.value);
fillYearOfStudySelect(ef.govYear, ef.school.value, ef.class.value);
fillYearSelect(ef.year);

// ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚
ef.school.onchange = () => {
  fillClassSelect(ef.class, ef.school.value);
  ef.class.value = '';
  fillYearOfStudySelect(ef.govYear, ef.school.value, '');
  ef.govYear.value = '';
};
ef.class.onchange = () => {
  fillYearOfStudySelect(ef.govYear, ef.school.value, ef.class.value);
  ef.govYear.value = '';
};




function clearEnrForm(){ enrForm.reset(); ef.id.value=''; ef.govYear.value = ''; ef.govReg.checked = false; enrFormTitle.textContent='ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î•Î³Î³ÏÎ±Ï†Î®Ï‚'; ef.year.value=yearFilter.value; ef.regDate.value = todayISO(); }
el('#enrClearBtn').addEventListener('click',clearEnrForm);enrPlanBtn.disabled = true;

// Open/Close modal
enrNewBtn.addEventListener('click',()=>{
  clearEnrForm();
  if(!selectedStudentId){alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®.');return;}
  disableEnrollmentForm(false);   // âœ ÎÎµÎºÎ»ÎµÎ¹Î´ÏÎ½ÎµÎ¹ Ï„Î± inputs
  openModal(enrModal);
  // ... Î±Ï†Î¿Ï Î¿ÏÎ¯ÏƒÎµÎ¹Ï‚ selectedEnrollmentId ÎºÎ±Î¹ ÎºÎ¬Î½ÎµÎ¹Ï‚ highlight
  enrPlanBtn.disabled = false; // ÎºÎ¹ ÎµÎ´Ï on, Î³Î¹Î± ÏƒÏ…Î½Î­Ï€ÎµÎ¹Î±
  
});

enrClose.addEventListener('click',()=>closeModal(enrModal));
enrModal.addEventListener('click',e=>{ if(e.target===enrModal) closeModal(enrModal); });

// Î†Î½Î¿Î¹Î³Î¼Î± modal Î Î»Î¬Î½Î¿Ï…
enrPlanBtn.addEventListener('click', () => {
  if (!selectedEnrollmentId || !selectedStudentId) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ³Î³ÏÎ±Ï†Î®.'); return; }
  // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î¿Ï‚ Ï€Î»Î¬Î½Î¿Ï… (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
  const pl = planDB.all().find(x => x.enrollmentId === selectedEnrollmentId) || null;
  if (pl) {
    p.id.value      = pl.id;
    p.monthly.value = pl.monthlyAmount ?? '';
    p.startYm.value = pl.startYm ?? '';
    p.months.value  = pl.monthsActive ?? '';
    p.regFee.value  = pl.registrationFee ?? '';
    p.notes.value   = pl.notes ?? '';
  } else {
    planForm.reset();
    p.id.value = '';
    // defaults: Î­Î½Î±ÏÎ¾Î· Î±Ï€ÏŒ Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿ Ï„Î¿Ï… ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï… Î­Ï„Î¿Ï…Ï‚, Î±Î»Î»Î¹ÏÏ‚ Ï„ÏÎ­Ï‡Î¿Î½ Î¼Î®Î½Î±
    const ysel = yearFilter.value; // Ï€.Ï‡. "2025-26"
    const start = ysel ? `${ysel.split('-')[0]}-09` : new Date().toISOString().slice(0,7);
    p.startYm.value = start;
    p.dueDay.value = 10;
    p.futureOnly.checked = true;
  }
 p.months.value = '';
openModal(planModal);
buildPlanPreview(); // ÎÎ•ÎŸ
renderPlanRealChargesInModal();

});

yearFilter.addEventListener('change', () => {
  renderPlanRealChargesInModal();
});

// ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ modal
planClose.addEventListener('click', () => closeModal(planModal));
planModal.addEventListener('click', e => { if (e.target === planModal) closeModal(planModal); });

planForm.addEventListener('submit', e => {
  e.preventDefault();
  if (!selectedEnrollmentId || !selectedStudentId) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ³Î³ÏÎ±Ï†Î®.'); return; }

  const plan = {
    id:              p.id.value || uid(),
    studentId:       selectedStudentId,
    enrollmentId:    selectedEnrollmentId,
    monthlyAmount:   parseFloat(p.monthly.value || '0'),
    startYm:         p.startYm.value,
    monthsActive:    parseInt(p.months.value || '0', 10),
    registrationFee: parseFloat(p.regFee.value || '0'),
    notes:           (p.notes.value || '').trim(),
    updated_at:      new Date().toISOString()
  };

  if (!(plan.monthlyAmount >= 0) || !(plan.monthsActive > 0) || !plan.startYm) {
    alert('Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏƒÏ‰ÏƒÏ„Î¬: ÎœÎ·Î½Î¹Î±Î¯Î¿ Ï€Î¿ÏƒÏŒ, ÎˆÎ½Î±ÏÎ¾Î·, Î”Î¹Î¬ÏÎºÎµÎ¹Î±.');
    return;
  }

  planDB.upsert(plan);

  const dueDay = Math.max(1, Math.min(28, parseInt(p.dueDay.value || '10', 10)));
  const ids = generateChargesForPlan(plan, {
    recreateFutureOnly: !!p.futureOnly.checked,
    defaultDueDay: dueDay
  });

  closeModal(planModal);
  alert(`Î¤Î¿ Ï€Î»Î¬Î½Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.\nÎ”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎ±Î½/ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎ±Î½ ${ids.length} Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚.`);
  renderPlanRealChargesInModal(); // â† Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—
  renderCharges();                // â† Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—

});

function renderEnrollments(){
  enrYearEcho.textContent = yearFilter.value || 'â€”';
  if(!yearFilter.value) yearFilter.value=academicYears()[0];

  let list=enrDB.all();
  if(selectedStudentId) list=list.filter(e=>e.studentId===selectedStudentId);
  if(yearFilter.value) list=list.filter(e=>e.year===yearFilter.value);

enrTblBody.innerHTML = list.map(e => `
  <tr data-id="${e.id}" class="${e.id===selectedEnrollmentId?'active':''}">
    <td class="sel">
      <input type="radio" class="enrSelect" name="enrSelect"
             data-id="${e.id}" ${e.id===selectedEnrollmentId ? 'checked' : ''}>
    </td>
    <td>${e.year}</td>
    <td>${e.school||''}</td>
    <td>${e.class||''}</td>
    <td>${e.teacher||''}</td>
    <td>${fmtDate(e.regDate)}</td>
    <td><button class="btn light enrViewBtn" data-id="${e.id}">Î ÏÎ¿Î²Î¿Î»Î®</button></td>
  </tr>`).join('');

  enrCount.textContent=list.length;
  // if previous selected enrollment not present, clear selection + lock payments
  if (selectedEnrollmentId && !list.some(x=>x.id===selectedEnrollmentId)) {
    selectedEnrollmentId=null; clearEnrForm(); disablePaymentForm(true);
  }
  enrDelBtn.disabled=!selectedEnrollmentId;
  enrNewBtn.disabled=!selectedStudentId;
  enrPlanBtn.disabled = !selectedEnrollmentId; // on Î¼ÏŒÎ½Î¿ ÏŒÏ„Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î® ÎµÏ€Î¹Î»Î¿Î³Î®
  renderCharges(); // ÎÎ•ÎŸ
  enrExamBtn.disabled = !selectedEnrollmentId;

}
yearFilter.addEventListener('change',()=>{ renderEnrollments(); renderPayments(); renderCharges(); });

enrForm.addEventListener('submit',e=>{
  e.preventDefault();
  if(!selectedStudentId){ alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®.'); return; }
  const rec={
    id: ef.id.value || uid(),
    studentId: selectedStudentId,
    year: ef.year.value || yearFilter.value,
    school: ef.school.value.trim(),
    class: ef.class.value.trim(),
    teacher: ef.teacher.value.trim(),
    semester: ef.semester.value,
    regDate: ef.regDate.value || null,
    govYear: (ef.govYear.value || '').trim(),
    govReg:  !!ef.govReg.checked,
    notes: ef.notes.value.trim(),
    updated_at:new Date().toISOString()
  };
  if(!rec.school || !rec.class){ alert('Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î£Ï‡Î¿Î»Î® ÎºÎ±Î¹ Î¤Î¬Î¾Î·.'); return; }
  enrDB.upsert(rec);
  ef.id.value=rec.id; enrFormTitle.textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î•Î³Î³ÏÎ±Ï†Î®Ï‚';
  selectedEnrollmentId=rec.id;
  renderEnrollments(); renderPayments();
  renderCharges(); // ÎÎ•ÎŸ
  closeModal(enrModal);
});

enrTblBody.addEventListener('click', e => {
  if (!e.target.classList.contains('enrViewBtn')) return;
  const id = e.target.dataset.id;
  selectedEnrollmentId = id;
  const rec = enrDB.all().find(x => x.id === id);
  if (!rec) return;

  // Î³Î­Î¼Î¹ÏƒÎ¼Î± Ï€ÎµÎ´Î¯Ï‰Î½ â€¦
  ef.id.value       = rec.id;
  ef.year.value     = rec.year || '';
  ef.school.value   = rec.school || '';
  ef.class.value    = rec.class || '';
  ef.teacher.value  = rec.teacher || '';
  ef.semester.value = rec.semester || '';
  ef.regDate.value  = toISO(rec.regDate);
  ef.govYear.value  = rec.govYear || '';
  ef.govReg.checked = !!rec.govReg;

  ef.notes.value    = rec.notes || '';

  enrFormTitle.textContent = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î•Î³Î³ÏÎ±Ï†Î®Ï‚';

  [...enrTblBody.children].forEach(r => r.classList.remove('active'));
  e.target.closest('tr').classList.add('active');


 // âœ… Î¤ÏƒÎ­ÎºÎ±ÏÎµ Ï„Î¿ radio Ï„Î·Ï‚ Î¯Î´Î¹Î±Ï‚ Î³ÏÎ±Î¼Î¼Î®Ï‚
  const radio = e.target.closest('tr').querySelector('input[type="radio"]');
  if (radio) {
    radio.checked = true;
  }

  disableEnrollmentForm(false);
  disablePaymentForm(false);
  renderPayments();
  enrDelBtn.disabled = false;
  enrExamBtn.disabled = false;
  enrPlanBtn.disabled = false;
  openModal(enrModal);
});


// Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÏŒ: Ï†Î­ÏÎ½ÎµÎ¹ Ï„Î·Î½ Ï€Î¹Î¿ Ï€ÏÏŒÏƒÏ†Î±Ï„Î· ÎµÎ¾Î­Ï„Î±ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎµÎ³Î³ÏÎ±Ï†Î® (ÎºÎ±Î¹ Î­Ï„Î¿Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…)
function getLatestExamForEnrollment(enrollmentId, year){
  let list = examDB.all().filter(x => x.enrollmentId === enrollmentId);
  if (year) list = list.filter(x => x.year === year);
  if (!list.length) return null;
  // Ï„Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·: Î¼Îµ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± (desc), Î­Ï€ÎµÎ¹Ï„Î± updated_at (desc)
  list.sort((a,b) => new Date(b.date||0) - new Date(a.date||0) || new Date(b.updated_at||0) - new Date(a.updated_at||0));
  return list[0];
}

enrExamBtn.addEventListener('click', () => {
  if (!selectedEnrollmentId || !selectedStudentId) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ³Î³ÏÎ±Ï†Î®.'); return; }

  // ÏˆÎ¬Î¾Îµ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÎ¾Î­Ï„Î±ÏƒÎ· Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÎ³Î³ÏÎ±Ï†Î® (ÎºÎ±Î¹ Î­Ï„Î¿Ï‚)
  const existing = getLatestExamForEnrollment(selectedEnrollmentId, yearFilter.value);

  examForm.reset();

  if (existing) {
    // === EDIT: Ï†ÏŒÏÏ„Ï‰ÏƒÎµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï„Î·Ï‚ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±Ï‚ ÎµÎ¾Î­Ï„Î±ÏƒÎ·Ï‚ ===
    ex.id.value    = existing.id;
    ex.date.value  = existing.date || new Date().toISOString().slice(0,10);
    ex.subj.value  = existing.subject || '';
    ex.type.value  = existing.type || 'final';
    ex.fee.value   = existing.fee ?? 0;
    ex.res.value   = existing.result || '';
    ex.grade.value = existing.grade || '';
    ex.cert.value  = existing.cert || '';
    ex.notes.value = existing.notes || '';
    ex.makeCharge.checked = !!existing.chargeId && (existing.fee||0) > 0;
  } else {
    // === NEW: defaults ===
    ex.id.value   = '';
    ex.date.value = new Date().toISOString().slice(0,10);
    ex.subj.value = '';
    ex.type.value = 'final';
    ex.fee.value  = '';
    ex.res.value  = '';
    ex.grade.value= '';
    ex.cert.value = '';
    ex.notes.value= '';
    ex.makeCharge.checked = true;
  }

  openModal(examModal);
});

examClose.addEventListener('click', () => closeModal(examModal));
examModal.addEventListener('click', e => { if (e.target === examModal) closeModal(examModal); });

examForm.addEventListener('submit', e => {
  e.preventDefault();
  if (!selectedEnrollmentId || !selectedStudentId) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ³Î³ÏÎ±Ï†Î®.'); return; }

  const fee = parseFloat(ex.fee.value || '0') || 0;
  const wantCharge = !!ex.makeCharge.checked;

  // Î Î±Î»Î¹Î¬ ÎµÎ³Î³ÏÎ±Ï†Î® (Î±Î½ ÎºÎ¬Î½Î¿Ï…Î¼Îµ edit)
  const prevExam = ex.id.value ? examDB.all().find(x => x.id === ex.id.value) : null;

  // ===== 1) Î¦Ï„Î¹Î¬Î¾Îµ / ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎµ Ï„Î¿ exam record =====
  const rec = {
    id: ex.id.value || uid(),
    studentId: selectedStudentId,
    enrollmentId: selectedEnrollmentId,
    date: ex.date.value || new Date().toISOString().slice(0,10),
    subject: (ex.subj.value || '').trim(),
    type: ex.type.value || 'final',
    fee: fee,
    result: ex.res.value || '',
    grade: (ex.grade.value || '').trim(),
    cert: (ex.cert.value || '').trim(),
    notes: (ex.notes.value || '').trim(),
    year: yearFilter.value || null,
    // ÎºÏÎ±Ï„Î¬Î¼Îµ Ï„Ï…Ï‡ÏŒÎ½ Ï€Î±Î»Î¹ÏŒ chargeId
    chargeId: prevExam?.chargeId || null,
    updated_at: new Date().toISOString(),
    created_at: prevExam ? prevExam.created_at : new Date().toISOString()
  };

  // ===== 2) Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î§ÏÎ­Ï‰ÏƒÎ·Ï‚ ÎµÎ¾Î­Ï„Î±ÏƒÎ·Ï‚ =====
  const hadCharge = !!rec.chargeId;

  if (wantCharge && fee > 0) {
    if (hadCharge) {
      // UPDATE Ï…Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎ±Ï‚ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚
      const c = chargeDB.all().find(c => c.id === rec.chargeId);
      if (c) {
        const d = new Date(rec.date);
        c.description = rec.subject ? `Î•Î¾Î­Ï„Î±ÏƒÎ·: ${rec.subject}` : 'Î•Î¾Î­Ï„Î±ÏƒÎ·';
        c.dateDue     = rec.date;
        c.amount      = fee;
        c.monthLabel  = greekMonthName(d.getMonth());
        c.ym          = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        c.year        = academicYearFromDate(d);
        c.updated_at  = new Date().toISOString();
        chargeDB.upsert(c);
      } else {
        // chargeId â€œÏ‡Î¬Î¸Î·ÎºÎµâ€ â†’ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Î±Ï‚ ÎºÎ±Î¹ Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· ÏƒÏ„Î¿ exam
        const d = new Date(rec.date);
        const newCharge = {
          id: uid(),
          studentId: selectedStudentId,
          enrollmentId: selectedEnrollmentId,
          type:'exam',
          description: rec.subject ? `Î•Î¾Î­Ï„Î±ÏƒÎ·: ${rec.subject}` : 'Î•Î¾Î­Ï„Î±ÏƒÎ·',
          dateDue: rec.date,
          amount: fee,
          vatRate: 0,
          exemptionReason:'VAT-exempt education',
          e3Code: null,
          year: academicYearFromDate(d),
          ym: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,
          monthLabel: greekMonthName(d.getMonth()),
          locked:false,
          updated_at: new Date().toISOString()
        };
        chargeDB.upsert(newCharge);
        rec.chargeId = newCharge.id;
      }
    } else {
      // CREATE Î½Î­Î± Ï‡ÏÎ­Ï‰ÏƒÎ·
      const d = new Date(rec.date);
      const ch = {
        id: uid(),
        studentId: selectedStudentId,
        enrollmentId: selectedEnrollmentId,
        type:'exam',
        description: rec.subject ? `Î•Î¾Î­Ï„Î±ÏƒÎ·: ${rec.subject}` : 'Î•Î¾Î­Ï„Î±ÏƒÎ·',
        dateDue: rec.date,
        amount: fee,
        vatRate: 0,
        exemptionReason:'VAT-exempt education',
        e3Code: null,
        year: academicYearFromDate(d),
        ym: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,
        monthLabel: greekMonthName(d.getMonth()),
        locked:false,
        updated_at: new Date().toISOString()
      };
      chargeDB.upsert(ch);
      rec.chargeId = ch.id;
    }
  } else {
    // Î”ÎµÎ½ Î¸Î­Î»Î¿Ï…Î¼Îµ Ï‡ÏÎ­Ï‰ÏƒÎ· (Î® fee=0): Î±Î½ Ï…Ï€Î®ÏÏ‡Îµ, Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î½Î± Ï„Î· Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Î¼Îµ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±
    if (hadCharge) {
      const allocSum = allocationSumForCharge(rec.chargeId);
      if (allocSum > 0.0001) {
        alert('Î— Ï‡ÏÎ­Ï‰ÏƒÎ· ÎµÎ¾Î­Ï„Î±ÏƒÎ·Ï‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚/Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ â€” Î´ÎµÎ½ Î´Î¹Î±Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹. Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ Î¼ÏŒÎ½Î¿ Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ exam.');
        // Î£Ï€Î¬Î¼Îµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ exam Î³Î¹Î± Î½Î± Î¼Î·Î½ Î¾Î±Î½Î±Î³Î¯Î½ÎµÎ¹ update Ï„Î·Ï‚ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚
        rec.chargeId = null;
      } else {
        chargeDB.remove(rec.chargeId);
        rec.chargeId = null;
      }
    }
  }

  // Î¤ÎµÎ»Î¹ÎºÏŒ upsert exam Î¼Îµ ÎµÎ½Î·Î¼ÎµÏÏ‰Î¼Î­Î½Î¿ chargeId (Î±Î½ Î¬Î»Î»Î±Î¾Îµ)
  examDB.upsert(rec);

  closeModal(examModal);
  renderCharges();
});

// Î•Ï€Î¹Î»Î¿Î³Î® ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚ Î¼Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î· Î³ÏÎ±Î¼Î¼Î®, Î§Î©Î¡Î™Î£ Î½Î± Î±Î½Î¿Î¯Î³ÎµÎ¹ modal
enrTblBody.addEventListener('click', e => {
  const tr = e.target.closest('tr');
  if (!tr) return;

  // Î‘Î½ Ï€Î¬Ï„Î·ÏƒÎµÏ‚ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Î ÏÎ¿Î²Î¿Î»Î®", Î¼Î·Î½ ÎºÎ¬Î½ÎµÎ¹Ï‚ Ï„Î¯Ï€Î¿Ï„Î± ÎµÎ´Ï
  if (e.target.classList.contains('enrViewBtn')) return;

  selectedEnrollmentId = tr.dataset.id;
  enrPlanBtn.disabled = false; // Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎµÎ³Î³ÏÎ±Ï†Î® â†’ Î¬Î½Î¿Î¹Î¾Îµ Ï„Î¿ Î Î»Î¬Î½Î¿

  // visual + Ï„ÏƒÎ­ÎºÎ±ÏÎµ Ï„Î¿ radio
  [...enrTblBody.children].forEach(r => r.classList.remove('active'));
  tr.classList.add('active');
  const rb = tr.querySelector('.enrSelect');
  if (rb) rb.checked = true;   // Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ property, ÏŒÏ‡Î¹ setAttribute

  // ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼ÏÎ½ & Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎµÎ³Î³ÏÎ±Ï†Î®
  disablePaymentForm(false);
  renderPayments();
  renderCharges(); // ÎÎ•ÎŸ
  enrDelBtn.disabled = false;
  enrExamBtn.disabled = false;   // <-- Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—
  // Î£ÎšÎŸÎ Î™ÎœÎ‘: Î´ÎµÎ½ ÎºÎ±Î»Î¿ÏÎ¼Îµ openModal Î¿ÏÏ„Îµ disableEnrollmentForm(false)
  // Î³Î¹Î± Î½Î± Î¼Î·Î½ Î±Î½Î¿Î¯Î¾ÎµÎ¹ modal ÎºÎ±Î¹ Î½Î± Î¼ÎµÎ¯Î½ÎµÎ¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î· Î· Ï†ÏŒÏÎ¼Î± Î¼Î­Ï‡ÏÎ¹ Î½Î± Ï€Î±Ï„Î®ÏƒÎµÎ¹Ï‚ "Î ÏÎ¿Î²Î¿Î»Î®"
});

enrDelBtn.addEventListener('click',()=>{
  if(!selectedEnrollmentId) return;
  if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚; Î˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ ÎºÎ±Î¹ Î¿Î¹ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ Ï„Î·Ï‚.')){
    const remainPay=payDB.all().filter(p=>p.enrollmentId!==selectedEnrollmentId); payDB.save(remainPay);

// 1) Î£Î²Î®ÏƒÎµ Ï„Î¹Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… Î±Î½Î®ÎºÎ¿Ï…Î½ ÏƒÏ„Î·Î½ ÎµÎ³Î³ÏÎ±Ï†Î®
const allCharges = chargeDB.all();
const toDeleteChargeIds = allCharges.filter(c => c.enrollmentId === selectedEnrollmentId).map(c => c.id);
const remainCharges = allCharges.filter(c => c.enrollmentId !== selectedEnrollmentId);
chargeDB.save(remainCharges);

// 2) Î£Î²Î®ÏƒÎµ allocations Ï€Î¿Ï… Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î½ ÏƒÎµ Î Î›Î—Î¡Î©ÎœÎ•Î£ Ï€Î¿Ï… Î­ÏƒÎ²Î·ÏƒÎµÏ‚ Î® ÏƒÎµ Î§Î¡Î•Î©Î£Î•Î™Î£ Ï€Î¿Ï… Î­ÏƒÎ²Î·ÏƒÎµÏ‚
const existingPayments = new Set(payDB.all().map(p => p.id));     // Î¼ÎµÏ„Î¬ Ï„Î¿ remainPay save
const existingCharges  = new Set(chargeDB.all().map(c => c.id));  // Î¼ÎµÏ„Î¬ Ï„Î¿ remainCharges save
const remainAlloc = allocDB.all().filter(a => existingPayments.has(a.paymentId) && existingCharges.has(a.chargeId));
allocDB.save(remainAlloc);

    enrDB.remove(selectedEnrollmentId);
    selectedEnrollmentId=null;
    clearEnrForm(); renderEnrollments(); renderPayments(); renderCharges(); disablePaymentForm(true);
  }
});

/* ======= PAYMENTS (Tab) ======= */
const payTblBody=el('#payTbl tbody');
const payNewBtn=el('#payNewBtn'), payDelBtn=el('#payDelBtn');
const sumTotal=el('#sumTotal'), sumCount=el('#sumCount'), sumLast=el('#sumLast');
const payModal=el('#payModal'), payClose=el('#payClose');
const payForm=el('#payForm'), payFormTitle=el('#payFormTitle');
const pf={id:el('#payId'),date:el('#payDate'),month:el('#payMonth'),amount:el('#payAmount'),method:el('#payMethod'),reason:el('#payReason'),notes:el('#payNotes'),batchId: el('#payBatchId')};
const payYearEcho=el('#payYearEcho');

// Actions bar Ï„Î¿Ï… payment form
const payActions   = document.querySelector('#payForm .actions');

// Wrappers Î³Î¹Î± Î½Î± ÎºÏÏÎ²Î¿Ï…Î¼Îµ/Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ Î¿Î»ÏŒÎºÎ»Î·ÏÎ± blocks
const payMonthWrap = document.getElementById('payMonth')?.closest('div');
const payNotesWrap = document.getElementById('payNotes')?.closest('div');

// ===== Allocation UI refs =====
const allocPanel   = document.getElementById('allocPanel');
const allocTbody   = document.getElementById('allocTbody');
const allocPayAmount = document.getElementById('allocPayAmount');
const allocSum     = document.getElementById('allocSum');
const allocRest    = document.getElementById('allocRest');
const allocAutoBtn = document.getElementById('allocAutoBtn');
const allocClearBtn= document.getElementById('allocClearBtn');
// Read-only allocations (Î³Î¹Î± Î¼Î±Î¶Î¹ÎºÎ­Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚)
const allocRoPanel = document.getElementById('allocRoPanel');
const allocRoTbody = document.getElementById('allocRoTbody');
const allocRoMeta  = document.getElementById('allocRoMeta');

function renderAllocationsForPayment(paymentId, paymentRec=null){
  if (!allocRoPanel || !allocRoTbody) return;

  const allocs = allocDB.all().filter(a => a.paymentId === paymentId);
  if (!allocs.length) {
    allocRoTbody.innerHTML = `<tr><td colspan="6" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î®.</td></tr>`;
    if (allocRoMeta && paymentRec?.batchId) allocRoMeta.textContent = `Batch: ${paymentRec.batchId}`;
    return;
  }

  const chargesById = Object.fromEntries(chargeDB.all().map(c => [c.id, c]));
  let totalCov = 0;

  allocRoTbody.innerHTML = allocs.map(a => {
    const c = chargesById[a.chargeId];
    if (!c) return `<tr><td colspan="6" class="muted">[Î§ÏÎ­Ï‰ÏƒÎ· Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ]</td></tr>`;
    const paid = allocationSumForCharge(c.id);
    const st   = chargeStatusById(c.id);
    const stLabel = st==='paid' ? 'Î•Î¾Î¿Ï†Î»Î·Î¼Î­Î½Î¿' : (st==='partial' ? 'ÎœÎµÏÎ¹ÎºÏÏ‚' : 'Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ');
    const monthTxt = `${c.monthLabel || ''} ${(c.ym||'').slice(0,4)}`;
    const cov = (+a.amount || 0);
    totalCov += cov;
    return `
      <tr>
        <td>${monthTxt}</td>
        <td>${c.description || ''}</td>
        <td>${fmtDate(c.dateDue)}</td>
        <td>${(+c.amount||0).toFixed(2)}â‚¬</td>
        <td>${cov.toFixed(2)}â‚¬</td>
        <td><span class="badge ${st}">${stLabel}</span></td>
      </tr>
    `;
  }).join('');

  if (allocRoMeta) {
    const parts = [];
    if (paymentRec?.batchId) parts.push(`Batch: ${paymentRec.batchId}`);
    parts.push(`ÎšÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚: ${allocs.length}`);
    parts.push(`Î£ÏÎ½Î¿Î»Î¿: ${totalCov.toFixed(2)}â‚¬`);
    allocRoMeta.textContent = parts.join(' â€¢ ');
  }

// Footer values Î³Î¹Î± read-only modal
const gross   = +(paymentRec?.amount || 0);             // Ï€Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ (ÏƒÏÎ½Î¿Î»Î¿ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚)
const disc    = +(paymentRec?.discountTotal || 0);      // ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î­ÎºÏ€Ï„Ï‰ÏƒÎ· (Î±Î½ Ï„Î·Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹Ï‚)
const final   = Math.max(0, +(gross - disc).toFixed(2));

const set = (sel, val) => { const n = document.querySelector(sel); if (n) n.textContent = val; };
set('#allocRoSum',   gross.toFixed(2) + 'â‚¬');
set('#allocRoDisc',  disc.toFixed(2)  + 'â‚¬');
set('#allocRoFinal', final.toFixed(2) + 'â‚¬');


}

// ===== Mass Payment UI refs =====
const massPayBtn      = document.getElementById('massPayBtn');
const massPayModal    = document.getElementById('massPayModal');
const massPayClose    = document.getElementById('massPayClose');
const massPayForm     = document.getElementById('massPayForm');
const massDiscountInput = document.getElementById('massDiscountInput');

massDiscountInput?.addEventListener('input', () => {
  updateMassDiscountRows();   // âœ… Î±Î½Ï„Î¯ Î¼ÏŒÎ½Î¿ Î³Î¹Î± updateMassDiscountRows()
  recomputeMassTotals();
});

const mp = {
  date:   document.getElementById('massPayDate'),
  amount: document.getElementById('massPayAmount'),
  method: document.getElementById('massPayMethod'),
  reason: document.getElementById('massPayReason'),
  
  month:  document.getElementById('massMonth'),
  
  saveBtn: document.getElementById('massPaySaveBtn')
};

const massAllocTbody     = document.getElementById('massAllocTbody');
const massAllocPayAmount = document.getElementById('massAllocPayAmount');
const massAllocSum       = document.getElementById('massAllocSum');
const massAllocRest      = document.getElementById('massAllocRest');
const massAllocAutoBtn   = document.getElementById('massAllocAutoBtn');
const massAllocClearBtn  = document.getElementById('massAllocClearBtn');

// Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÏŒ Î³Î¹Î± months dropdown ÏƒÏ„Î¿ modal
const MONTHS_GR = ['Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚','Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚','ÎœÎ¬ÏÏ„Î¹Î¿Ï‚','Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚','ÎœÎ¬Î¹Î¿Ï‚','Î™Î¿ÏÎ½Î¹Î¿Ï‚','Î™Î¿ÏÎ»Î¹Î¿Ï‚','Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚','Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚','ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚','ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚','Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚'];
function fillMonthSelect(sel){ sel.innerHTML = MONTHS_GR.map((m,i)=>`<option value="${i+1}">${m}</option>`).join(''); }

// Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï„Î¹Ï‚ Î‘ÎÎŸÎ™Î§Î¤Î•Î£ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Ï„Î·Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚ (ÎºÎ±Î¹ Î­Ï„Î¿Ï…Ï‚)
function getOpenChargesForEnrollment() {
  if (!selectedEnrollmentId) return [];
  let list = chargeDB.all().filter(c => c.enrollmentId === selectedEnrollmentId);
  if (yearFilter.value) list = list.filter(c => c.year === yearFilter.value);
  // Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ = Ï€Î¿ÏƒÏŒ - Î®Î´Î· Ï€Î»Î·ÏÏ‰Î¼Î­Î½Î¿
  return list.map(c => {
    const paid = allocationSumForCharge(c.id);
    const remain = ((+c.amount)||0) - ((+paid)||0);
    return {...c, remain: remain};
  }).filter(c => c.remain > 0.0001) // Î¼ÏŒÎ½Î¿ ÏŒÏƒÎµÏ‚ Î­Ï‡Î¿Ï…Î½ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿
    .sort((a,b) => (a.ym||'').localeCompare(b.ym||'') || (a.type||'').localeCompare(b.type||''));
}

// Î¦Ï„Î¹Î¬Ï‡Î½ÎµÎ¹ Ï„Î¿ UI Ï„Ï‰Î½ allocations. Î‘Î½ Î´Î¿Î¸ÎµÎ¯ paymentId, Ï€ÏÎ¿-Î³ÎµÎ¼Î¯Î¶ÎµÎ¹ Î±Ï€ÏŒ Ï…Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎµÏ‚ allocations.
function buildAllocationUI(paymentId=null){
  const charges = getOpenChargesForEnrollment();
  const payAmt  = parseFloat(pf.amount.value || '0') || 0;

  allocPayAmount.textContent = payAmt.toFixed(2)+'â‚¬';

  if (!charges.length) {
    allocTbody.innerHTML = `<tr><td colspan="5" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚.</td></tr>`;
    allocSum.textContent = '0.00â‚¬';
    allocRest.textContent= payAmt.toFixed(2)+'â‚¬';
    return;
  }

  // Î§Î¬ÏÏ„Î·Ï‚ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Ï‰Î½ allocations (Î³Î¹Î± edit)
  const prev = {};
  if (paymentId) {
    allocDB.all().filter(a => a.paymentId === paymentId).forEach(a => { prev[a.chargeId] = (+a.amount)||0; });
  }

  allocTbody.innerHTML = charges.map(c => {
    const monthTxt = `${c.monthLabel||''} ${(c.ym||'').slice(0,4)}`;
    const prevAmount = prev[c.id] || 0;
    const max = Math.max(0, c.remain + prevAmount); // Î±Î½ ÎµÎ¯Ï‡Î±Î¼Îµ Ï€Î±Î»Î¹ÏŒ allocation, ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ Î¼Î­Ï‡ÏÎ¹ remain+Ï€Î±Î»Î¹ÏŒ
    return `<tr data-charge-id="${c.id}">
      <td>${monthTxt}</td>
      <td>${c.description||''}</td>
      <td class="money">${(c.remain).toFixed(2)}â‚¬</td>
      <td><input class="allocAmount" type="number" step="0.01" min="0" max="${max.toFixed(2)}" value="${prevAmount ? prevAmount.toFixed(2) : ''}" placeholder="0.00"></td>
    </tr>`;
  }).join('');

  recomputeAllocationTotals();
}

// Î¥Ï€Î¿Î»Î¿Î³Î¯Î¶ÎµÎ¹ ÏƒÏÎ½Î¿Î»Î¿ & Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿
function recomputeAllocationTotals(){
  const payAmt = parseFloat(pf.amount.value || '0') || 0;
  const inputs = [...allocTbody.querySelectorAll('.allocAmount')];
  const sum = inputs.reduce((s,inp)=> s + (parseFloat(inp.value||'0')||0), 0);
  allocSum.textContent = sum.toFixed(2)+'â‚¬';
  const rest = Math.max(0, payAmt - sum);
  allocRest.textContent = rest.toFixed(2)+'â‚¬';
}

// Auto-FIFO: Î¼Î¿Î¹ÏÎ¬Î¶ÎµÎ¹ Ï„Î¿ Ï€Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î±Ï€ÏŒ Ï„Î¿Î½ Ï€Î±Î»Î±Î¹ÏŒÏ„ÎµÏÎ¿ Î¼Î®Î½Î±
function autoFIFO(){
  const payAmt = parseFloat(pf.amount.value || '0') || 0;
  if (payAmt <= 0) { recomputeAllocationTotals(); return; }

  // Î Î¬ÏÎµ Ï„Î¹Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚ Î¼Îµ ÏƒÎµÎ¹ÏÎ¬
  const rows = [...allocTbody.querySelectorAll('tr[data-charge-id]')];
  let remaining = payAmt;
  rows.forEach(tr => {
    const max = parseFloat(tr.querySelector('.allocAmount').getAttribute('max') || '0') || 0;
    const put = Math.min(max, remaining);
    tr.querySelector('.allocAmount').value = put ? put.toFixed(2) : '';
    remaining -= put;
  });
  recomputeAllocationTotals();
}

// ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï€Î¿ÏƒÏÎ½
function clearAllocationsUI(){
  [...allocTbody.querySelectorAll('.allocAmount')].forEach(inp => inp.value='');
  recomputeAllocationTotals();
}

// ====== Mass Payment logic ======

// Î¦Î­ÏÎ½ÎµÎ¹ Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± ÎŸÎ›Î•Î£ Ï„Î¹Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Ï„Î¿Ï… Î¼Î±Î¸Î·Ï„Î®, Ï†Î¹Î»Ï„ÏÎ±ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚
function getOpenChargesForStudent() {
  if (!selectedStudentId) return [];

  // --- caches (Î»Î¹Î³ÏŒÏ„ÎµÏÎ± .all())
  const allCharges = chargeDB.all();
  const allEnrolls = enrDB.all();

  // 1) ÏŒÎ»ÎµÏ‚ Î¿Î¹ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Ï„Î¿Ï… Î¼Î±Î¸Î·Ï„Î®
  let list = allCharges.filter(c => c.studentId === selectedStudentId);

  // 2) ÎºÏÎ¬Ï„Î± Î¼ÏŒÎ½Î¿ Î­Î³ÎºÏ…ÏÎµÏ‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Î® Î³ÎµÎ½Î¹ÎºÎ­Ï‚ (enrollmentId=null)
  if (allEnrolls.length) {
    const enrIds = new Set(allEnrolls.map(e => e.id));
    list = list.filter(c => !c.enrollmentId || enrIds.has(c.enrollmentId));
  }

  // 3) Ï†Î¯Î»Ï„ÏÎ¿ Î±ÎºÎ±Î´Î·Î¼Î±ÏŠÎºÎ¿Ï Î­Ï„Î¿Ï…Ï‚
  if (yearFilter.value) {
    const y = yearFilter.value;
    list = list.filter(c => c.year === y);
  }

  // 4) Ï†Î¯Î»Ï„ÏÎ¿ Î£Î¥Î“ÎšÎ•ÎšÎ¡Î™ÎœÎ•ÎÎŸÎ¥ Î¼Î®Î½Î± (1..12) Î±Ï€ÏŒ Ï„Î¿ dropdown
  const want = parseInt(mp?.month?.value || '0', 10);
  if (want >= 1 && want <= 12) {
    list = list.filter(c => {
      // ym: 'YYYY-MM' -> Ï€Î¬ÏÎµ MM Î³ÏÎ®Î³Î¿ÏÎ±
      const mm = parseInt(String(c.ym || '').slice(5, 7) || '0', 10);
      return mm === want;
    });
  } else {
    // Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î´Î¹Î±Î»ÎµÎ³ÎµÎ¯ Î¼Î®Î½Î±Ï‚ -> Î¬Î´ÎµÎ¹Î±ÏƒÎ¼Î± Î»Î¯ÏƒÏ„Î±Ï‚ (ÏƒÏ…Î¼Ï€ÎµÏÎ¹Ï†Î¿ÏÎ¬ Ï€Î¿Ï… Î¶Î®Ï„Î·ÏƒÎµÏ‚)
    return [];
  }

  // 5) Ï…Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ ÎºÎ±Î¹ ÎºÏÎ¬Ï„Î± Î¼ÏŒÎ½Î¿ Î¸ÎµÏ„Î¹ÎºÎ¬
  const result = list.map(c => {
    const paid = allocationSumForCharge(c.id);
    const remain = ((+c.amount) || 0) - ((+paid) || 0);
    return { ...c, remain };
  }).filter(c => c.remain > 0.0001)
    .sort((a, b) =>
      String(a.ym || '').localeCompare(String(b.ym || '')) ||
      String(a.type || '').localeCompare(String(b.type || ''))
    );

  return result;
}

function updateMassDiscountRows(){
  // ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Ï€Î±Î»Î¹Î­Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚ Î­ÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚
  [...massAllocTbody.querySelectorAll('tr.row-discount-total')].forEach(tr => tr.remove());

  const discount = parseFloat(massDiscountInput?.value || '0') || 0;
  if (discount <= 0) return;

  // Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Î¼Î¹Î± ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î±ÏÎ½Î·Ï„Î¹ÎºÎ® Î³ÏÎ±Î¼Î¼Î®
  const row = document.createElement('tr');
  row.className = 'row-discount-total';
  row.innerHTML = `
    <td></td>
    <td class="muted">â†³ ÎˆÎºÏ€Ï„Ï‰ÏƒÎ· (Î¼Î±Î¶Î¹ÎºÎ®)</td>
    <td></td>
    <td class="money neg">-${discount.toFixed(2)}â‚¬</td>
    <td></td>
  `;
  massAllocTbody.appendChild(row);
}

function getMassUIState(){
  const state = {};
  [...massAllocTbody.querySelectorAll('tr[data-charge-id]')].forEach(tr => {
    const id  = tr.dataset.chargeId;
    const chk = tr.querySelector('.mass-alloc-check');
    const inp = tr.querySelector('.massAllocAmount');
    if (!id) return;
    state[id] = {
      checked: !!(chk && chk.checked),
      value: inp && !inp.disabled ? (parseFloat(inp.value || '0') || 0) : 0
    };
  });
  return state;
}

function buildMassAllocationUI(){
  const prev    = getMassUIState();           // snapshot Ï€ÏÎ¹Î½ Ï„Î¿ rebuild
  const charges = getOpenChargesForStudent();
  const payAmt  = parseFloat(mp.amount.value || '0') || 0;
  massAllocPayAmount.textContent = payAmt.toFixed(2)+'â‚¬';

if (!charges.length) {
  massAllocTbody.innerHTML = `<tr><td colspan="5" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚.</td></tr>`;

  // âœ… ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Ï€Î¿ÏƒÏŒ & footer & Î­ÎºÏ€Ï„Ï‰ÏƒÎ·
  if (mp?.amount) mp.amount.value = '';
  if (massDiscountInput) massDiscountInput.value = '';

  massAllocPayAmount.textContent = '0.00â‚¬';
  massAllocSum.textContent  = '0.00â‚¬';
  massAllocRest.textContent = '0.00â‚¬';

  mp.saveBtn.disabled = true;
  return;
}


  const plan = computeMassDiscountPlan(massDiscountInput?.value);

  massAllocTbody.innerHTML = charges.map(c => {
    const max     = Math.max(0, c.remain);
    const was     = prev[c.id];
    const checked = was ? was.checked : true;

    const share      = plan?.[c.id] || 0;                    // Î¼ÎµÏÎ¯Î´Î¹Î¿ Î­ÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚ Î³Î¹Î± Ï„Î· Ï‡ÏÎ­Ï‰ÏƒÎ·
    const suggested  = Math.max(0, round2(max - share));     // Ï€Î»Î®ÏÎ·Ï‚ Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î­ÎºÏ€Ï„Ï‰ÏƒÎ·
    const val        = was ? was.value : suggested;          // âœ… Î§Î¡Î—Î£Î— suggested ÏŒÏ„Î±Î½ Î´ÎµÎ½ Ï…Ï€Î®ÏÏ‡Îµ Ï€ÏÎ¹Î½

    const monthTxt = `${c.monthLabel || ''} ${(c.ym||'').slice(0,4)}`;

    let html = `
      <tr data-charge-id="${c.id}">
        <td><input type="checkbox" class="mass-alloc-check" ${checked ? 'checked' : ''}></td>
        <td>${monthTxt}</td>
        <td>${c.description || ''}</td>
        <td class="money">${c.remain.toFixed(2)}â‚¬</td>
        <td>
          <input class="massAllocAmount" type="number" step="0.01" min="0" readonly
                 max="${max.toFixed(2)}"
                 data-default="${suggested.toFixed(2)}"           
                 value="${checked ? val.toFixed(2) : ''}"          
                 ${checked ? '' : 'disabled'}
                 placeholder="0.00">
        </td>
      </tr>
    `;

    // Ï…Ï€Î¿-Î³ÏÎ±Î¼Î¼Î® Î­ÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î¼ÎµÏÎ¯Î´Î¹Î¿
    if (share > 0) {
      html += `
        <tr class="row-discount" data-charge-id="${c.id}">
          <td></td>
          <td class="muted">â†³ ÎˆÎºÏ€Ï„Ï‰ÏƒÎ· (Î¼Î±Î¶Î¹ÎºÎ®)</td>
          <td></td>
          <td class="money neg">-${share.toFixed(2)}â‚¬</td>
          <td></td>
        </tr>
      `;
    }
    return html;
  }).join('');

  mp.saveBtn.disabled = false;
  recomputeMassTotals(); // Î¸Î± ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¯ÏƒÎµÎ¹ ÎºÎ±Î¹ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿ Ï€Î¿ÏƒÏŒ
}


function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }

function recomputeMassTotals(){
  // 1) Î£ÏÎ½Î¿Î»Î¿ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚ = Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± remain Ï„Ï‰Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½
  let gross = 0;
  const rows = [...massAllocTbody.querySelectorAll('tr[data-charge-id]')];
  if (!rows.length) {
    if (mp?.amount) mp.amount.value = '';
    const set = (sel,val)=>{ const n=document.querySelector(sel); if(n) n.textContent=val; };
    set('#massAllocSum','0.00â‚¬'); set('#massAllocRest','0.00â‚¬'); set('#massAllocPayAmount','0.00â‚¬');
    if (mp?.saveBtn) mp.saveBtn.disabled = true;
    return { base: 0, discount: 0, total: 0 };
  }

  rows.forEach(tr => {
    const chk = tr.querySelector('.mass-alloc-check');
    if (!chk || !chk.checked) return;
    const max = parseFloat(tr.querySelector('.massAllocAmount')?.getAttribute('max') || '0') || 0;
    gross += max;
  });

gross = round2(gross);
let disc  = round2(Math.max(0, parseFloat(massDiscountInput?.value || '0') || 0));
let final = round2(Math.max(0, gross - disc)); // Ï„ÎµÎ»Î¹ÎºÏŒ Ï€Î¿ÏƒÏŒ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚ Î³Î¹Î± Î•ÎœÎ¦Î‘ÎÎ™Î£Î—

// 2) Footer: Î´ÎµÎ¯Î¾Îµ gross, disc, final
const set = (sel, val) => { const n = document.querySelector(sel); if (n) n.textContent = val; };
set('#massAllocSum',       gross.toFixed(2) + 'â‚¬'); // Î£ÏÎ½Î¿Î»Î¿ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚
set('#massAllocRest',      disc.toFixed(2)  + 'â‚¬'); // ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·
set('#massAllocPayAmount', final.toFixed(2) + 'â‚¬'); // Î¤ÎµÎ»Î¹ÎºÏŒ Ï€Î¿ÏƒÏŒ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚ (Î³Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·)

// 3) Input Ï€Î¿ÏƒÎ¿Ï: ÎœÎ•ÎÎ•Î™ = gross (ÏÏƒÏ„Îµ Î· Ï€Î»Î·ÏÏ‰Î¼Î® Î½Î± Î¼Î·Î½ â€œÎºÏŒÎ²ÎµÎ¹â€ Ï„Î·Î½ Î­ÎºÏ€Ï„Ï‰ÏƒÎ·)
if (mp?.amount) mp.amount.value = gross.toFixed(2);

// 4) Enable/disable
if (mp?.saveBtn) mp.saveBtn.disabled = !(final > 0);

return { base: gross, discount: disc, final };
}

function addDiscountToCharge(chargeId, {amount, note='ÎœÎ±Î¶Î¹ÎºÎ® Î­ÎºÏ€Ï„Ï‰ÏƒÎ·', type='bulk'}){
  const all = chargeDB.all();
  const i = all.findIndex(c=>c.id===chargeId);
  if (i<0) return;
  const c = all[i];
  if (!Array.isArray(c.discounts)) c.discounts = [];
  c.discounts.push({ id: uid(), type, amount: +amount||0, note, dateApplied: new Date().toISOString().slice(0,10) });
  all[i] = c; chargeDB.save(all);
}

function resetMassInputs(){
  if (mp?.amount) mp.amount.value = '';
  if (massDiscountInput) massDiscountInput.value = '';
  // ÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎµ ÎºÎ±Î¹ Ï„Î¹Ï‚ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚
  [...massAllocTbody.querySelectorAll('.massAllocAmount')].forEach(inp => inp.value='');
  // Î¼Î·Î´Î­Î½Î¹ÏƒÎµ footer
  const set = (sel,val)=>{ const n=document.querySelector(sel); if(n) n.textContent=val; };
  set('#massAllocSum','0.00â‚¬');
  set('#massAllocRest','0.00â‚¬');
  set('#massAllocPayAmount','0.00â‚¬');
  recomputeMassTotals();
}

function massAutoFIFO(){
  const payAmt = parseFloat(mp.amount.value || '0') || 0;
  if (payAmt <= 0) { recomputeMassTotals(); return; }

  const rows = [...massAllocTbody.querySelectorAll('tr[data-charge-id]')];
  let remaining = payAmt;

  rows.forEach(tr => {
    const chk = tr.querySelector('.mass-alloc-check');
    const inp = tr.querySelector('.massAllocAmount');
    const max = parseFloat(inp.getAttribute('max') || '0') || 0;

    if (!chk.checked) { inp.value = ''; return; }

    const put = Math.min(max, remaining);
    inp.value = put ? put.toFixed(2) : '';
    remaining -= put;
  });

  recomputeMassTotals();
}

function clearMassAllocUI(){
  [...massAllocTbody.querySelectorAll('.massAllocAmount')].forEach(inp => inp.value='');
  recomputeMassTotals();
}

function computeMassDiscountPlan(totalDisc) {
  totalDisc = Math.max(0, +totalDisc || 0);
  if (totalDisc <= 0) return {};

  // Î’ÏÎµÏ‚ Ï„Î¹Ï‚ Î•Î Î™Î›Î•Î“ÎœÎ•ÎÎ•Î£ Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î¿ UI
  const rows = [...massAllocTbody.querySelectorAll('tr[data-charge-id]')];
  const items = rows.map(tr => {
    const chk = tr.querySelector('.mass-alloc-check');
    const inp = tr.querySelector('.massAllocAmount');
    if (!chk || !chk.checked || !inp || inp.disabled) return null;

    const chargeId = tr.dataset.chargeId;
    const remain   = parseFloat(inp.getAttribute('max') || '0') || 0; // Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚
    return remain > 0 ? { tr, chargeId, remain } : null;
  }).filter(Boolean);

  if (!items.length) return {};

  const totalRemain = items.reduce((s,x)=> s + x.remain, 0);
  let left = Math.min(totalDisc, totalRemain);

  // pro-rata Î¼Î¿Î¹ÏÎ±ÏƒÎ¹Î¬, Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Ï‡ÏÎ­Ï‰ÏƒÎ· Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Î³Î¹Î± ÏƒÎµÎ½Ï„Ï‚
  const plan = {};
  items.forEach((x, i) => {
    if (left <= 0) return;
    let share = Math.round((x.remain / totalRemain) * totalDisc * 100) / 100;
    if (i === items.length - 1) share = left;
    share = Math.min(share, x.remain);
    if (share > 0) {
      plan[x.chargeId] = share;
      left -= share;
    }
  });
  return plan; // {chargeId: amount, ...}
}

// Events Ï„Î¿Ï… panel
allocAutoBtn?.addEventListener('click', autoFIFO);
allocClearBtn?.addEventListener('click', clearAllocationsUI);

// Recompute ÏŒÏ„Î±Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¿ Ï€Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î® Î¿Î¹ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚
pf.amount.addEventListener('input', () => { buildAllocationUI(pf.id.value || null); });
allocTbody?.addEventListener('input', e => { if (e.target.classList.contains('allocAmount')) recomputeAllocationTotals(); });


function disablePaymentForm(disabled){
[pf.date,pf.month,pf.amount,pf.method,pf.reason,pf.notes, el('#paySaveBtn')]
  .forEach(x => { if (x) x.disabled = disabled; });
  payNewBtn.disabled=disabled || !selectedEnrollmentId;
  
  if(disabled){ payForm.reset(); pf.id.value=''; }
}
function clearPayForm(){
  payForm.reset(); pf.id.value='';
  payFormTitle.textContent='ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î Î»Î·ÏÏ‰Î¼Î®Ï‚';
  if (pf.batchId) pf.batchId.value = ''; // â† ÎÎ•ÎŸ
}
el('#payClearBtn').addEventListener('click',clearPayForm);

// Open/Close modal
payNewBtn.addEventListener('click', ()=>{
  if(!selectedEnrollmentId){ alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ³Î³ÏÎ±Ï†Î® Î±Ï€ÏŒ Ï„Î¿ tab Î•Î³Î³ÏÎ±Ï†Î­Ï‚.'); return; }
  disablePaymentForm(false);   // âœ… Ï€ÏÎ¿Î»Î·Ï€Ï„Î¹ÎºÏŒ enable Ï„Î·Ï‚ Ï†ÏŒÏÎ¼Î±Ï‚
  clearPayForm();
  buildAllocationUI(null); // â† ÎÎ•ÎŸ
  // ÎÎ­Î± Ï€Î»Î·ÏÏ‰Î¼Î® â†’ editable panel on, read-only off
if (allocRoPanel) allocRoPanel.style.display = 'none';
if (allocPanel)   allocPanel.style.display   = '';
const paySaveBtn = document.getElementById('paySaveBtn');
if (paySaveBtn) paySaveBtn.disabled = false;

if (payActions) payActions.style.display = '';   // Î´ÎµÎ¯Î¾Îµ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬

// Î´ÎµÎ¯Î¾Îµ ÎœÎ®Î½Î± & Î£Ï‡ÏŒÎ»Î¹Î±, ÎµÎ½ÎµÏÎ³ÏŒ dropdown, actions on
if (payMonthWrap) payMonthWrap.style.display = '';
if (payNotesWrap) payNotesWrap.style.display = '';
if (pf.month) pf.month.disabled = false;
if (payActions) payActions.style.display = '';

// read-only panel off, editable allocations on
if (typeof allocRoPanel !== 'undefined' && allocRoPanel) allocRoPanel.style.display = 'none';
if (typeof allocPanel   !== 'undefined' && allocPanel)   allocPanel.style.display   = '';


openModal(payModal);
});

payClose.addEventListener('click',()=>closeModal(payModal));
payModal.addEventListener('click',e=>{ if(e.target===payModal) closeModal(payModal); });

function renderPayments(){
  payYearEcho.textContent = yearFilter.value || 'â€”';
  let list=payDB.all();
  if(selectedStudentId) list=list.filter(p=>p.studentId===selectedStudentId);
  const y=yearFilter.value; if(y) list=list.filter(p=>p.year===y);
  
function inferPaymentMonthName(paymentId){
  const allocs = allocDB.all().filter(a => a.paymentId === paymentId);
  if (!allocs.length) return '';
  const chargesById = Object.fromEntries(chargeDB.all().map(c => [c.id, c]));
  // Ï€Î¬ÏÎµ Ï„Î·Î½ Ï€ÏÏÏ„Î· (ÏŒÎ»ÎµÏ‚ Ï€Î»Î­Î¿Î½ ÎµÎ¯Î½Î±Î¹ Î¯Î´Î¹Î¿Ï… Î¼Î®Î½Î±)
  const c = chargesById[allocs[0].chargeId];
  return c?.monthLabel || '';
}

payTblBody.innerHTML = list.map(p => `
  <tr data-id="${p.id}" class="${p.id===selectedPaymentId ? 'active' : ''}">
    <td class="sel">
      <input type="radio" class="paySelect" name="paySelect"
             data-id="${p.id}" ${p.id===selectedPaymentId ? 'checked' : ''}>
    </td>
    <td>${fmtDate(p.date)}</td>
    <td>${p.month || inferPaymentMonthName(p.id) || ''}</td>
    <td>${(+p.amount||0).toFixed(2)}â‚¬</td>
    <td>${p.method||''}</td>
    <td><button class="btn light payViewBtn" data-id="${p.id}">Î ÏÎ¿Î²Î¿Î»Î®</button></td>
  </tr>`).join('');

if (selectedPaymentId && !list.some(x => x.id === selectedPaymentId)) {
  selectedPaymentId = null;
payReceiptBtn.disabled = true;    
payDelBtn.disabled = true;
}

  const total=list.reduce((a,b)=>a+(+b.amount||0),0);
  sumTotal.textContent=total.toFixed(2)+'â‚¬';
  sumCount.textContent=String(list.length);
  const last=list.slice().sort((a,b)=>new Date(b.date||0)-new Date(a.date||0))[0];
  sumLast.textContent=last?fmtDate(last.date):'â€”';

  payDelBtn.disabled=true;
  payNewBtn.disabled=!selectedEnrollmentId;
}

payForm.addEventListener('submit', e => {
  e.preventDefault();
  if (!selectedEnrollmentId || !selectedStudentId) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ³Î³ÏÎ±Ï†Î®.'); return; }

  const rec = {
    id: pf.id.value || uid(),
    studentId: selectedStudentId,
    enrollmentId: selectedEnrollmentId,
    date: pf.date.value || new Date().toISOString().slice(0,10),
    month: pf.month?.value || '',
    amount: parseFloat(pf.amount.value || '0'),
    method: pf.method.value || '',
    reason: pf.reason.value || '',
    notes: (pf.notes?.value || '').trim(),
    year: yearFilter.value || academicYearFromDate(new Date()),
    updated_at: new Date().toISOString()
  };

  if (!(rec.amount > 0)) { alert('Î”ÏÏƒÎµ Î­Î³ÎºÏ…ÏÎ¿ Ï€Î¿ÏƒÏŒ (>0).'); return; }

  // === VALIDATION allocations ===
  // Î†Î¸ÏÎ¿Î¹ÏƒÎ¼Î± ÎºÎ±Ï„Î±Î½Î¿Î¼ÏÎ½ Î´ÎµÎ½ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¾ÎµÏ€ÎµÏÎ½Î¬ Ï„Î¿ Ï€Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚
  const allocInputs = [...allocTbody.querySelectorAll('.allocAmount')];
  let sumAlloc = allocInputs.reduce((s,inp)=> s + (parseFloat(inp.value||'0')||0), 0);
  if (sumAlloc > rec.amount + 0.0001) {
    alert('ÎŸÎ¹ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ Î¾ÎµÏ€ÎµÏÎ½Î¿ÏÎ½ Ï„Î¿ Ï€Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.');
    return;
  }

  // Save Payment
  payDB.upsert(rec);
  pf.id.value = rec.id;
  payFormTitle.textContent = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î Î»Î·ÏÏ‰Î¼Î®Ï‚';

  // === Save Allocations (replace all for this payment) ===
  const all = allocDB.all().filter(a => a.paymentId !== rec.id); // drop Ï€Î±Î»Î¹Î­Ï‚ Ï„Î¿Ï… Î¯Î´Î¹Î¿Ï… payment
  const newAllocs = [];
  allocInputs.forEach(inp => {
    const amt = parseFloat(inp.value||'0') || 0;
    if (amt <= 0) return;
    const tr = inp.closest('tr');
    const chargeId = tr?.dataset?.chargeId;
    if (!chargeId) return;
    newAllocs.push({
      id: uid(),
      paymentId: rec.id,
      chargeId,
      amount: amt,
      created_at: new Date().toISOString()
    });
  });
  allocDB.save(all.concat(newAllocs));

  renderPayments();
  renderCharges();  // â† ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· grid Ï‡ÏÎµÏÏƒÎµÏ‰Î½/Ï…Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½
  closeModal(payModal);
});

payTblBody.addEventListener('click', e => {
  if (!e.target.classList.contains('payViewBtn')) return;

  const id  = e.target.dataset.id;
  const rec = payDB.all().find(x => x.id === id);
  if (!rec) return;

  selectedPaymentId = id;

  // Î“Î­Î¼Î¹ÏƒÎ¼Î± Ï†ÏŒÏÎ¼Î±Ï‚
  pf.id.value     = rec.id;
  pf.date.value   = toISO(rec.date);
 if (pf.month) pf.month.value = rec.month || '';
  pf.amount.value = rec.amount;
  pf.method.value = rec.method || '';
  pf.reason.value = rec.reason || '';
if (pf.notes) pf.notes.value = rec.notes || '';

  if (pf.batchId) pf.batchId.value = rec.batchId || '';

  payFormTitle.textContent = 'Î ÏÎ¿Î²Î¿Î»Î® Î Î»Î·ÏÏ‰Î¼Î®Ï‚';

  // Visual ÎµÏ€Î¹Î»Î¿Î³Î® ÏƒÏ„Î· Î³ÏÎ±Î¼Î¼Î® + radio
  const tr = e.target.closest('tr');
  [...payTblBody.children].forEach(r => r.classList.remove('active'));
  tr.classList.add('active');
  const rb = tr.querySelector('.paySelect');
  if (rb) rb.checked = true;
payReceiptBtn.disabled = false;
  payDelBtn.disabled = false;
  disablePaymentForm(false);

  // === Toggle UI Î±Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î¿ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î¼Î±Î¶Î¹ÎºÎ® (Î­Ï‡ÎµÎ¹ batchId) ===
  if (rec.batchId) {
    // ÎšÏÏÏˆÎµ ÎœÎ®Î½Î± & Î£Ï‡ÏŒÎ»Î¹Î± (read-only modal)
    if (payMonthWrap) payMonthWrap.style.display = 'none';
    if (payNotesWrap) payNotesWrap.style.display = 'none';
    if (pf.month) pf.month.disabled = true;

    // ÎšÏÏÏˆÎµ actions (Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·/ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚)
    if (payActions) payActions.style.display = 'none';

    // Allocations: Î±Ï€ÏŒÎºÏÏ…ÏˆÎ· editable, ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· read-only
    if (typeof allocPanel !== 'undefined' && allocPanel) allocPanel.style.display = 'none';
    if (typeof allocRoPanel !== 'undefined' && allocRoPanel) {
      allocRoPanel.style.display = 'block';
      renderAllocationsForPayment(rec.id, rec);
    }
  } else {
    // ÎšÎ±Î½Î¿Î½Î¹ÎºÎ® Ï€Î»Î·ÏÏ‰Î¼Î®: Î´ÎµÎ¯Î¾Îµ ÏŒÎ»Î± ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬
    if (payMonthWrap) payMonthWrap.style.display = '';
    if (payNotesWrap) payNotesWrap.style.display = '';
    if (pf.month) pf.month.disabled = false;

    if (payActions) payActions.style.display = '';

    if (typeof allocRoPanel !== 'undefined' && allocRoPanel) allocRoPanel.style.display = 'none';
    if (typeof allocPanel   !== 'undefined' && allocPanel) {
      allocPanel.style.display = '';
      buildAllocationUI(rec.id);
    }
  }

  openModal(payModal);
});

payTblBody.addEventListener('click', e => {
  const tr = e.target.closest('tr'); 
  if (!tr) return;

  // Î‘Î½ Ï€Î¬Ï„Î·ÏƒÎµÏ‚ "Î ÏÎ¿Î²Î¿Î»Î®" Î® Ï„Î¿ radio, Î¼Î·Î½ ÎºÎ¬Î½ÎµÎ¹Ï‚ Ï„Î¯Ï€Î¿Ï„Î± ÎµÎ´Ï
  if (e.target.classList.contains('payViewBtn') || e.target.classList.contains('paySelect')) return;

  selectedPaymentId = tr.dataset.id;

  // visual + Ï„ÏƒÎ­ÎºÎ±ÏÎµ Ï„Î¿ radio
  [...payTblBody.children].forEach(r => r.classList.remove('active'));
  tr.classList.add('active');
  const rb = tr.querySelector('.paySelect');
  if (rb) rb.checked = true;
payReceiptBtn.disabled = false;
  payDelBtn.disabled = false;
  // Î´ÎµÎ½ Î±Î½Î¿Î¯Î³Î¿Ï…Î¼Îµ modal ÎµÎ´Ï
});

payTblBody.addEventListener('change', e => {
  if (!e.target.classList.contains('paySelect')) return;
  const id = e.target.dataset.id;
  selectedPaymentId = id;

  // visual highlight
  [...payTblBody.children].forEach(r => r.classList.remove('active'));
  e.target.closest('tr').classList.add('active');
payReceiptBtn.disabled = false;
  payDelBtn.disabled = false;   // ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯ Î”Î¹Î±Î³ÏÎ±Ï†Î® Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·
  // Î´ÎµÎ½ Î±Î½Î¿Î¯Î³Î¿Ï…Î¼Îµ modal ÎµÎ´Ï
});

payDelBtn.addEventListener('click', () => {
  if (!selectedPaymentId) return;

  const allPays = payDB.all();
  const rec = allPays.find(p => p.id === selectedPaymentId);
  if (!rec) return;

  const isBatch = !!rec.batchId;
  const msg = isBatch
    ? `Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎœÎ‘Î–Î™ÎšÎ—Î£ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚;\nBatch: ${rec.batchId}\n\nÎ˜Î± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î· Ï€Î»Î·ÏÏ‰Î¼Î® ÎºÎ±Î¹ ÎŸÎ›Î•Î£ Î¿Î¹ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ Ï„Î·Ï‚.`
    : `Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚;\nÎ˜Î± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î· Ï€Î»Î·ÏÏ‰Î¼Î® ÎºÎ±Î¹ Î¿Î¹ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ Ï„Î·Ï‚.`;

  if (!confirm(msg)) return;

  // 1) ÏƒÎ²Î®ÏƒÎµ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚
  const remainAlloc = allocDB.all().filter(a => a.paymentId !== rec.id);
  allocDB.save(remainAlloc);

  // 2) ÏƒÎ²Î®ÏƒÎµ Ï„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î®
  const remainPays = allPays.filter(p => p.id !== rec.id);
  payDB.save(remainPays);

  // 3) UI reset
  selectedPaymentId = null;
payReceiptBtn.disabled = true;  
payDelBtn.disabled = true;
  if (payModal && payModal.classList.contains('open')) closeModal(payModal);

  // 4) refresh Ï€Î¹Î½Î¬ÎºÏ‰Î½/Ï…Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½
  renderPayments();
  renderCharges();
});

delBtn.addEventListener('click', () => {
  if (!selectedStudentId) return;
  const s = db.all().find(x => x.id === selectedStudentId);
  if (confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï„Î¿Ï…/Ï„Î·Ï‚ ${s.surname} ${s.name}; Î˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ ÎµÏ€Î¯ÏƒÎ·Ï‚ ÏŒÎ»ÎµÏ‚ Î¿Î¹ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚, Ï€Î»Î¬Î½Î±, Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚, Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ Îº.Î»Ï€.`)) {
    // Students
    db.remove(selectedStudentId);

    // Enrollments & Payments
    const remainEnr = enrDB.all().filter(e => e.studentId !== selectedStudentId); enrDB.save(remainEnr);
    const remainPay = payDB.all().filter(p => p.studentId !== selectedStudentId);  payDB.save(remainPay);

    // Plans
    const remainPlans = planDB.all().filter(pl => pl.studentId !== selectedStudentId); planDB.save(remainPlans);

    // Charges
    const remainCharges = chargeDB.all().filter(c => c.studentId !== selectedStudentId); chargeDB.save(remainCharges);

    // Allocations (ÎºÏÎ±Ï„Î¬Î¼Îµ Î¼ÏŒÎ½Î¿ ÏŒÏƒÎ± Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î½ ÏƒÎµ EXISTING payments & charges)
    const existingPayments = new Set(payDB.all().map(p => p.id));
    const existingCharges  = new Set(chargeDB.all().map(c => c.id));
    const remainAlloc = allocDB.all().filter(a => existingPayments.has(a.paymentId) && existingCharges.has(a.chargeId));
    allocDB.save(remainAlloc);

    // Exams
    const remainExams = examDB.all().filter(ex => ex.studentId !== selectedStudentId); examDB.save(remainExams);

    // Documents
    const remainDocs = docDB.all().filter(d => d.studentId !== selectedStudentId); docDB.save(remainDocs);

    clearStudentForm();
    renderStudents(q.value);
    renderEnrollments();
    renderPayments();
    renderCharges();
  }
});

// Î†Î½Î¿Î¹Î³Î¼Î± Mass Modal
massPayBtn?.addEventListener('click', ()=>{
  if (!selectedStudentId) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼Î±Î¸Î·Ï„Î® Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î± Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬.'); return; }
  // defaults
mp._batchId = genBatchId();           // â† ÎÎ•ÎŸ: Ï†ÏÎ­ÏƒÎºÎ¿ batch Î±Î½Î¬ Î¬Î½Î¿Î¹Î³Î¼Î±  
mp.date.value = new Date().toISOString().slice(0,10);
  mp.amount.value = '';
  mp.amount.readOnly = true;   // âœ… ÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Ï€Î¿ÏƒÎ¿Ï
  mp.method.value = 'ÎœÎµÏ„ÏÎ·Ï„Î¬';
  mp.reason.value = 'ÎœÎ±Î¶Î¹ÎºÎ® ÎµÎ¾ÏŒÏ†Î»Î·ÏƒÎ· Î´Î¹Î´Î¬ÎºÏ„ÏÏ‰Î½';

  fillMonthSelect(mp.month);
 // Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®: Ï„ÏÎ­Ï‡Ï‰Î½ Î¼Î®Î½Î±Ï‚ (1..12)
 mp.month.value = (new Date().getMonth() + 1).toString();
 
  // âœ… ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚ Ï„Î¿Ï… massDiscountInput
  const discountInput = document.getElementById('massDiscountInput');
  if (discountInput) discountInput.value = '';
  resetMassInputs();
  buildMassAllocationUI();
  openModal(massPayModal);
});

massPayClose?.addEventListener('click', ()=> closeModal(massPayModal));
massPayModal?.addEventListener('click', e => { if (e.target === massPayModal) closeModal(massPayModal); });


 mp.amount.addEventListener('input', () => {
   const payAmt = parseFloat(mp.amount.value || '0') || 0;
   massAllocPayAmount.textContent = payAmt.toFixed(2) + 'â‚¬';
   recomputeMassTotals();
});

mp.month.addEventListener('change', ()=>{
  // Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬: Î±Î½ Î­Ï‡ÎµÎ¹Ï‚ Î®Î´Î· resetMassInputs(), ÎºÎ¬Î»ÎµÏƒÎ­ Ï„Î¿ ÎµÎ´Ï
  if (typeof resetMassInputs === 'function') resetMassInputs();
  buildMassAllocationUI();
});


massAllocTbody?.addEventListener('input', e => {
  if (e.target.classList.contains('massAllocAmount')) {
    recomputeMassTotals();
  }
});

// Ï€Î¿ÏƒÏŒ Î³ÏÎ±Î¼Î¼Î®Ï‚
massAllocTbody.addEventListener('input', (e) => {
  if (e.target && e.target.classList.contains('massAllocAmount')) {
    recomputeMassTotals();
  }
});

// ÎµÏ€Î¹Î»Î¿Î³Î®/Î±Ï€Î¿ÎµÏ€Î¹Î»Î¿Î³Î® Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚
massAllocTbody.addEventListener('change', (e) => {
  if (e.target && e.target.classList.contains('mass-alloc-check')) {
    // (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ) Î±Î½ Î¾Îµ-Ï„ÏƒÎµÎºÎ¬ÏÎµÎ¹Ï‚, Î¼Î·Î´Î­Î½Î¹ÏƒÎµ Ï„Î¿ Ï€Î¿ÏƒÏŒ Ï„Î·Ï‚ Î³ÏÎ±Î¼Î¼Î®Ï‚ Î³Î¹Î± ÎºÎ±Î¸Î±ÏÏŒÏ„Î·Ï„Î±
    const tr = e.target.closest('tr[data-charge-id]');
    const inp = tr?.querySelector('.massAllocAmount');
    if (inp && !e.target.checked) inp.value = '0';
    recomputeMassTotals();
  }
});

function genBatchId(prefix='MP'){
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
  const rand = Math.random().toString(36).slice(2,6).toUpperCase();
  return `${prefix}-${stamp}-${rand}`;
}

massAllocTbody?.addEventListener('change', e => {
  if (!e.target.classList.contains('mass-alloc-check')) return;
  const tr = e.target.closest('tr[data-charge-id]');
  const inp = tr?.querySelector('.massAllocAmount');
  if (!inp) return;

  const max = parseFloat(inp.getAttribute('max') || '0') || 0;

  // (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ) Î²ÏÎµÏ‚ Ï„Î¿ Î¼ÎµÏÎ¯Î´Î¹Î¿ Î­ÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Ï‡ÏÎ­Ï‰ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ Ï€Î»Î¬Î½Î¿
  const plan = computeMassDiscountPlan(massDiscountInput?.value);
  const chargeId = tr?.dataset?.chargeId;
  const share = plan?.[chargeId] || 0;
  const fullAfterDiscount = Math.max(0, round2(max - share));

  if (!e.target.checked) {
    inp.dataset.prev = inp.value || '';
    inp.value = '';
    inp.disabled = true;
    inp.readOnly = false;
  } else {
    inp.disabled = false;
    inp.readOnly = true;                // âœ… Î´ÎµÎ½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÎµÏÎ¹ÎºÎ® Î±Î»Î»Î±Î³Î®
    inp.value = fullAfterDiscount ? fullAfterDiscount.toFixed(2) : max.toFixed(2);
  }
  recomputeMassTotals();
});


massAllocAutoBtn?.addEventListener('click', massAutoFIFO);
massAllocClearBtn?.addEventListener('click', clearMassAllocUI);

// Submit: Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ 1 payment (enrollmentId=null) + allocations
massPayForm.addEventListener('submit', e => {
  e.preventDefault();
  if (!selectedStudentId) { alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼Î±Î¸Î·Ï„Î®.'); return; }

  const payAmt = parseFloat(mp.amount.value || '0') || 0;
  if (!(payAmt > 0)) { alert('Î”ÏÏƒÎµ Î­Î³ÎºÏ…ÏÎ¿ Ï€Î¿ÏƒÏŒ (>0).'); return; }

  // Î¥Ï€Î¿Î»Î¿Î³Î¯Î¶ÎµÎ¹ Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¼ÏŒÎ½Î¿ Î±Ï€ÏŒ ÎµÎ½ÎµÏÎ³Î¬ (Î¼Î·-disabled) inputs
  const activeInputs = [...massAllocTbody.querySelectorAll('.massAllocAmount:not([disabled])')];
  const sumAlloc = activeInputs.reduce((s, inp) => s + (parseFloat(inp.value || '0') || 0), 0);
  
  // âœ… Î´ÎµÎ½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÎµÏÎ¹ÎºÎ®: Î±Ï€Î±Î¹Ï„Î¿ÏÎ¼Îµ sumAlloc == payAmt (Â±0.01)
  if (Math.abs(sumAlloc - payAmt) > 0.01) {
    alert('Î”ÎµÎ½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¼ÎµÏÎ¹ÎºÎ® ÎµÎ¾ÏŒÏ†Î»Î·ÏƒÎ·. Î¤Î¿ Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± ÎºÎ±Ï„Î±Î½Î¿Î¼ÏÎ½ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¹ÏƒÎ¿ÏÏ„Î±Î¹ Î¼Îµ Ï„Î¿ Ï€Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.');
    return;
  }

  if (sumAlloc > payAmt + 0.0001) {
    alert('ÎŸÎ¹ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ Î¾ÎµÏ€ÎµÏÎ½Î¿ÏÎ½ Ï„Î¿ Ï€Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.');
    return;
  }

// derive month index (1..12) Î±Ï€ÏŒ Ï„Î¿ dropdown ÎºÎ±Î¹ Î­Ï„Î¿Ï‚ Î±Ï€ÏŒ Ï„Î·Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± (Î® Ï„ÏÏÎ±)
const mIdx = parseInt(mp.month.value || '0', 10);
const yearNum = mp.date.value ? new Date(mp.date.value).getFullYear() : new Date().getFullYear();
  const rec = {
    id: uid(),
    studentId: selectedStudentId,
    enrollmentId: null, // Î¼Î±Î¶Î¹ÎºÎ®, ÏŒÏ‡Î¹ Î´ÎµÎ¼Î­Î½Î· ÏƒÎµ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î· ÎµÎ³Î³ÏÎ±Ï†Î®
    date: mp.date.value || new Date().toISOString().slice(0,10),
    month: (mIdx >= 1 && mIdx <= 12) ? (MONTHS_GR[mIdx-1] + ' ' + yearNum) : '',
    amount: payAmt,
    method: mp.method.value || '',
    reason: mp.reason.value || '',
    notes: '',
    year: yearFilter.value || null,
    batchId: mp._batchId || genBatchId(),
    discountTotal: parseFloat(massDiscountInput?.value || '0') || 0,

    updated_at: new Date().toISOString()
  };

  // save payment
  const allPays = payDB.all(); allPays.push(rec); payDB.save(allPays);


  // save allocations: Î¼ÏŒÎ½Î¿ checked ÎšÎ‘Î™ ÎµÎ½ÎµÏÎ³Î­Ï‚ (Î¼Î·-disabled) ÏƒÎµÎ¹ÏÎ­Ï‚ Î¼Îµ amount > 0
  const keep = allocDB.all(); // Î´Î¹Î±Ï„Î·ÏÎ¿ÏÎ¼Îµ Ï„Î± Ï€Î±Î»Î¹Î¬
  const newAllocs = [];
  [...massAllocTbody.querySelectorAll('tr[data-charge-id]')].forEach(tr => {
    const chk = tr.querySelector('.mass-alloc-check');
    const inp = tr.querySelector('.massAllocAmount');
    if (!chk || !chk.checked || !inp || inp.disabled) return;

    const val = parseFloat(inp.value || '0') || 0;
    if (val <= 0) return;

    const chargeId = tr.dataset.chargeId;
    if (!chargeId) return;

    newAllocs.push({
      id: uid(),
      paymentId: rec.id,
      chargeId,
      amount: val,
      created_at: new Date().toISOString()
    });
  });
  allocDB.save(keep.concat(newAllocs));

  closeModal(massPayModal);
  // Î±Î½Î±Î½Î­Ï‰ÏƒÎ· Ï€Î¹Î½Î¬ÎºÏ‰Î½/Ï…Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½
  renderPayments();
  renderCharges(); // Î±Î½ Î­Ï‡ÎµÎ¹Ï‚ Î±Î½Î¿Î¹Ï‡Ï„Î® ÎµÎ³Î³ÏÎ±Ï†Î®, Î¸Î± Ï†Î±Î½ÎµÎ¯ Ï„Î¿ updated status
});

document.getElementById('planForm')?.addEventListener('click', (e) => {
  const btn = e.target.closest('.plan-charge-del');
  if (!btn) return;

  const id = btn.getAttribute('data-id');
  const charge = chargeDB.all().find(c => c.id === id);
  if (!charge) return;

  // Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±: Î¼Î·Î½ ÏƒÎ²Î®Î½ÎµÎ¹Ï‚ Î±Î½ Î­Ï‡ÎµÎ¹ allocations
  const paid = allocationSumForCharge(id);
  if (paid > 0.0001) {
    alert('Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Ï‡ÏÎ­Ï‰ÏƒÎ· Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Î®Î´Î· Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚/ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚.');
    return;
  }
  if (charge.locked) {
    alert('Î— Ï‡ÏÎ­Ï‰ÏƒÎ· ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î·. ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰ÏƒÎ­ Ï„Î·Î½ Ï€ÏÏÏ„Î±.');
    return;
  }

  if (!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï„Î·Ï‚ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚;')) return;

  // Hard delete (Î±ÏƒÏ†Î±Î»Î­Ï‚ Î³Î¹Î±Ï„Î¯ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ allocations)
  chargeDB.remove(id);

  // Î‘Î½Î±Î½ÎµÏÏƒÎµÎ¹Ï‚ UI
  renderPlanRealChargesInModal(); // Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ modal
  renderCharges();                // Î±Î½ ÎºÎ¬Ï€Î¿Ï… Î±Î»Î»Î¿Ï ÎµÎ¼Ï€Î¹ÏƒÏ„ÎµÏÎµÏƒÎ±Î¹ Ï„Î± Î¯Î´Î¹Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±
});

/* ======= Init ======= */
function init(){
  yearFilter.value=academicYears()[0];
  cleanupOrphans();           // â† Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—   
  disableEnrollmentForm(true);
  disablePaymentForm(true);
  renderEnrollments();
  renderPayments();
  renderCharges(); // ÎÎ•ÎŸ
}
init();

// === Sidebar Toggle ===
(function(){
  const btn = document.getElementById('menuBtn');
  const side = document.getElementById('sidebar');
  const closeBtn = document.getElementById('sideClose');
  const backdrop = document.getElementById('backdrop');

  function openSide(){
    side.classList.add('open');
    backdrop.classList.add('show');
    side.setAttribute('aria-hidden','false');
  }
  function closeSide(){
    side.classList.remove('open');
    backdrop.classList.remove('show');
    side.setAttribute('aria-hidden','true');
  }
  btn && btn.addEventListener('click', ()=> side.classList.contains('open') ? closeSide() : openSide());
  closeBtn && closeBtn.addEventListener('click', closeSide);
  backdrop && backdrop.addEventListener('click', closeSide);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSide(); });

  // Menu actions
  const goToTab = (tabId)=>{
    const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    if(btn){ btn.click(); }
  };

  document.querySelectorAll('.menu-link').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const tab = a.getAttribute('data-tab');
      const action = a.getAttribute('data-action');
      if(tab) goToTab(tab);
      if(action){
        if(action==='backup'){
          const btn = document.getElementById('backupBtn') || document.querySelector('[data-backup]');
          if(btn) btn.click();
        }else if(action==='restore'){
          const inp = document.getElementById('importFile') || document.querySelector('input[type="file"]#importFile');
          if(inp) inp.click();
        }else if(action==='clear'){
          const btn = document.getElementById('clearBtn') || document.querySelector('[data-clear]');
          if(btn) btn.click();
        }else if(action==='about'){
          alert('Apollon â€” Î¤Î¿Ï€Î¹ÎºÎ® ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚ (LocalStorage).');
        }
      }
      closeSide();
    });
  });
})();

// === Simple Auth (LocalStorage) =============================================
// Keys
const LS_USERS = 'apollon_users';
const LS_SESSION = 'apollon_session';

// Helpers
const readJSON = (k, fallback) => {
  try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch { return fallback; }
};
const writeJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const hashBuf = await crypto.subtle.digest('SHA-256', enc);
  const bytes = Array.from(new Uint8Array(hashBuf));
  return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
}

function getUsers(){ return readJSON(LS_USERS, []); }
function setUsers(arr){ writeJSON(LS_USERS, arr); }
function getSession(){ return readJSON(LS_SESSION, null); }
function setSession(obj){ writeJSON(LS_SESSION, obj); }
function clearSession(){ localStorage.removeItem(LS_SESSION); }

async function ensureDefaultAdmin(){
  let users = getUsers();
  const exists = users.some(u => u.username === 'admin');
  if(!exists){
    users.push({ username:'admin', passHash: await sha256('1234') });
    setUsers(users);
  }
}

// UI elements
const loginScreen = document.getElementById('loginScreen');
const loginForm = document.getElementById('loginForm');
const loginErr = document.getElementById('loginErr');
const resetDefaultBtn = document.getElementById('resetDefaultBtn');
const userNameSpan = document.getElementById('userName');
const logoutBtn = document.getElementById('logoutBtn');

function showLogin(){
  loginScreen.classList.add('show');
  loginScreen.setAttribute('aria-hidden','false');
}
function hideLogin(){
  loginScreen.classList.remove('show');
  loginScreen.setAttribute('aria-hidden','true');
}

async function doLogin(username, password){
  const users = getUsers();
  const user = users.find(u => u.username === username.trim());
  if(!user) return false;
  const passHash = await sha256(password);
  if(user.passHash !== passHash) return false;
  setSession({ user: user.username, ts: Date.now() });
  return true;
}

function doLogout(){
  clearSession();
  userNameSpan.textContent = 'â€”';
  showLogin();
}

function updateHeaderUser(){
  const sess = getSession();
  userNameSpan.textContent = sess?.user ?? 'â€”';
}
/* ====== Receipt printing (ÎœÎ— Ï†Î¿ÏÎ¿Î»Î¿Î³Î¹ÎºÏŒ) ====== */
const KEY_RECEIPT_SEQ = 'apollon_receipt_seq';

function getNextReceiptNo(){
  const y = new Date().getFullYear();
  const obj = JSON.parse(localStorage.getItem(KEY_RECEIPT_SEQ) || '{}');
  const seq = (obj[y] || 0) + 1;
  obj[y] = seq;
  localStorage.setItem(KEY_RECEIPT_SEQ, JSON.stringify(obj));
  // ÎœÎ¿ÏÏ†Î®: YYYY-000123
  return `${y}-${String(seq).padStart(6,'0')}`;
}

function formatMoney(n){
  if (n == null || isNaN(n)) return '0,00â‚¬';
  return new Intl.NumberFormat('el-GR', { style:'currency', currency:'EUR' }).format(Number(n));
}

function safeText(s){ return (s || '').toString().replace(/[<>&]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[m])); }

function buildReceiptHTML({student, payment, allocs, mode='a5'}){
  const S = getSettings() || {};

  const amountGross = Number(payment.amount || 0); // Ï€Î¿ÏƒÏŒ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ ÏŒÏ€Ï‰Ï‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ (ÏƒÏ„Î¹Ï‚ Î¼Î±Î¶Î¹ÎºÎ­Ï‚ = gross)
  const method  = payment.method || payment.payMethod || 'â€”';
  const reason  = payment.reason || payment.payReason || 'Î”Î¯Î´Î±ÎºÏ„ÏÎ±';
  const fullName= [student?.surname, student?.name].filter(Boolean).join(' ');
  const address = [student?.address, student?.city].filter(Boolean).join(', ');

  // Batch tail (Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± 4)
  const batchId = (payment.batchId || payment.payBatchId || '').toString();
  const batchTail = batchId ? batchId.slice(-4) : '';

  // === Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯ ÎºÎ±Ï„Î±Î½Î¿Î¼ÏÎ½ & Î­ÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚ ===
  const allocSum = Array.isArray(allocs) ? allocs.reduce((s,a)=> s + (Number(a.covered ?? a.amount ?? 0) || 0), 0) : 0;
  // Î ÏÎ¿Ï„Î¹Î¼Î¬Î¼Îµ ÏŒ,Ï„Î¹ Î­Ï‡ÎµÎ¹Ï‚ Î®Î´Î· Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÎ¹ ÏƒÏ„Î¿ payment (Î¼Î±Î¶Î¹ÎºÎ® Ï€Î»Î·ÏÏ‰Î¼Î®)
  let discount = Number(payment.discountTotal || 0);
  // Fallback: Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Î²Î³Î¬Î»Îµ Ï„Î· Î´Î¹Î±Ï†Î¿ÏÎ¬ gross - allocations (Î¼Î·Î½ Ï€Î¬ÎµÎ¹ Î±ÏÎ½Î·Ï„Î¹ÎºÏŒ Î±Ï€ÏŒ ÏƒÎµÎ½Ï„Ï‚)
  if (!discount && amountGross > 0 && allocSum >= 0) {
    const d = amountGross - allocSum;
    if (d > 0.004) discount = Math.round(d * 100) / 100;
  }

  const finalTotal = Math.max(0, Math.round((amountGross - discount) * 100)/100);

  // === Î“ÏÎ±Î¼Î¼Î­Ï‚ Ï€Î¯Î½Î±ÎºÎ± ===
  let linesHTML = '';
if (allocs && allocs.length) {
  linesHTML = allocs.map(a => {
    const desc = a.desc || 'Î§ÏÎ­Ï‰ÏƒÎ·';
    const covered = Number(a.covered || 0);
    const school = a.school && a.school !== 'â€”' ? a.school : '';
    return `<tr>
      <td>
        ${safeText(desc)}
        ${school ? ` <span class="badge">${safeText(school)}</span>` : ``}
      </td>
      <td style="text-align:right;">${formatMoney(covered)}</td>
    </tr>`;
  }).join('');
} else {
  // Ï‡Ï‰ÏÎ¯Ï‚ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ­Ï‚ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ (Î´ÎµÎ½ Î¾Î­ÏÎ¿Ï…Î¼Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ± ÏƒÏ‡Î¿Î»Î®) â€” Î±Ï†Î®Î½Î¿Ï…Î¼Îµ Î¼ÏŒÎ½Î¿ Ï„Î·Î½ Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®
  linesHTML = `<tr>
    <td>${safeText(reason)}</td>
    <td style="text-align:right;">${formatMoney(finalTotal || amountGross)}</td>
  </tr>`;
}


  // ÎšÎ»Î¬ÏƒÎ· ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚
  const klass = mode === 'thermal' ? 'receipt thermal' : 'receipt';

  return `
  <div class="${klass}">
    <div class="r-head">
      <div>
        <div><b>${safeText(S.companyName || 'Î©Î´ÎµÎ¯Î¿')}</b></div>
        <div class="muted">${safeText(S.address||'')} ${safeText(S.city||'')}</div>
        <div class="muted">Î¤: ${safeText(S.phone||'')} â€¢ E: ${safeText(S.email||'')}</div>
        <div class="muted">Î‘Î¦Îœ: ${safeText(S.afm||'â€”')} â€¢ Î”ÎŸÎ¥: ${safeText(S.doy||'â€”')}</div>
      </div>
      <div style="text-align:right">
        <h1 class="r-title">Î‘Ï€ÏŒÎ´ÎµÎ¹Î¾Î· Î•Î¯ÏƒÏ€ÏÎ±Î¾Î·Ï‚</h1>
        <div class="r-sub">ÎœÎ— Î¦ÎŸÎ¡ÎŸÎ›ÎŸÎ“Î™ÎšÎŸ Î£Î¤ÎŸÎ™Î§Î•Î™ÎŸ</div>
        <div class="r-sub">Î”ÎµÎ½ Î±Î½Ï„Î¹ÎºÎ±Î¸Î¹ÏƒÏ„Î¬ Î‘Î Î¥ / Î”ÎµÎ½ Ï…Ï€Î¿Î²Î¬Î»Î»ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ MyDATA</div>
        ${batchTail ? `<div class="r-sub">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚: ${safeText(batchTail)}</div>` : ``}
      </div>
    </div>

    <div class="r-grid">
      <div><b>Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®Ï‚:</b> ${safeText(fullName)}</div>
      <div><b>Î¤ÏÏŒÏ€Î¿Ï‚:</b> ${safeText(method)}</div>
      <div><b>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:</b> ${safeText(address || 'â€”')}</div>
      <div><b>Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Ï‡ÏÎ­Ï‰ÏƒÎ·:</b> ${formatMoney(amountGross)}</div>
    </div>

    <table>
      <thead><tr><th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th><th style="text-align:right;">Î Î¿ÏƒÏŒ</th></tr></thead>
      <tbody>${linesHTML}
        ${discount > 0 ? `
          <tr>
            <td class="muted">â†³ ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·</td>
            <td style="text-align:right;">-${formatMoney(discount)}</td>
          </tr>` : ``}
      </tbody>
      <tfoot>
        <tr>
          <td style="text-align:right;">Î¤ÎµÎ»Î¹ÎºÏŒ</td>
          <td style="text-align:right;">${formatMoney(finalTotal || allocSum || amountGross)}</td>
        </tr>
      </tfoot>
    </table>

    <div class="r-foot">
      <div class="muted">${safeText(S.footerNote || 'Î£Î±Ï‚ ÎµÏ…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ Î³Î¹Î± Ï„Î·Î½ ÎµÎ¾ÏŒÏ†Î»Î·ÏƒÎ·.')}</div>
      <div class="muted">ÎˆÎºÎ´Î¿ÏƒÎ· Î¼Î­ÏƒÏ‰ Apollon</div>
    </div>
  </div>`;
}
function printReceiptHTML(html){
  const w = window.open('', '_blank');
  if(!w){ alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Ï„ÏÎ­ÏˆÏ„Îµ pop-ups Î³Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·.'); return; }
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8">
    <title>Î‘Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</title>
    <style>${document.querySelector('style')?.innerHTML || ''}</style>
  </head><body>${html}</body></html>`);
  w.document.close(); w.focus();
  w.onload = () => { try { w.print(); } finally { w.close(); } };
}

// ===== Wire-up: ÎºÎ¿Ï…Î¼Ï€Î¯ "Î‘Ï€ÏŒÎ´ÎµÎ¹Î¾Î·" ÏƒÏ„Î¿ tab Î Î»Î·ÏÏ‰Î¼Î­Ï‚ =====
const payReceiptBtn = document.getElementById('payReceiptBtn');

async function getSelectedPayment(){
  // Î²ÏÎ¯ÏƒÎºÎ¿Ï…Î¼Îµ active Î³ÏÎ±Î¼Î¼Î® ÏƒÏ„Î¿Î½ #payTbl ÎºÎ±Î¹ Ï†Î­ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Î±Ï€ÏŒ payDB
  const row = document.querySelector('#payTbl tbody tr.active');
  if(!row) return null;
  const pid = row.getAttribute('data-id'); // Î²ÎµÎ²Î±Î¹ÏÏƒÎ¿Ï… ÏŒÏ„Î¹ Î²Î¬Î¶ÎµÎ¹Ï‚ data-id ÏƒÏ„Î¹Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚
  if(!pid) return null;
  return payDB.all().find(p => p.id === pid) || null;
}

function getCurrentStudent(){
  const id = document.getElementById('id')?.value; // ÎºÏÏ…Ï†ÏŒ input Ï„Î·Ï‚ Ï†ÏŒÏÎ¼Î±Ï‚ ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®
  if(!id) return null;
  return db.all().find(s => s.id === id) || null;
}

function collectAllocationsForPayment(paymentId){
  // 1) Î Î¬ÏÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚ Ï„Î·Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚
  const allocs = allocDB.all().filter(a => a.paymentId === paymentId);

  // 2) Maps Î³Î¹Î± Î³ÏÎ®Î³Î¿ÏÎ· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ charges & enrollments
  const chargeMap = new Map(chargeDB.all().map(c => [c.id, c]));
  const enrMap    = new Map(enrDB.all().map(e => [e.id, e]));

  // 3) Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® enriched Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Ï‰Î½: desc, covered, due, school
  return allocs.map(a => {
    const c   = chargeMap.get(a.chargeId) || {};
    const enr = c.enrollmentId ? enrMap.get(c.enrollmentId) : null;

    const desc    = c.description || c.desc || c.type || c.month || c.ym || 'Î§ÏÎ­Ï‰ÏƒÎ·';
    const covered = Number(a.amount ?? a.cover ?? 0) || 0;
    const due     = c.due || c.dueDate || '';
    const school  = enr?.school || 'â€”';   // â† Î£Î§ÎŸÎ›Î— Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ³Î³ÏÎ±Ï†Î®

    return { desc, covered, due, school };
  });
}


payReceiptBtn?.addEventListener('click', () => {
  const payment = (function(){ const p = window._lastSelectedPayment || null; return p; })() || null;

  // fallback: Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î½Î± Ï€Î¬ÏÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î³ÏÎ±Î¼Î¼Î®
  const run = async () => {
    let pay = payment || await getSelectedPayment();
    if(!pay){ alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï€ÏÏÏ„Î± Î¼Î¯Î± Ï€Î»Î·ÏÏ‰Î¼Î®.'); return; }
    const student = getCurrentStudent();
    const allocs = collectAllocationsForPayment(pay.id);
    const html = buildReceiptHTML({ student, payment: pay, allocs, mode:'a5' /* Î® 'thermal' */ });
    printReceiptHTML(html);
  };
  run();
});

// Init
(async function authInit(){
  await ensureDefaultAdmin();
  updateHeaderUser();
  if(!getSession()){ showLogin(); }
})();

// Events
loginForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  loginErr.classList.remove('show');
  const fd = new FormData(loginForm);
  const user = fd.get('username');
  const pass = fd.get('password');
  const ok = await doLogin(String(user||''), String(pass||''));
  if(ok){
    hideLogin();
    updateHeaderUser();
  }else{
    loginErr.classList.add('show');
  }
});

function trapFocus(modalEl){
  const focusable = modalEl.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
  const first = focusable[0], last = focusable[focusable.length-1];
  function loop(e){
    if(e.key!=='Tab') return;
    if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
    else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
  }
  modalEl.addEventListener('keydown', loop);
  return ()=> modalEl.removeEventListener('keydown', loop);
}

// wrap Ï„Î± open/close
function openModal(m){
  m.classList.add('open'); m.setAttribute('aria-hidden','false');
  const undoTrap = trapFocus(m); m._undoTrap = undoTrap;
  // focus ÏƒÏ„Î¿ Ï€ÏÏÏ„Î¿ focusable
  setTimeout(()=> m.querySelector('input,button,select,textarea,[tabindex]')?.focus(), 0);
  const onEsc = (e)=>{ if(e.key==='Escape') closeModal(m); };
  m._onEsc = onEsc; document.addEventListener('keydown', onEsc);
}
function closeModal(m){
  m.classList.remove('open'); m.setAttribute('aria-hidden','true');
  m._undoTrap?.(); document.removeEventListener('keydown', m._onEsc);
}

resetDefaultBtn?.addEventListener('click', async ()=>{
  // Î•Ï€Î±Î½Î±Ï†Î­ÏÎµÎ¹/Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ admin/1234 (Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î® Î³Î¹Î± Î´Î¿ÎºÎ¹Î¼Î®)
  let users = getUsers().filter(u => u.username !== 'admin');
  users.push({ username:'admin', passHash: await sha256('1234') });
  setUsers(users);
  alert('ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ admin/1234 ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î¿Ï‚.');
});

logoutBtn?.addEventListener('click', ()=>{
  if(confirm('Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·;')) doLogout();
});

// Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ: logout

</script>
<script>
(function(){
  const SETTINGS_KEY = 'apollon_settings';

  /* ---------- helpers ---------- */
  function money(x){ return (Number(x||0)).toFixed(2) + 'â‚¬'; }
  function asStr(x){ return x == null ? '' : String(x); }

  function getSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'); }
    catch { return {}; }
  }

  // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Ï‡ÏÎ­Ï‰ÏƒÎ·Ï‚ Î±Ï€ÏŒ ÎºÎ±Ï„Î±Î½Î¿Î¼Î­Ï‚/Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚
  function getStatus(charge){
    const allocs = (JSON.parse(localStorage.getItem('apollon_allocations')||'[]')||[])
      .filter(a => String(a.chargeId) === String(charge.id))
      .reduce((s,a)=> s + (Number(a.amount)||0), 0);
    const due = Number(charge.amount)||0;
    if (allocs <= 0) return 'Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ';
    if (allocs < due) return 'ÎœÎµÏÎ¹ÎºÏÏ‚';
    return 'Î•Î¾Î¿Ï†Î»Î·Î¼Î­Î½Î¿';
  }

  // Î’ÏÎµÏ‚ Î¼Îµ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± Ï€Î¿Î¹Î¿Ï‚ ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®Ï‚ ÎµÎ¯Î½Î±Î¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚
  function getSelectedStudentId(){
    try {
      if (typeof selectedStudentId !== 'undefined' && selectedStudentId) {
        return selectedStudentId;
      }
    } catch(e){}
    const hid = document.getElementById('id');
    if (hid && hid.value) return hid.value;
    const activeRow = document.querySelector('#tbl tbody tr.active');
    if (activeRow && activeRow.dataset && activeRow.dataset.id) return activeRow.dataset.id;
    return null;
  }

  /* ---------- HTML Report ---------- */
  function buildReportHTML(studentId, year){
    const sid = asStr(studentId).trim();
    const yr  = year ? asStr(year).trim() : '';

    const students = JSON.parse(localStorage.getItem('apollon_students')||'[]')||[];
    const st = students.find(s => asStr(s.id) === sid);

    const enr = (JSON.parse(localStorage.getItem('apollon_enrollments')||'[]')||[])
      .filter(e => asStr(e.studentId) === sid && (!yr || asStr(e.year) === yr));

    const charges = (JSON.parse(localStorage.getItem('apollon_charges')||'[]')||[])
      .filter(c => asStr(c.studentId) === sid && (!yr || asStr(c.year) === yr))
      .sort((a,b)=>(a.ym||'').localeCompare(b.ym||''));

    const pays = (JSON.parse(localStorage.getItem('apollon_payments')||'[]')||[])
      .filter(p => asStr(p.studentId) === sid && (!yr || asStr(p.year) === yr))
      .sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));

    const S = getSettings();
    const today = new Date().toISOString().slice(0,10);

    const enrollRows = enr.map(e=>`
      <tr>
        <td>${e.year||''}</td>
        <td>${e.school||''}</td>
        <td>${e.className||e.class||''}</td>
        <td>${e.teacher||''}</td>
        <td>${e.enrDate||e.regDate||''}</td>
      </tr>`).join('') || `<tr><td colspan="5" class="muted">â€”</td></tr>`;

    const chargeRows = charges.map(c=>`
      <tr>
        <td>${c.monthLabel||''} ${(c.ym||'').slice(0,4)}</td>
        <td>${c.description||''}</td>
        <td>${c.dateDue||''}</td>
        <td>${money(c.amount)}</td>
        <td>${getStatus(c)}</td>
      </tr>`).join('') || `<tr><td colspan="5" class="muted">â€”</td></tr>`;

    const payRows = pays.map(p=>`
      <tr>
        <td>${p.date||''}</td>
        <td>${p.month||''}</td>
        <td>${money(p.amount)}</td>
        <td>${p.method||''}</td>
        <td>${p.reason||''}</td>
      </tr>`).join('') || `<tr><td colspan="5" class="muted">â€”</td></tr>`;

    const gdprBlock = `
      <div class="grid">
        <div>
          <h2>GDPR</h2>
          <p>ÎŸ/Î— ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®Ï‚/Ï„ÏÎ¹Î± Î´Î·Î»ÏÎ½ÎµÎ¹ ÏŒÏ„Î¹ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ Î³Î¹Î± Ï„Î·Î½ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏÎ½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
          ÎºÎ±Î¹ Ï€Î±ÏÎ­Ï‡ÎµÎ¹ Ï„Î· ÏƒÏ…Î³ÎºÎ±Ï„Î¬Î¸ÎµÏƒÎ® Ï„Î¿Ï…/Ï„Î·Ï‚ ÏŒÏ€Î¿Ï… Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹.</p>
          <p class="muted">[ ] ÎˆÏ‡ÎµÎ¹ Î´Î·Î»Ï‰Î¸ÎµÎ¯ ÏƒÏ…Î³ÎºÎ±Ï„Î¬Î¸ÎµÏƒÎ· â€¢ Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ______ â€¢ Î¤ÏÏŒÏ€Î¿Ï‚: ______</p>
        </div>
        <div>
          <h2>Î¥Ï€Î¿Î³ÏÎ±Ï†Î­Ï‚</h2>
          <p>Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®Ï‚/ÎšÎ·Î´ÎµÎ¼ÏŒÎ½Î±Ï‚: ______________________</p>
          <p>Î•Îº Î¼Î­ÏÎ¿Ï…Ï‚ Ï„Î·Ï‚ ÏƒÏ‡Î¿Î»Î®Ï‚: ______________________</p>
        </div>
      </div>`;

    if(!st){
      return `<div class="report"><h1>Î’ÎµÎ²Î±Î¯Ï‰ÏƒÎ·/Î‘Ï€ÏŒÏƒÏ€Î±ÏƒÎ¼Î±</h1><p>Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®Ï‚ (${sid}).</p></div>`;
    }

    return `
    <div class="report">
      <h1>Î’ÎµÎ²Î±Î¯Ï‰ÏƒÎ·/Î‘Ï€ÏŒÏƒÏ€Î±ÏƒÎ¼Î± ÎœÎ·Ï„ÏÏÎ¿Ï… Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®</h1>

      <div class="grid">
        <div>
          <h2>Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·</h2>
          <p><b>${S.companyName||'â€”'}</b><br>
          Î‘Î¦Îœ: ${S.afm||'â€”'}, Î”ÎŸÎ¥: ${S.doy||'â€”'}<br>
          ${S.address||''} ${S.city||''}<br>
          Î¤: ${S.phone||''} â€¢ E: ${S.email||''}</p>
        </div>
        <div>
          <h2>Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± ÎˆÎºÎ´Î¿ÏƒÎ·Ï‚</h2>
          <p>Î—Î¼/Î½Î¯Î±: ${today}<br>
          Î”Î¹Î´Î±ÎºÏ„Î¹ÎºÏŒ Î­Ï„Î¿Ï‚: ${yr || 'â€”'}<br>
          Î§ÏÎ®ÏƒÏ„Î·Ï‚: ${document.getElementById('userName')?.textContent||'â€”'}</p>
        </div>
      </div>

      <h2>Î£Ï€Î¿Ï…Î´Î±ÏƒÏ„Î®Ï‚</h2>
      <table>
        <tr><td><b>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</b></td><td>${(st.surname||'')+' '+(st.name||'')}</td></tr>
        <tr><td><b>Î—Î¼/Î½Î¯Î± Î³Î­Î½Î½Î·ÏƒÎ·Ï‚</b></td><td>${st.dob||'â€”'}</td></tr>
        <tr><td><b>Î¤ÏŒÏ€Î¿Ï‚ Î³Î­Î½Î½Î·ÏƒÎ·Ï‚</b></td><td>${st.birthPlace||'â€”'}</td></tr>
        <tr><td><b>Î‘ÎœÎšÎ‘</b></td><td>${st.amka||'â€”'}</td></tr>
        <tr><td><b>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</b></td><td>${st.address||'â€”'}, ${st.city||''}</td></tr>
        <tr><td><b>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿ / Email</b></td><td>${st.phone||'â€”'} â€¢ ${st.email||'â€”'}</td></tr>
      </table>

      <h2>Î•Î³Î³ÏÎ±Ï†Î­Ï‚ (${yr||'ÏŒÎ»Î±'})</h2>
      <table>
        <thead><tr><th>ÎˆÏ„Î¿Ï‚</th><th>Î£Ï‡Î¿Î»Î®</th><th>Î¤Î¬Î¾Î·</th><th>Î”Î¹Î´Î¬ÏƒÎºÏ‰Î½</th><th>Î•Î³Î³ÏÎ±Ï†Î®</th></tr></thead>
        <tbody>${enrollRows}</tbody>
      </table>

      <h2>ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ­Ï‚ Î¥Ï€Î¿Ï‡ÏÎµÏÏƒÎµÎ¹Ï‚</h2>
      <table>
        <thead><tr><th>ÎœÎ®Î½Î±Ï‚</th><th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th><th>Î›Î®Î¾Î·</th><th>Î Î¿ÏƒÏŒ</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th></tr></thead>
        <tbody>${chargeRows}</tbody>
      </table>

      <h2>Î Î»Î·ÏÏ‰Î¼Î­Ï‚</h2>
      <table>
        <thead><tr><th>Î—Î¼/Î½Î¯Î±</th><th>ÎœÎ®Î½Î±Ï‚</th><th>Î Î¿ÏƒÏŒ</th><th>Î¤ÏÏŒÏ€Î¿Ï‚</th><th>Î‘Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î±</th></tr></thead>
        <tbody>${payRows}</tbody>
      </table>

      ${gdprBlock}

      <p class="meta">Î Î±ÏÎ¬Ï‡Î¸Î·ÎºÎµ Î±Ï€ÏŒ Ï„Î¿ Apollon (Local Storage app).</p>
    </div>`;
  }

  // ğŸ”‘ Î•ÎÎ‘Î“Î© Î¤Î™Î£ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£ Î£Î¤ÎŸ window (Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î’Î®Î¼Î± 1)
  window.buildReportHTML = buildReportHTML;
  window.getSelectedStudentId = getSelectedStudentId; // Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ

})(); // <-- Î¼ÏŒÎ½Î¿ Î±Ï…Ï„ÏŒ Ï„Î¿ ÎºÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹
</script>
<script>
// 1) Î’Î¬Î»Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ helper ÎšÎ‘Î ÎŸÎ¥ Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Ï„Î¿Î½ handler
function safePrint(html){
  const w = window.open('', '_blank');
  if(!w){ alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Ï„ÏÎ­ÏˆÏ„Îµ pop-ups Î³Î¹Î± Î½Î± ÎµÎ¾Î±Ï‡Î¸ÎµÎ¯ Ï„Î¿ PDF.'); return; }
  w.document.open();
  w.document.write(`<!doctype html>
  <html>
    <head>
      <meta charset="utf-8">
      <title>PDF Report</title>
      <style>
        @page { size: A4; margin: 16mm; }
        body { margin: 0; font: 12pt/1.35 system-ui; color:#111; }
        .report h1 { font-size:18pt; margin:0 0 8pt }
        .report h2 { font-size:13pt; margin:12pt 0 6pt; }
        .report table { width:100%; border-collapse:collapse; margin:6pt 0 }
        .report th, .report td { border-bottom:1px solid #eee; padding:6pt 4pt; font-size:10pt; text-align:left }
        .report .muted { color:#666 }
        .report .grid { display:grid; grid-template-columns:1fr 1fr; gap:8pt }
        .report .meta { font-size:9pt; color:#666; margin-top:6pt }
        .report table { page-break-inside:auto }
        .report tr    { page-break-inside:avoid; page-break-after:auto }
        .report h2    { page-break-after:avoid }
      </style>
    </head>
    <body>${html}</body>
  </html>`);
  w.document.close();
  w.focus();
  w.onload = () => { 
    try { w.print(); } finally { w.close(); }
  };
}

// 2) Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î·ÏƒÎµ ÎŸÎ›ÎŸ Ï„Î¿Î½ Ï€Î±Î»Î¹ÏŒ click handler Î¼Îµ Î±Ï…Ï„ÏŒÎ½:
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='pdfBtn'){
    e.preventDefault();
    e.stopPropagation();

    // Ï€Î¬ÏÎµ Î¼Îµ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± Ï„Î¿ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ id (Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î· Î´Î¹ÎºÎ® ÏƒÎ¿Ï… getSelectedStudentId Î±Î½ Ï„Î·Î½ Î­Ï‡ÎµÎ¹Ï‚)
    const sid = (typeof getSelectedStudentId === 'function'
                  ? String(getSelectedStudentId()||'').trim()
                  : String(window.selectedStudentId||document.getElementById('id')?.value||'').trim());
    if(!sid){ alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏƒÏ€Î¿Ï…Î´Î±ÏƒÏ„Î®.'); return; }

    const year = String(document.getElementById('yearFilter')?.value ?? '').trim();

    // Ï†Ï„Î¹Î¬Î¾Îµ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿
    const html = window.buildReportHTML(sid, year);


    // Ï‡ÏÎ®ÏƒÎ¹Î¼Î¿ log Î³Î¹Î± Î½Î± Î²ÎµÎ²Î±Î¹Ï‰Î¸Î¿ÏÎ¼Îµ ÏŒÏ„Î¹ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÎºÎµÎ½ÏŒ
    try { console.log('PDF preview:', {sid, year, len: html.length}); } catch(e){}

    // Ï„ÏÏ€Ï‰ÏƒÎµ Î±Ï€ÏŒ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„ÏŒ, ÎºÎ±Î¸Î±ÏÏŒ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿
    safePrint(html);
  }
});
</script>


</body>
</html>
